<!-- Page_OrderFile.html : ë°œì£¼íŒŒì¼ ì—…ë¡œë“œ + íŒŒì‹± + ë§¤ì¹­ + DB ì €ì¥ (ê°œì„  ë²„ì „) -->

<style>
  #ob-orderfile-wrap {
    font-size: 13px;
  }
  
  /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
  .ob-orderfile-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .ob-form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .ob-form-label {
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
  }
  
  #ob-customer-select {
    min-width: 200px;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
  }
  
  #ob-orderfile-input {
    font-size: 12px;
  }
  
  .ob-btn {
    padding: 6px 14px;
    font-size: 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  .ob-btn-primary {
    background: #3b82f6;
    color: white;
  }
  
  .ob-btn-primary:hover {
    background: #2563eb;
  }
  
  .ob-btn-success {
    background: #10b981;
    color: white;
  }
  
  .ob-btn-success:hover {
    background: #059669;
  }
  
  .ob-btn-warning {
    background: #f59e0b;
    color: white;
  }
  
  .ob-btn-warning:hover {
    background: #d97706;
  }
  
  .ob-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* ìš”ì•½ ì¹´ë“œ ê·¸ë¦¬ë“œ */
  .ob-summary-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .ob-summary-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 14px 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  
  .ob-summary-card-label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .ob-summary-card-value {
    font-size: 20px;
    font-weight: 700;
    color: #111827;
  }
  
  .ob-summary-card-sub {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
  }
  
  .ob-summary-card.highlight {
    background: #fef3c7;
    border-color: #f59e0b;
  }
  
  .ob-summary-card.success {
    background: #d1fae5;
    border-color: #10b981;
  }
  
  /* í•„í„° ë²„íŠ¼ ì˜ì—­ */
  .ob-filter-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 12px;
  }
  
  /* í…Œì´ë¸” */
  .ob-table-wrapper {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }
  
  #ob-orderfile-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  
  #ob-orderfile-table th,
  #ob-orderfile-table td {
    border: 1px solid #e5e7eb;
    padding: 6px 8px;
  }
  
  #ob-orderfile-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    font-size: 11px;
    text-transform: uppercase;
  }
  
  #ob-orderfile-table td.num {
    text-align: right;
    font-family: 'Courier New', monospace;
  }
  
  #ob-orderfile-table tr.unmatched {
    background: #fee2e2;
  }
  
  #ob-orderfile-table tr.matched {
    background: #dcfce7;
  }
  
  #ob-orderfile-table tr.hidden {
    display: none;
  }
  
  #ob-orderfile-table tbody tr:hover {
    background: #f3f4f6;
  }
  
  /* ìƒíƒœ ì…€ ìŠ¤íƒ€ì¼ */
  .status-cell {
    text-align: center;
    font-size: 14px;
  }
  
  .status-text {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
  }
  
  /* ì¤‘ë³µ ê²½ê³  ëª¨ë‹¬ */
  .ob-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  .ob-modal-overlay.show {
    display: flex;
  }
  
  .ob-modal {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  
  .ob-modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .ob-modal-icon {
    font-size: 32px;
  }
  
  .ob-modal-title {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
  }
  
  .ob-modal-body {
    margin-bottom: 20px;
    color: #4b5563;
    line-height: 1.6;
  }
  
  .ob-modal-list {
    background: #f9fafb;
    border-radius: 6px;
    padding: 12px;
    margin-top: 12px;
    font-size: 12px;
  }
  
  .ob-modal-list-item {
    padding: 4px 0;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .ob-modal-list-item:last-child {
    border-bottom: none;
  }
  
  .ob-modal-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
</style>

<div id="ob-orderfile-wrap">
  <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
  <div class="ob-orderfile-controls">
    <div class="ob-form-group">
      <label class="ob-form-label" for="ob-customer-select">ë°œì£¼ì²˜ ì„ íƒ *</label>
      <select id="ob-customer-select">
        <option value="">-- ë°œì£¼ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
      </select>
    </div>
    
    <div class="ob-form-group">
      <label class="ob-form-label" for="ob-orderfile-input">ë°œì£¼ íŒŒì¼</label>
      <input type="file" id="ob-orderfile-input" accept=".xlsx,.xls,.csv" />
    </div>
    
    <div class="ob-form-group" style="margin-top: 18px;">
      <button type="button" id="ob-btn-parse" class="ob-btn ob-btn-primary">ë°œì£¼íŒŒì¼ íŒŒì‹±</button>
    </div>
    
    <div class="ob-form-group" style="margin-top: 18px;">
      <button type="button" id="ob-btn-save" class="ob-btn ob-btn-success" disabled>ë°œì£¼DB ì €ì¥</button>
    </div>
  </div>

  <!-- ìš”ì•½ ì¹´ë“œ (íŒŒì‹± í›„ í‘œì‹œ) -->
  <div id="ob-summary-cards" class="ob-summary-cards" style="display: none;">
    <div class="ob-summary-card">
      <div class="ob-summary-card-label">ğŸ“¦ ì´ ìƒí’ˆ</div>
      <div class="ob-summary-card-value" id="summary-total">0ê°œ</div>
    </div>
    
    <div class="ob-summary-card" id="summary-match-card">
      <div class="ob-summary-card-label">âœ… ë§¤ì¹­ ìƒíƒœ</div>
      <div class="ob-summary-card-value" id="summary-matched">0ê°œ</div>
      <div class="ob-summary-card-sub" id="summary-unmatched">ë¯¸ë§¤ì¹­ 0ê°œ</div>
    </div>
    
    <div class="ob-summary-card success">
      <div class="ob-summary-card-label">ğŸ’° ì´ ê³µê¸‰ì•¡</div>
      <div class="ob-summary-card-value" id="summary-amount">â‚©0</div>
    </div>
  </div>

  <!-- í•„í„° ì»¨íŠ¸ë¡¤ (íŒŒì‹± í›„ í‘œì‹œ) -->
  <div id="ob-filter-controls" class="ob-filter-controls" style="display: none;">
    <button type="button" id="ob-btn-filter-unmatched" class="ob-btn ob-btn-warning">
      âš ï¸ ë¯¸ë§¤ì¹­ë§Œ ë³´ê¸°
    </button>
    <button type="button" id="ob-btn-filter-all" class="ob-btn" style="display: none;">
      ğŸ“‹ ì „ì²´ ë³´ê¸°
    </button>
  </div>

  <!-- ê²°ê³¼ í…Œì´ë¸” -->
  <div class="ob-table-wrapper">
    <table id="ob-orderfile-table">
      <thead>
        <tr>
          <th>#</th>
          <th>ë¸Œëœë“œ</th>
          <th>ì œí’ˆëª…</th>
          <th>ë°”ì½”ë“œ</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ê³µê¸‰ë‹¨ê°€</th>
          <th>ê¸ˆì•¡</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">
            íŒŒì¼ì„ ì„ íƒí•˜ê³  íŒŒì‹± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ì¤‘ë³µ ë°œì£¼ ê²½ê³  ëª¨ë‹¬ -->
<div id="ob-duplicate-modal" class="ob-modal-overlay">
  <div class="ob-modal">
    <div class="ob-modal-header">
      <div class="ob-modal-icon">âš ï¸</div>
      <div class="ob-modal-title">ì¤‘ë³µ ë°œì£¼ ê²½ê³ </div>
    </div>
    <div class="ob-modal-body">
      <p>ì˜¤ëŠ˜ ì´ë¯¸ ì„ íƒí•œ ë°œì£¼ì²˜ì— ë°œì£¼ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤:</p>
      <div id="duplicate-order-list" class="ob-modal-list"></div>
      <p style="margin-top: 12px;">ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    </div>
    <div class="ob-modal-footer">
      <button type="button" id="ob-btn-duplicate-cancel" class="ob-btn">ì·¨ì†Œ</button>
      <button type="button" id="ob-btn-duplicate-continue" class="ob-btn ob-btn-success">ê³„ì† ì§„í–‰</button>
    </div>
  </div>
</div>

<script>
  window.OB = window.OB || {};
  
  OB.initOrderFilePage = function() {
    var wrap = document.getElementById('ob-orderfile-wrap');
    if (!wrap) {
      console.warn('OrderFile wrapper not found');
      return;
    }

    if (wrap.dataset.bound === '1') {
      console.log('OrderFile already initialized');
      return;
    }
    wrap.dataset.bound = '1';
    
    console.log('âœ… OrderFile Page ì´ˆê¸°í™” ì™„ë£Œ');

    var parsedItems = [];
    var currentFilter = 'all'; // 'all' or 'unmatched'
    
    var customerSelect = document.getElementById('ob-customer-select');
    var fileInput = document.getElementById('ob-orderfile-input');
    var btnParse = document.getElementById('ob-btn-parse');
    var btnSave = document.getElementById('ob-btn-save');
    var tableBody = document.querySelector('#ob-orderfile-table tbody');
    
    var summaryCards = document.getElementById('ob-summary-cards');
    var summaryTotal = document.getElementById('summary-total');
    var summaryMatched = document.getElementById('summary-matched');
    var summaryUnmatched = document.getElementById('summary-unmatched');
    var summaryAmount = document.getElementById('summary-amount');
    var summaryMatchCard = document.getElementById('summary-match-card');
    
    var filterControls = document.getElementById('ob-filter-controls');
    var btnFilterUnmatched = document.getElementById('ob-btn-filter-unmatched');
    var btnFilterAll = document.getElementById('ob-btn-filter-all');
    
    var duplicateModal = document.getElementById('ob-duplicate-modal');
    var duplicateOrderList = document.getElementById('duplicate-order-list');
    var btnDuplicateCancel = document.getElementById('ob-btn-duplicate-cancel');
    var btnDuplicateContinue = document.getElementById('ob-btn-duplicate-continue');

    // ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ
    loadCustomers();

    function loadCustomers() {
      console.log('ğŸ“„ ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ ì¤‘...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ë°œì£¼ì²˜ ì‘ë‹µ:', result);
          
          if (result && result.success && result.data && Array.isArray(result.data)) {
            console.log('ğŸ“‹ ë°œì£¼ì²˜ ê°œìˆ˜:', result.data.length);
            
            result.data.forEach(function(customerName) {
              var option = document.createElement('option');
              option.value = customerName;
              option.textContent = customerName;
              customerSelect.appendChild(option);
            });
            
            console.log('âœ… ë°œì£¼ì²˜ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì™„ë£Œ');
          } else {
            console.warn('âš ï¸ ë°œì£¼ì²˜ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜:', result);
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ë°œì£¼ì²˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getCustomers();
    }

    /**
     * íŒŒì‹± ë²„íŠ¼ í´ë¦­
     */
    if (btnParse) {
      btnParse.addEventListener('click', function() {
        var file = fileInput.files[0];
        var selectedCustomer = customerSelect.value;
        
        if (!selectedCustomer) {
          alert('ë°œì£¼ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!file) {
          alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        console.log('íŒŒì‹± ì‹œì‘:', file.name, 'ë°œì£¼ì²˜:', selectedCustomer);
        OB.showLoading('íŒŒì¼ì„ ì½ëŠ” ì¤‘...');

        var reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            
            var rows = XLSX.utils.sheet_to_json(worksheet, { 
              header: 1,
              defval: '',
              blankrows: false
            });

            console.log('ì—‘ì…€ ì½ê¸° ì™„ë£Œ. í–‰ ìˆ˜:', rows.length);
            
            if (rows.length === 0) {
              OB.hideLoading();
              alert('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            OB.showLoading('ì„œë²„ì—ì„œ ë§¤ì¹­ ì¤‘...');
            
            google.script.run
              .withSuccessHandler(function(result) {
                OB.hideLoading();
                console.log('íŒŒì‹± ê²°ê³¼:', result);
                
                if (result && result.items) {
                  parsedItems = result.items.map(function(item) {
                    item.customer = selectedCustomer;
                    return item;
                  });
                  displayParseResult(result);
                  btnSave.disabled = false;
                } else {
                  alert('íŒŒì‹± ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
              })
              .withFailureHandler(function(error) {
                OB.hideLoading();
                console.error('íŒŒì‹± ì‹¤íŒ¨:', error);
                alert('íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
              })
              .processParsedOrderRows(rows);

          } catch (err) {
            OB.hideLoading();
            console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', err);
            alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
          }
        };

        reader.onerror = function() {
          OB.hideLoading();
          alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
        };

        reader.readAsArrayBuffer(file);
      });
    }

    /**
     * ì €ì¥ ë²„íŠ¼ í´ë¦­ - ì¤‘ë³µ ì²´í¬ í¬í•¨
     */
    if (btnSave) {
      btnSave.addEventListener('click', function() {
        if (!parsedItems || parsedItems.length === 0) {
          alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        var matchedItems = parsedItems.filter(function(item) {
          return item.matchStatus === 'MATCHED';
        });

        if (matchedItems.length === 0) {
          alert('ë§¤ì¹­ëœ í•­ëª©ì´ ì—†ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì¤‘ë³µ ë°œì£¼ ì²´í¬
        checkDuplicateOrder(customerSelect.value, function(hasDuplicate, duplicates) {
          if (hasDuplicate) {
            showDuplicateWarning(duplicates, function(shouldContinue) {
              if (shouldContinue) {
                proceedSave(matchedItems);
              }
            });
          } else {
            proceedSave(matchedItems);
          }
        });
      });
    }

    /**
     * ì¤‘ë³µ ë°œì£¼ ì²´í¬
     */
    function checkDuplicateOrder(customer, callback) {
      var today = new Date();
      var todayStr = today.getFullYear() + '-' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(today.getDate()).padStart(2, '0');
      
      console.log('ğŸ” ì¤‘ë³µ ì²´í¬:', customer, todayStr);
      
      // ì„œë²„ì— ì¤‘ë³µ ì²´í¬ ìš”ì²­
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ì¤‘ë³µ ì²´í¬ ê²°ê³¼:', result);
          if (result && result.success) {
            callback(result.hasDuplicate, result.orders || []);
          } else {
            callback(false, []);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨:', error);
          callback(false, []);
        })
        .checkTodayDuplicateOrder(customer, todayStr);
    }

    /**
     * ì¤‘ë³µ ê²½ê³  ëª¨ë‹¬ í‘œì‹œ
     */
    function showDuplicateWarning(duplicates, callback) {
      duplicateOrderList.innerHTML = '';
      
      duplicates.forEach(function(order) {
        var item = document.createElement('div');
        item.className = 'ob-modal-list-item';
        item.innerHTML = 
          '<strong>' + order.orderCode + '</strong><br>' +
          'ë¸Œëœë“œ: ' + order.brands + ' | ' +
          'ìƒí’ˆìˆ˜: ' + order.itemCount + 'ê°œ | ' +
          'ê¸ˆì•¡: â‚©' + formatNumber(order.totalAmount);
        duplicateOrderList.appendChild(item);
      });
      
      duplicateModal.classList.add('show');
      
      btnDuplicateCancel.onclick = function() {
        duplicateModal.classList.remove('show');
        callback(false);
      };
      
      btnDuplicateContinue.onclick = function() {
        duplicateModal.classList.remove('show');
        callback(true);
      };
    }

    /**
     * ì‹¤ì œ ì €ì¥ ì‹¤í–‰
     */
    function proceedSave(matchedItems) {
      var confirmMsg = 'ë§¤ì¹­ëœ ' + matchedItems.length + 'ê°œ í•­ëª©ì„ ë°œì£¼DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      if (!confirm(confirmMsg)) {
        return;
      }

      console.log('DB ì €ì¥ ì‹œì‘. í•­ëª© ìˆ˜:', matchedItems.length);
      OB.showLoading('ë°œì£¼DBì— ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('ì €ì¥ ê²°ê³¼:', result);
          
          if (!result.success) {
            var errorMsg = 'âŒ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨!\n\n';
            errorMsg += 'ì´ ' + result.totalRows + 'ê°œ ì¤‘ ' + result.errorCount + 'ê±´ì˜ ì˜¤ë¥˜ ë°œê²¬\n\n';
            errorMsg += 'ã€ì˜¤ë¥˜ ë‚´ì—­ã€‘\n';
            errorMsg += result.errors.slice(0, 10).join('\n');
            
            if (result.errors.length > 10) {
              errorMsg += '\n... ì™¸ ' + (result.errors.length - 10) + 'ê±´';
            }
            
            errorMsg += '\n\nâš ï¸ ëª¨ë“  ë°ì´í„° ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            errorMsg += '\n\nì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            
            alert(errorMsg);
            
            console.error('=== ì „ì²´ ì˜¤ë¥˜ ëª©ë¡ ===');
            result.errors.forEach(function(err) {
              console.error(err);
            });
            
            return;
          }
          
          if (result.savedRows !== undefined) {
            alert('âœ… ì €ì¥ ì™„ë£Œ!\n\n' + result.savedRows + 'ê°œ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            parsedItems = [];
            fileInput.value = '';
            customerSelect.value = '';
            btnSave.disabled = true;
            
            // UI ì´ˆê¸°í™”
            summaryCards.style.display = 'none';
            filterControls.style.display = 'none';
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">ì €ì¥ ì™„ë£Œ! ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>';
          } else {
            alert('âš ï¸ ì €ì¥ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('ì €ì¥ ì‹¤íŒ¨:', error);
          alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n' + error.message);
        })
        .saveParsedOrdersToDB(matchedItems);
    }

    /**
     * íŒŒì‹± ê²°ê³¼ í‘œì‹œ
     */
    function displayParseResult(result) {
      // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
      summaryTotal.textContent = result.parsedItems + 'ê°œ';
      summaryMatched.textContent = result.matchedCount + 'ê°œ';
      summaryUnmatched.textContent = 'ë¯¸ë§¤ì¹­ ' + result.unmatchedCount + 'ê°œ';
      summaryAmount.textContent = 'â‚©' + formatNumber(result.totalAmount);
      
      // ë¯¸ë§¤ì¹­ì´ ìˆìœ¼ë©´ ì¹´ë“œ ê°•ì¡°
      if (result.unmatchedCount > 0) {
        summaryMatchCard.classList.add('highlight');
      } else {
        summaryMatchCard.classList.remove('highlight');
      }
      
      summaryCards.style.display = 'grid';
      
      // ë¯¸ë§¤ì¹­ í•­ëª©ì´ ìˆì„ ë•Œë§Œ í•„í„° ë²„íŠ¼ í‘œì‹œ
      if (result.unmatchedCount > 0) {
        filterControls.style.display = 'flex';
      } else {
        filterControls.style.display = 'none';
      }

      // í…Œì´ë¸” ë Œë”ë§
      renderTable(result.items);
    }

    /**
     * í…Œì´ë¸” ë Œë”ë§
     */
    function renderTable(items) {
      tableBody.innerHTML = '';
      
      if (!items || items.length === 0) {
        var emptyRow = tableBody.insertRow();
        var emptyCell = emptyRow.insertCell();
        emptyCell.colSpan = 8;
        emptyCell.style.textAlign = 'center';
        emptyCell.style.padding = '40px';
        emptyCell.style.color = '#9ca3af';
        emptyCell.textContent = 'íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      items.forEach(function(item) {
        var row = tableBody.insertRow();
        
        // ë§¤ì¹­ ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
        if (item.matchStatus === 'MATCHED') {
          row.className = 'matched';
        } else {
          row.className = 'unmatched';
        }
        
        // í•„í„°ì— ë”°ë¼ ìˆ¨ê¹€ ì²˜ë¦¬
        if (currentFilter === 'unmatched' && item.matchStatus === 'MATCHED') {
          row.classList.add('hidden');
        }

        // ë°ì´í„° ì…€ ì¶”ê°€
        row.insertCell().textContent = item.seq || '';
        row.insertCell().textContent = item.brand || '';
        row.insertCell().textContent = item.productName || '';
        row.insertCell().textContent = item.barcode || '';
        
        var qtyCell = row.insertCell();
        qtyCell.className = 'num';
        qtyCell.textContent = formatNumber(item.orderQty);
        
        var priceCell = row.insertCell();
        priceCell.className = 'num';
        priceCell.textContent = formatNumber(item.supplyPrice);
        
        var amountCell = row.insertCell();
        amountCell.className = 'num';
        amountCell.textContent = formatNumber(item.orderAmount);
        
        // ìƒíƒœ ì…€ (ê°œì„ )
        var statusCell = row.insertCell();
        statusCell.className = 'status-cell';
        
        if (item.matchStatus === 'MATCHED') {
          statusCell.innerHTML = '<span class="status-text">âœ… ë§¤ì¹­</span>';
        } else {
          var reason = 'ë°”ì½”ë“œ ì—†ìŒ';
          if (item.barcode) {
            reason = 'í’ˆëª© ë¯¸ë“±ë¡';
          }
          statusCell.innerHTML = '<span class="status-text">âŒ ' + reason + '</span>';
        }
      });
    }

    /**
     * í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
     */
    if (btnFilterUnmatched) {
      btnFilterUnmatched.addEventListener('click', function() {
        currentFilter = 'unmatched';
        applyFilter();
        btnFilterUnmatched.style.display = 'none';
        btnFilterAll.style.display = 'inline-block';
      });
    }
    
    if (btnFilterAll) {
      btnFilterAll.addEventListener('click', function() {
        currentFilter = 'all';
        applyFilter();
        btnFilterAll.style.display = 'none';
        btnFilterUnmatched.style.display = 'inline-block';
      });
    }

    /**
     * í•„í„° ì ìš©
     */
    function applyFilter() {
      var rows = tableBody.querySelectorAll('tr');
      rows.forEach(function(row) {
        if (currentFilter === 'unmatched') {
          if (row.classList.contains('matched')) {
            row.classList.add('hidden');
          } else {
            row.classList.remove('hidden');
          }
        } else {
          row.classList.remove('hidden');
        }
      });
    }

    /**
     * ìˆ«ì í¬ë§·
     */
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return Number(num).toLocaleString('ko-KR');
    }

  }; // end of OB.initOrderFilePage

</script>