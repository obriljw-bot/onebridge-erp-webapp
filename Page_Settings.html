<script>
/* ============================================================
   Page_Settings â€” ê¸°ì´ˆë°ì´í„° ê´€ë¦¬ í™”ë©´ ì´ˆê¸°í™”
   (InvoiceOutput ê´€ë ¨ ì½”ë“œëŠ” ì ˆëŒ€ í¬í•¨ë˜ì§€ ì•ŠìŒ)
   ============================================================ */

window.OB = window.OB || {};

OB.initSettingsPage = function () {
  console.log("ğŸ”§ initSettingsPage ì‹œì‘");

  const wrap = document.getElementById("ob-settings-wrap");
  if (!wrap) {
    console.error("âŒ Settings wrapper ìš”ì†Œ ì—†ìŒ");
    return;
  }

  if (wrap.dataset.bound === "1") {
    console.log("â­ ì´ë¯¸ ì´ˆê¸°í™”ë¨: Settings");
    return;
  }
  wrap.dataset.bound = "1";

  console.log("âœ… Settings Page ì´ˆê¸°í™” ì™„ë£Œ");

  // ğŸ”¹ í–¥í›„ í™•ì¥: ë§¤ì…ì²˜ / í’ˆëª© / ë¸Œëœë“œ / ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ
  // ì´í•˜ ë¶€ë¶„ì€ ë„ˆê°€ ë‚˜ì¤‘ì— CRUD ë§Œë“¤ ë•Œ ì¶”ê°€í•˜ë©´ ë¨.

  loadSupplierList();
  loadBrandList();

  /* -------------------------
        ë§¤ì…ì²˜ ëª©ë¡ ë¡œë“œ
     ------------------------- */
  function loadSupplierList() {
    const supplierTbody = document.getElementById("settings-supplier-tbody");
    if (!supplierTbody) return;

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.success) {
          console.error("âŒ ë§¤ì…ì²˜ ë¡œë“œ ì‹¤íŒ¨:", res ? res.error : "unknown");
          return;
        }

        const { header, rows } = res.data;
        supplierTbody.innerHTML = "";

        rows.forEach(function (row) {
          const code = row[header.indexOf("ê±°ë˜ì²˜ì½”ë“œ")];
          const name = row[header.indexOf("ê±°ë˜ì²˜ëª…")];
          const brand = row[header.indexOf("ë¸Œëœë“œ")];
          const memo = row[header.indexOf("ë¹„ê³ ")];

          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" +
            code +
            "</td>" +
            "<td>" +
            name +
            "</td>" +
            "<td>" +
            (brand || "") +
            "</td>" +
            "<td>" +
            (memo || "") +
            "</td>";

          supplierTbody.appendChild(tr);
        });
      })
      .withFailureHandler(function (err) {
        console.error("âŒ ë§¤ì…ì²˜ ë¡œë“œ ì˜¤ë¥˜:", err);
      })
      .handleApiRequest("getSuppliers", {});
  }

  /* -------------------------
        ë¸Œëœë“œ ëª©ë¡ ë¡œë“œ (ì„ íƒ)
     ------------------------- */
  function loadBrandList() {
    const brandTbody = document.getElementById("settings-brand-tbody");
    if (!brandTbody) return;

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.success) {
          console.error("âŒ ë¸Œëœë“œ ë¡œë“œ ì‹¤íŒ¨:", res ? res.error : "unknown");
          return;
        }

        brandTbody.innerHTML = "";
        const { header, rows } = res.data;

        rows.forEach(function (row) {
          const brand = row[header.indexOf("ë¸Œëœë“œ")];
          const code = row[header.indexOf("ë¸Œëœë“œì½”ë“œ")];

          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" +
            brand +
            "</td>" +
            "<td>" +
            code +
            "</td>";

          brandTbody.appendChild(tr);
        });
      })
      .withFailureHandler(function (err) {
        console.error("âŒ ë¸Œëœë“œ ë¡œë“œ ì˜¤ë¥˜:", err);
      })
      .handleApiRequest("getProductsApi", {});
  }
};
</script>
