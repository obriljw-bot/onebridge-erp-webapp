<style>
.ob-container{padding:20px;}

/* ìƒë‹¨ ì˜µì…˜ë°” */
.ob-topbar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);
  margin-bottom:16px;
  align-items:center;
}
.ob-topbar select,.ob-topbar input{
  padding:6px 8px;
  border:1px solid #d1d5db;
  border-radius:6px;
  font-size:13px;
}

.ob-btn{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  transition: all 0.2s;
}
.primary{background:#2563eb;color:white;}
.primary:hover{background:#1d4ed8;}
.secondary{background:#e5e7eb;}
.secondary:hover{background:#d1d5db;}
.success{background:#10b981;color:white;}
.success:hover{background:#059669;}

/* ì¼ê´„ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ */
.bulk-select-group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  background:#f9fafb;
  padding:8px;
  border-radius:6px;
  border:1px solid #e5e7eb;
}
.bulk-select-btn{
  padding:6px 12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:white;
  cursor:pointer;
  font-size:12px;
  transition: all 0.2s;
}
.bulk-select-btn:hover{
  background:#f3f4f6;
  border-color:#9ca3af;
}

/* í…Œì´ë¸” */
.ob-table-wrap{
  overflow:auto;
  max-height:720px;
  background:white;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);
  margin-bottom:16px;
}
.ob-table-wrap table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
.ob-table-wrap th,
.ob-table-wrap td{
  padding:8px;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}
.ob-table-wrap th{
  background:#f1f5f9;
  font-weight:bold;
  position:sticky;
  top:0;
  z-index:10;
}
.ob-table-wrap td.num{
  text-align:right;
}

/* ì •ë ¬ ê°€ëŠ¥ í—¤ë” */
.ob-table-wrap th.sortable{
  cursor:pointer;
  user-select:none;
}
.ob-table-wrap th.sortable:hover{
  background:#e2e8f0;
}
.ob-table-wrap th.sortable::after{
  content:' â‡…';
  opacity:0.3;
  font-size:11px;
}
.ob-table-wrap th.sortable.asc::after{
  content:' â†‘';
  opacity:1;
}
.ob-table-wrap th.sortable.desc::after{
  content:' â†“';
  opacity:1;
}

/* í˜ì´ì§€ë„¤ì´ì…˜ */
.pagination-container{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:white;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);
}
.pagination-controls{
  display:flex;
  gap:8px;
  align-items:center;
}
.pagination-btn{
  padding:6px 12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:white;
  cursor:pointer;
  font-size:13px;
}
.pagination-btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
}
.pagination-btn:not(:disabled):hover{
  background:#f3f4f6;
}
.pagination-btn.active{
  background:#2563eb;
  color:white;
  border-color:#2563eb;
}
.page-info{
  font-size:13px;
  color:#6b7280;
}
</style>

<div class="ob-container">

  <!-- ìƒë‹¨ ì˜µì…˜ë°” -->
  <div class="ob-topbar">
    <label>ë¬¸ì„œ ìœ í˜•</label>
    <select id="inv-doc-type">
      <option value="ë°œì£¼ì„œ(ë§¤ì…)">ë°œì£¼ì„œ(ë§¤ì…)</option>
      <option value="ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤">ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤</option>
      <option value="ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹">ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹</option>
      <option value="ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´">ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´</option>
      <option value="ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)">ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)</option>
      <option value="ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)">ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)</option>
      <option value="ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)">ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)</option>
    </select>

    <label>ì¶œë ¥ ë°©ì‹</label>
    <select id="inv-default-mode">
      <option value="auto">ìë™(5í–‰ ê¸°ì¤€)</option>
      <option value="full">ì „ì²´ë‚´ì—­</option>
      <option value="short">ë‹¨ì¶•ë‚´ì—­</option>
    </select>

    <label>ë°œì£¼ë²ˆí˜¸</label>
    <input id="inv-order-code" placeholder="OB2025-...">

    <label>ê¸°ê°„</label>
    <input id="inv-start-date" type="date">
    <input id="inv-end-date" type="date">

    <label>ë§¤ì…ì²˜</label>
    <input id="inv-supplier" placeholder="ì—…ì²´ëª…">

    <button id="inv-search-btn" class="ob-btn primary">ì¡°íšŒ</button>
    <button id="inv-export-xlsx" class="ob-btn secondary">Excel ì¶œë ¥</button>
    <button id="inv-export-pdf" class="ob-btn success">PDF ì¶œë ¥</button>

    <div style="display:flex;gap:8px;align-items:center;margin-left:auto;padding:6px 12px;background:#f0f9ff;border-radius:6px;border:1px solid #bfdbfe;">
      <input type="checkbox" id="inv-merge-by-supplier" style="width:16px;height:16px;cursor:pointer;">
      <label for="inv-merge-by-supplier" style="margin:0;font-size:13px;font-weight:500;color:#1e40af;cursor:pointer;">ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥</label>
    </div>
  </div>

  <!-- ì¼ê´„ ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ -->
  <div class="bulk-select-group" id="inv-bulk-select" style="display:none;">
    <span style="font-size:12px;font-weight:bold;color:#6b7280;">ë¹ ë¥¸ ì„ íƒ:</span>
    <button class="bulk-select-btn" id="inv-select-all">ì „ì²´ ì„ íƒ</button>
    <button class="bulk-select-btn" id="inv-deselect-all">ì „ì²´ í•´ì œ</button>
    <span style="border-left:1px solid #d1d5db;height:20px;"></span>
    <span style="font-size:12px;color:#6b7280;">ë¸Œëœë“œë³„:</span>
    <div id="inv-brand-btns"></div>
    <span style="border-left:1px solid #d1d5db;height:20px;"></span>
    <span style="font-size:12px;color:#6b7280;">ë§¤ì…ì²˜ë³„:</span>
    <div id="inv-supplier-btns"></div>
  </div>

  <!-- í…Œì´ë¸” -->
  <div class="ob-table-wrap">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="inv-check-all"></th>
          <th class="sortable" data-sort="orderDate">ë°œì£¼ì¼</th>
          <th class="sortable" data-sort="orderCode">ë°œì£¼ë²ˆí˜¸</th>
          <th class="sortable" data-sort="brand">ë¸Œëœë“œ</th>
          <th class="sortable" data-sort="supplier">ë§¤ì…ì²˜</th>
          <th class="sortable" data-sort="buyer">ë°œì£¼ì²˜</th>
          <th class="sortable num" data-sort="itemCount">í’ˆëª©ìˆ˜</th>
          <th class="sortable num" data-sort="totalPurchaseAmount">ë§¤ì…ì•¡í•©ê³„</th>
          <th class="sortable num" data-sort="totalAmount">ê³µê¸‰ì•¡í•©ê³„</th>
          <th>ì¶œë ¥ë°©ì‹</th>
        </tr>
      </thead>
      <tbody id="inv-result-tbody">
        <tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
  <div class="pagination-container" id="inv-pagination" style="display:none;">
    <div class="page-info" id="inv-page-info">0-0 / 0</div>
    <div class="pagination-controls">
      <button class="pagination-btn" id="inv-page-first">ì²˜ìŒ</button>
      <button class="pagination-btn" id="inv-page-prev">ì´ì „</button>
      <div id="inv-page-numbers" style="display:flex;gap:4px;"></div>
      <button class="pagination-btn" id="inv-page-next">ë‹¤ìŒ</button>
      <button class="pagination-btn" id="inv-page-last">ë§ˆì§€ë§‰</button>
    </div>
  </div>

</div>

<script>
(function() {
  console.log('ğŸ”§ InvoiceOutput í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ');

  // ========================================
  // ì „ì—­ ë³€ìˆ˜
  // ========================================
  var allOrders = [];           // ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì „ì²´ ë°œì£¼ ëª©ë¡
  var filteredOrders = [];      // í•„í„°ë§/ì •ë ¬ëœ ë°œì£¼ ëª©ë¡
  var currentPage = 1;          // í˜„ì¬ í˜ì´ì§€
  var itemsPerPage = 20;        // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
  var currentSort = {           // í˜„ì¬ ì •ë ¬ ìƒíƒœ
    column: 'orderDate',
    direction: 'desc'
  };
  var modesByOrder = {};        // ë°œì£¼ë³„ ì¶œë ¥ë°©ì‹ ì €ì¥

  // ========================================
  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  // ========================================
  function formatDate(dateVal) {
    if (!dateVal) return '';
    var d = new Date(dateVal);
    if (isNaN(d.getTime())) return '';
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
  }

  function formatDateInput(d) {
    if (!d) return '';
    if (!(d instanceof Date)) d = new Date(d);
    if (isNaN(d.getTime())) return '';
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return year + month + day;
  }

  function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  }

  function renderEmpty() {
    var tbody = document.getElementById("inv-result-tbody");
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    document.getElementById('inv-pagination').style.display = 'none';
    document.getElementById('inv-bulk-select').style.display = 'none';
  }

  // ========================================
  // 1. Excel ë‹¤ìš´ë¡œë“œ
  // ========================================
  function downloadExcel() {
    if (!filteredOrders || filteredOrders.length === 0) {
      alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    var csv = [];

    // í—¤ë”
    csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

    // ë°ì´í„°
    filteredOrders.forEach(function(order) {
      var row = [
        formatDate(order.orderDate),
        order.orderCode || '',
        order.buyer || '',
        order.brand || '',
        order.supplier || '',
        order.itemCount || 0,
        order.totalPurchaseAmount || 0,
        order.totalAmount || 0
      ];
      csv.push(row.join(','));
    });

    // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
    var csvContent = '\uFEFF' + csv.join('\n');
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', 'ë°œì£¼ì¶œë ¥ëª©ë¡_' + formatDateInput(new Date()) + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log('âœ… Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + filteredOrders.length + 'ê±´');
  }

  // ========================================
  // 2. ì •ë ¬ ê¸°ëŠ¥
  // ========================================
  function sortOrders(column, direction) {
    filteredOrders.sort(function(a, b) {
      var aVal = a[column];
      var bVal = b[column];

      // ë‚ ì§œ ì²˜ë¦¬
      if (column === 'orderDate') {
        aVal = new Date(aVal).getTime();
        bVal = new Date(bVal).getTime();
      }

      // ìˆ«ì ì²˜ë¦¬
      if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
        aVal = Number(aVal) || 0;
        bVal = Number(bVal) || 0;
      }

      // ë¬¸ìì—´ ì²˜ë¦¬
      if (typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }

      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    });
  }

  function updateSortIndicators() {
    var headers = document.querySelectorAll('.ob-table-wrap th.sortable');
    headers.forEach(function(header) {
      header.classList.remove('asc', 'desc');
      if (header.dataset.sort === currentSort.column) {
        header.classList.add(currentSort.direction);
      }
    });
  }

  // ========================================
  // 3. í˜ì´ì§€ë„¤ì´ì…˜
  // ========================================
  function renderPagination(totalPages) {
    var paginationContainer = document.getElementById('inv-pagination');
    var pageInfo = document.getElementById('inv-page-info');
    var pageNumbers = document.getElementById('inv-page-numbers');
    var btnFirst = document.getElementById('inv-page-first');
    var btnPrev = document.getElementById('inv-page-prev');
    var btnNext = document.getElementById('inv-page-next');
    var btnLast = document.getElementById('inv-page-last');

    if (totalPages <= 1) {
      paginationContainer.style.display = 'none';
      return;
    }

    paginationContainer.style.display = 'flex';

    // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    btnFirst.disabled = currentPage === 1;
    btnPrev.disabled = currentPage === 1;
    btnNext.disabled = currentPage === totalPages;
    btnLast.disabled = currentPage === totalPages;

    // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
    pageNumbers.innerHTML = '';

    var maxButtons = 5;
    var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    var endPage = Math.min(totalPages, startPage + maxButtons - 1);

    if (endPage - startPage < maxButtons - 1) {
      startPage = Math.max(1, endPage - maxButtons + 1);
    }

    for (var i = startPage; i <= endPage; i++) {
      var btn = document.createElement('button');
      btn.className = 'pagination-btn';
      btn.textContent = i;
      btn.dataset.page = i;

      if (i === currentPage) {
        btn.classList.add('active');
      }

      btn.addEventListener('click', function() {
        currentPage = parseInt(this.dataset.page);
        renderOrders();
      });

      pageNumbers.appendChild(btn);
    }

    // í˜ì´ì§€ ì •ë³´
    var startIdx = (currentPage - 1) * itemsPerPage + 1;
    var endIdx = Math.min(currentPage * itemsPerPage, filteredOrders.length);
    pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + filteredOrders.length;

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    btnFirst.onclick = function() { currentPage = 1; renderOrders(); };
    btnPrev.onclick = function() { if (currentPage > 1) { currentPage--; renderOrders(); } };
    btnNext.onclick = function() { if (currentPage < totalPages) { currentPage++; renderOrders(); } };
    btnLast.onclick = function() { currentPage = totalPages; renderOrders(); };
  }

  // ========================================
  // 4. ë¸Œëœë“œ/ë§¤ì…ì²˜ë³„ ì¼ê´„ ì„ íƒ
  // ========================================
  function renderBulkSelectButtons() {
    var bulkSelectContainer = document.getElementById('inv-bulk-select');
    var brandBtnsContainer = document.getElementById('inv-brand-btns');
    var supplierBtnsContainer = document.getElementById('inv-supplier-btns');

    if (filteredOrders.length === 0) {
      bulkSelectContainer.style.display = 'none';
      return;
    }

    bulkSelectContainer.style.display = 'flex';

    // ë¸Œëœë“œ ëª©ë¡ ì¶”ì¶œ
    var brands = {};
    var suppliers = {};
    filteredOrders.forEach(function(order) {
      if (order.brand) brands[order.brand] = true;
      if (order.supplier) suppliers[order.supplier] = true;
    });

    var brandList = Object.keys(brands).sort();
    var supplierList = Object.keys(suppliers).sort();

    // ë¸Œëœë“œ ë²„íŠ¼ ìƒì„±
    brandBtnsContainer.innerHTML = '';
    brandList.forEach(function(brand) {
      var btn = document.createElement('button');
      btn.className = 'bulk-select-btn';
      btn.textContent = brand;
      btn.addEventListener('click', function() {
        selectByBrand(brand);
      });
      brandBtnsContainer.appendChild(btn);
    });

    // ë§¤ì…ì²˜ ë²„íŠ¼ ìƒì„±
    supplierBtnsContainer.innerHTML = '';
    supplierList.forEach(function(supplier) {
      var btn = document.createElement('button');
      btn.className = 'bulk-select-btn';
      btn.textContent = supplier;
      btn.addEventListener('click', function() {
        selectBySupplier(supplier);
      });
      supplierBtnsContainer.appendChild(btn);
    });
  }

  function selectByBrand(brand) {
    var checkboxes = document.querySelectorAll('.inv-row-check');
    var startIdx = (currentPage - 1) * itemsPerPage;
    var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);

    for (var i = startIdx; i < endIdx; i++) {
      var order = filteredOrders[i];
      if (order.brand === brand) {
        var checkbox = checkboxes[i - startIdx];
        if (checkbox) checkbox.checked = true;
      }
    }
  }

  function selectBySupplier(supplier) {
    var checkboxes = document.querySelectorAll('.inv-row-check');
    var startIdx = (currentPage - 1) * itemsPerPage;
    var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);

    for (var i = startIdx; i < endIdx; i++) {
      var order = filteredOrders[i];
      if (order.supplier === supplier) {
        var checkbox = checkboxes[i - startIdx];
        if (checkbox) checkbox.checked = true;
      }
    }
  }

  // ========================================
  // í…Œì´ë¸” ë Œë”ë§
  // ========================================
  function renderOrders() {
    var tbody = document.getElementById('inv-result-tbody');

    if (!filteredOrders || filteredOrders.length === 0) {
      renderEmpty();
      return;
    }

    // ì •ë ¬
    sortOrders(currentSort.column, currentSort.direction);
    updateSortIndicators();

    // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
    var totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
    var startIdx = (currentPage - 1) * itemsPerPage;
    var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);
    var pageOrders = filteredOrders.slice(startIdx, endIdx);

    // í…Œì´ë¸” ë Œë”ë§
    tbody.innerHTML = '';
    pageOrders.forEach(function(o) {
      var mode = modesByOrder[o.orderCode] || document.getElementById('inv-default-mode').value || 'auto';
      var dateStr = formatDate(o.orderDate);

      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td><input type="checkbox" class="inv-row-check" data-oc="' + o.orderCode + '"></td>' +
        '<td>' + dateStr + '</td>' +
        '<td>' + (o.orderCode || '') + '</td>' +
        '<td>' + (o.brand || '') + '</td>' +
        '<td>' + (o.supplier || '') + '</td>' +
        '<td>' + (o.buyer || '') + '</td>' +
        '<td class="num">' + (o.itemCount || 0) + '</td>' +
        '<td class="num">' + formatNumber(o.totalPurchaseAmount) + '</td>' +
        '<td class="num">' + formatNumber(o.totalAmount) + '</td>' +
        '<td>' +
          '<select class="inv-mode" data-oc="' + o.orderCode + '">' +
            '<option value="auto"' + (mode === 'auto' ? ' selected' : '') + '>ìë™</option>' +
            '<option value="full"' + (mode === 'full' ? ' selected' : '') + '>ì „ì²´</option>' +
            '<option value="short"' + (mode === 'short' ? ' selected' : '') + '>ë‹¨ì¶•</option>' +
          '</select>' +
        '</td>';

      tbody.appendChild(tr);
    });

    // ì¶œë ¥ë°©ì‹ ë³€ê²½ ì´ë²¤íŠ¸
    document.querySelectorAll('.inv-mode').forEach(function(sel) {
      sel.addEventListener('change', function() {
        modesByOrder[this.dataset.oc] = this.value;
      });
    });

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    renderPagination(totalPages);

    // ì¼ê´„ ì„ íƒ ë²„íŠ¼ ë Œë”ë§
    renderBulkSelectButtons();

    console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ: ' + pageOrders.length + '/' + filteredOrders.length + 'ê±´');
  }

  // ========================================
  // ì¡°íšŒ ê¸°ëŠ¥
  // ========================================
  function searchOrders() {
    console.log('ğŸ” ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨');

    var params = {
      orderCode: document.getElementById("inv-order-code").value,
      supplier: document.getElementById("inv-supplier").value,
      startDate: document.getElementById("inv-start-date").value,
      endDate: document.getElementById("inv-end-date").value
    };

    console.log('ğŸ“‹ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

    OB.showLoading('ë°œì£¼ ëª©ë¡ ì¡°íšŒ ì¤‘...');

    google.script.run
      .withSuccessHandler(function(res) {
        console.log('âœ… ì„œë²„ ì‘ë‹µ:', res);

        OB.hideLoading();

        if (!res) {
          alert("ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
          renderEmpty();
          return;
        }

        if (!res.success) {
          alert("ì˜¤ë¥˜ ë°œìƒ: " + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          renderEmpty();
          return;
        }

        if (!res.orders || res.orders.length === 0) {
          renderEmpty();
          return;
        }

        // ë°ì´í„° ì €ì¥
        allOrders = res.orders;
        filteredOrders = res.orders.slice();
        currentPage = 1;

        // ë Œë”ë§
        renderOrders();

        console.log('âœ… ì¡°íšŒ ì™„ë£Œ: ' + res.orders.length + 'ê±´');
      })
      .withFailureHandler(function(err) {
        console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err);
        OB.hideLoading();
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + (err.message || err));
        renderEmpty();
      })
      .getPrintableOrdersApi(params);
  }

  // ========================================
  // PDF ì¶œë ¥ ê¸°ëŠ¥
  // ========================================
  function exportPDF() {
    console.log('ğŸ“„ PDF ì¶œë ¥ ë²„íŠ¼ í´ë¦­');

    // ì²´í¬ëœ ë°œì£¼ë²ˆí˜¸ ìˆ˜ì§‘
    var selected = [];
    document.querySelectorAll(".inv-row-check:checked").forEach(function(c) {
      selected.push(c.dataset.oc);
    });

    if (selected.length === 0) {
      alert("ì¶œë ¥í•  ë°œì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
    var docTypeName = document.getElementById("inv-doc-type").value;
    var docTypeMap = {
      "ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)": "INVOICE_VAT",
      "ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)": "INVOICE_NVAT",
      "ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)": "INVOICE_EN",
      "ë°œì£¼ì„œ(ë§¤ì…)": "ORDER_BASIC",
      "ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤": "ORDER_ROMAND",
      "ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹": "ORDER_JONGGEUN",
      "ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´": "ORDER_BBIA"
    };
    var docType = docTypeMap[docTypeName] || "INVOICE_VAT";

    // ì¶œë ¥ë°©ì‹ ìˆ˜ì§‘
    var modes = {};
    document.querySelectorAll(".inv-mode").forEach(function(sel) {
      modes[sel.dataset.oc] = sel.value || "auto";
    });

    // ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ì²´í¬ ì—¬ë¶€
    var mergeBySupplier = document.getElementById("inv-merge-by-supplier").checked;

    var params = {
      orderCodes: selected,
      docType: docType,
      printMode: "auto",
      modesByOrder: modes,
      mergeBySupplier: mergeBySupplier
    };

    console.log('ğŸ“„ PDF ìƒì„± íŒŒë¼ë¯¸í„°:', params);
    if (mergeBySupplier) {
      console.log('ğŸ”— ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ëª¨ë“œ í™œì„±í™”');
    }

    OB.showLoading('PDF ìƒì„± ì¤‘... (' + selected.length + 'ê±´)');

    google.script.run
      .withSuccessHandler(function(res) {
        OB.hideLoading();

        if (!res || !res.success) {
          alert(res ? res.error : "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        // ZIP ë‹¤ìš´ë¡œë“œ URL ì˜¤í”ˆ
        var url = "https://drive.google.com/uc?export=download&id=" + res.fileId;
        window.open(url, "_blank");

        alert('âœ… PDF ìƒì„± ì™„ë£Œ!\níŒŒì¼: ' + res.fileName);
      })
      .withFailureHandler(function(err) {
        OB.hideLoading();
        console.error('âŒ PDF ìƒì„± ì‹¤íŒ¨:', err);
        alert("PDF ìƒì„± ì‹¤íŒ¨: " + (err.message || err));
      })
      .generateInvoiceZipApi(params);
  }

  // ========================================
  // ì´ˆê¸°í™”
  // ========================================
  window.addEventListener('load', function() {
    console.log('ğŸ”§ InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    // ì¡°íšŒ ë²„íŠ¼
    var searchBtn = document.getElementById('inv-search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', searchOrders);
    }

    // Excel ì¶œë ¥ ë²„íŠ¼
    var excelBtn = document.getElementById('inv-export-xlsx');
    if (excelBtn) {
      excelBtn.addEventListener('click', downloadExcel);
    }

    // PDF ì¶œë ¥ ë²„íŠ¼
    var pdfBtn = document.getElementById('inv-export-pdf');
    if (pdfBtn) {
      pdfBtn.addEventListener('click', exportPDF);
    }

    // ì „ì²´ ì²´í¬ë°•ìŠ¤
    var checkAll = document.getElementById("inv-check-all");
    if (checkAll) {
      checkAll.addEventListener("change", function(e) {
        var checkboxes = document.querySelectorAll(".inv-row-check");
        checkboxes.forEach(function(c) {
          c.checked = e.target.checked;
        });
      });
    }

    // ì •ë ¬ í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    var sortableHeaders = document.querySelectorAll('.ob-table-wrap th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        currentPage = 1;
        renderOrders();
      });
    });

    // ì¼ê´„ ì„ íƒ ë²„íŠ¼
    var selectAllBtn = document.getElementById('inv-select-all');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = true;
        });
      });
    }

    var deselectAllBtn = document.getElementById('inv-deselect-all');
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = false;
        });
        document.getElementById('inv-check-all').checked = false;
      });
    }

    console.log('âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  });

})();
</script>
