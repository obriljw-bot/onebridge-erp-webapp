<script>
  // ===== ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ =====
  window.OB = window.OB || {};
  
  // ===== í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì´ˆê¸° ì„¤ì • =====
  (function() {
    var urlParams = new URLSearchParams(window.location.search);
    var pageFromUrl = urlParams.get('page') || 'orderFile';
    
    OB.state = {
      currentPage: pageFromUrl,
      isLoading: false,
      initializedPages: {}
    };
  })();

  // ===== ê³µí†µ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ =====
  OB.initCurrentPage = function(page) {
    console.log('ğŸ”§ initCurrentPage í˜¸ì¶œ:', page);
    
    if (OB.state.initializedPages[page]) {
      console.log('â­ï¸  ì´ë¯¸ ì´ˆê¸°í™”ë¨:', page);
      return;
    }

    var initFuncName = null;

    switch(page) {
      case 'orderFile':
        initFuncName = 'initOrderFilePage';
        break;
      case 'dashboard':
        initFuncName = 'initDashboardPage';
        break;
      case 'orderList':
        initFuncName = 'initOrderListPage';
        break;
      case 'invoiceOutput':
        initFuncName = 'initInvoiceOutputPage';
        break;
      case 'purchaseSettlement':
        initFuncName = 'initPurchaseSettlementPage';
        break;
      case 'salesSettlement':
        initFuncName = 'initSalesSettlementPage';
        break;
      case 'monthlyClosing':
        initFuncName = 'initMonthlyClosingPage';
        break;
      case 'settings':
        initFuncName = 'initSettingsPage';
        break;
    }

    if (initFuncName && typeof OB[initFuncName] === 'function') {
      console.log('âœ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰:', initFuncName);
      
      try {
        OB[initFuncName]();
        OB.state.initializedPages[page] = true;
        console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ:', page);
      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', page, err);
      }
    } else {
      console.warn('âš ï¸  ì´ˆê¸°í™” í•¨ìˆ˜ ì—†ìŒ:', page, initFuncName);
    }
  };

  // ===== ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  OB.showLoading = function (message) {
    var overlay = document.getElementById('ob-loading-overlay');
    var textEl = document.getElementById('ob-loading-text');
    if (!overlay || !textEl) return;
    textEl.textContent = message || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.';
    overlay.classList.add('show');
    OB.state.isLoading = true;
  };

  OB.hideLoading = function () {
    var overlay = document.getElementById('ob-loading-overlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    OB.state.isLoading = false;
  };

  // ===== API ë˜í¼ =====
  OB.api = {
    ping: function () {
      OB.showLoading('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘.');
      google.script.run
        .withSuccessHandler(function (res) {
          OB.hideLoading();
          console.log('ping result:', res);
          alert('ì„œë²„ ì—°ê²° ì™„ë£Œ: ' + (res && res.status));
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error(err);
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        })
        .ping();
    },

    loadPage: function (page) {
      OB.showLoading('í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘:', page);

      google.script.run
        .withSuccessHandler(function (html) {
          OB.hideLoading();

          var container = document.getElementById('app-main');
          if (!container) {
            console.error('âŒ app-main ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }

          container.innerHTML = html;

          // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
          OB.state.currentPage = page;
          
          // ìƒˆë¡œ ë¡œë“œí•œ í˜ì´ì§€ëŠ” ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
          OB.state.initializedPages[page] = false;

          // ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
          OB.highlightActiveNav(page);

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
          setTimeout(function() {
            OB.initCurrentPage(page);
          }, 50);
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        })
        .getPageContent(page);
    }
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì•¡í‹°ë¸Œ í‘œì‹œ =====
  OB.highlightActiveNav = function(page) {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      var navPage = link.getAttribute('data-nav-page');
      if (navPage === page) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • =====
  function setupNavLinks() {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var page = link.getAttribute('data-nav-page');
        if (page) OB.api.loadPage(page);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded - ì´ˆê¸° í˜ì´ì§€:', OB.state.currentPage);

    setupNavLinks();
    OB.highlightActiveNav(OB.state.currentPage);
    OB.initCurrentPage(OB.state.currentPage);
  });

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  OB.formatNumber = function(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  };

  OB.formatDate = function(date) {
    if (!date) return '';
    if (typeof date === 'string') return date;
    
    var d = new Date(date);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    
    return year + '-' + month + '-' + day;
  };

  // ===========================================================
  // âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.invoiceOutputState = {
    allOrders: [],
    filteredOrders: [],
    currentPage: 1,
    itemsPerPage: 20,
    currentSort: {
      column: 'orderDate',
      direction: 'desc'
    },
    modesByOrder: {}
  };

  OB.initInvoiceOutputPage = function() {
    console.log('ğŸ”§ InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.invoiceOutputState;

    // ========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ========================================
    function formatDateInput(d) {
      if (!d) return '';
      if (!(d instanceof Date)) d = new Date(d);
      if (isNaN(d.getTime())) return '';
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return year + month + day;
    }

    function renderEmpty() {
      var tbody = document.getElementById("inv-result-tbody");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
      document.getElementById('inv-pagination').style.display = 'none';
      document.getElementById('inv-bulk-select').style.display = 'none';
    }

    // ========================================
    // 1. Excel ë‹¤ìš´ë¡œë“œ
    // ========================================
    function downloadExcel() {
      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      state.filteredOrders.forEach(function(order) {
        var row = [
          OB.formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ì¶œë ¥ëª©ë¡_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // 2. ì •ë ¬ ê¸°ëŠ¥
    // ========================================
    function sortOrders(column, direction) {
      state.filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      var headers = document.querySelectorAll('.ob-table-wrap th.sortable');
      headers.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === state.currentSort.column) {
          header.classList.add(state.currentSort.direction);
        }
      });
    }

    // ========================================
    // 3. í˜ì´ì§€ë„¤ì´ì…˜
    // ========================================
    function renderPagination(totalPages) {
      var paginationContainer = document.getElementById('inv-pagination');
      var pageInfo = document.getElementById('inv-page-info');
      var pageNumbers = document.getElementById('inv-page-numbers');
      var btnFirst = document.getElementById('inv-page-first');
      var btnPrev = document.getElementById('inv-page-prev');
      var btnNext = document.getElementById('inv-page-next');
      var btnLast = document.getElementById('inv-page-last');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = state.currentPage === 1;
      btnPrev.disabled = state.currentPage === 1;
      btnNext.disabled = state.currentPage === totalPages;
      btnLast.disabled = state.currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, state.currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === state.currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          state.currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (state.currentPage - 1) * state.itemsPerPage + 1;
      var endIdx = Math.min(state.currentPage * state.itemsPerPage, state.filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + state.filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { state.currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (state.currentPage > 1) { state.currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (state.currentPage < totalPages) { state.currentPage++; renderOrders(); } };
      btnLast.onclick = function() { state.currentPage = totalPages; renderOrders(); };
    }

    // ========================================
    // 4. ë¸Œëœë“œ/ë§¤ì…ì²˜ë³„ ì¼ê´„ ì„ íƒ
    // ========================================
    function renderBulkSelectButtons() {
      var bulkSelectContainer = document.getElementById('inv-bulk-select');
      var brandBtnsContainer = document.getElementById('inv-brand-btns');
      var supplierBtnsContainer = document.getElementById('inv-supplier-btns');

      if (state.filteredOrders.length === 0) {
        bulkSelectContainer.style.display = 'none';
        return;
      }

      bulkSelectContainer.style.display = 'flex';

      // ë¸Œëœë“œ ëª©ë¡ ì¶”ì¶œ
      var brands = {};
      var suppliers = {};
      state.filteredOrders.forEach(function(order) {
        if (order.brand) brands[order.brand] = true;
        if (order.supplier) suppliers[order.supplier] = true;
      });

      var brandList = Object.keys(brands).sort();
      var supplierList = Object.keys(suppliers).sort();

      // ë¸Œëœë“œ ë²„íŠ¼ ìƒì„±
      brandBtnsContainer.innerHTML = '';
      brandList.forEach(function(brand) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = brand;
        btn.addEventListener('click', function() {
          selectByBrand(brand);
        });
        brandBtnsContainer.appendChild(btn);
      });

      // ë§¤ì…ì²˜ ë²„íŠ¼ ìƒì„±
      supplierBtnsContainer.innerHTML = '';
      supplierList.forEach(function(supplier) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = supplier;
        btn.addEventListener('click', function() {
          selectBySupplier(supplier);
        });
        supplierBtnsContainer.appendChild(btn);
      });
    }

    function selectByBrand(brand) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.brand === brand) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    function selectBySupplier(supplier) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.supplier === supplier) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    // ========================================
    // í…Œì´ë¸” ë Œë”ë§
    // ========================================
    function renderOrders() {
      var tbody = document.getElementById('inv-result-tbody');

      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        renderEmpty();
        return;
      }

      // ì •ë ¬
      sortOrders(state.currentSort.column, state.currentSort.direction);
      updateSortIndicators();

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(state.filteredOrders.length / state.itemsPerPage);
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);
      var pageOrders = state.filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = '';
      pageOrders.forEach(function(o) {
        var mode = state.modesByOrder[o.orderCode] || document.getElementById('inv-default-mode').value || 'auto';
        var dateStr = OB.formatDate(o.orderDate);

        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td><input type="checkbox" class="inv-row-check" data-oc="' + o.orderCode + '"></td>' +
          '<td>' + dateStr + '</td>' +
          '<td>' + (o.orderCode || '') + '</td>' +
          '<td>' + (o.brand || '') + '</td>' +
          '<td>' + (o.supplier || '') + '</td>' +
          '<td>' + (o.buyer || '') + '</td>' +
          '<td class="num">' + (o.itemCount || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalPurchaseAmount) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalAmount) + '</td>' +
          '<td>' +
            '<select class="inv-mode" data-oc="' + o.orderCode + '">' +
              '<option value="auto"' + (mode === 'auto' ? ' selected' : '') + '>ìë™</option>' +
              '<option value="full"' + (mode === 'full' ? ' selected' : '') + '>ì „ì²´</option>' +
              '<option value="short"' + (mode === 'short' ? ' selected' : '') + '>ë‹¨ì¶•</option>' +
            '</select>' +
          '</td>';

        tbody.appendChild(tr);
      });

      // ì¶œë ¥ë°©ì‹ ë³€ê²½ ì´ë²¤íŠ¸
      document.querySelectorAll('.inv-mode').forEach(function(sel) {
        sel.addEventListener('change', function() {
          state.modesByOrder[this.dataset.oc] = this.value;
        });
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPagination(totalPages);

      // ì¼ê´„ ì„ íƒ ë²„íŠ¼ ë Œë”ë§
      renderBulkSelectButtons();

      console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ: ' + pageOrders.length + '/' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // ì¡°íšŒ ê¸°ëŠ¥
    // ========================================
    function searchOrders() {
      console.log('ğŸ” ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨');

      var params = {
        orderCode: document.getElementById("inv-order-code").value,
        supplier: document.getElementById("inv-supplier").value,
        startDate: document.getElementById("inv-start-date").value,
        endDate: document.getElementById("inv-end-date").value
      };

      console.log('ğŸ“‹ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

      OB.showLoading('ë°œì£¼ ëª©ë¡ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          console.log('âœ… ì„œë²„ ì‘ë‹µ:', res);

          OB.hideLoading();

          if (!res) {
            alert("ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
            renderEmpty();
            return;
          }

          if (!res.success) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            renderEmpty();
            return;
          }

          if (!res.orders || res.orders.length === 0) {
            renderEmpty();
            return;
          }

          // ë°ì´í„° ì €ì¥
          state.allOrders = res.orders;
          state.filteredOrders = res.orders.slice();
          state.currentPage = 1;

          // ë Œë”ë§
          renderOrders();

          console.log('âœ… ì¡°íšŒ ì™„ë£Œ: ' + res.orders.length + 'ê±´');
        })
        .withFailureHandler(function(err) {
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err);
          OB.hideLoading();
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + (err.message || err));
          renderEmpty();
        })
        .getPrintableOrdersApi(params);
    }

    // ========================================
    // PDF ì¶œë ¥ ê¸°ëŠ¥
    // ========================================
    function exportPDF() {
      console.log('ğŸ“„ PDF ì¶œë ¥ ë²„íŠ¼ í´ë¦­');

      // ì²´í¬ëœ ë°œì£¼ë²ˆí˜¸ ìˆ˜ì§‘
      var selected = [];
      document.querySelectorAll(".inv-row-check:checked").forEach(function(c) {
        selected.push(c.dataset.oc);
      });

      if (selected.length === 0) {
        alert("ì¶œë ¥í•  ë°œì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
      var docTypeName = document.getElementById("inv-doc-type").value;
      var docTypeMap = {
        "ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)": "INVOICE_VAT",
        "ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)": "INVOICE_NVAT",
        "ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)": "INVOICE_EN",
        "ë°œì£¼ì„œ(ë§¤ì…)": "ORDER_BASIC",
        "ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤": "ORDER_ROMAND",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹": "ORDER_JONGGEUN",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´": "ORDER_BBIA"
      };
      var docType = docTypeMap[docTypeName] || "INVOICE_VAT";

      // ì¶œë ¥ë°©ì‹ ìˆ˜ì§‘
      var modes = {};
      document.querySelectorAll(".inv-mode").forEach(function(sel) {
        modes[sel.dataset.oc] = sel.value || "auto";
      });

      // ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ì²´í¬ ì—¬ë¶€
      var mergeBySupplier = document.getElementById("inv-merge-by-supplier").checked;

      var params = {
        orderCodes: selected,
        docType: docType,
        printMode: "auto",
        modesByOrder: modes,
        mergeBySupplier: mergeBySupplier
      };

      console.log('ğŸ“„ PDF ìƒì„± íŒŒë¼ë¯¸í„°:', params);
      if (mergeBySupplier) {
        console.log('ğŸ”— ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ëª¨ë“œ í™œì„±í™”');
      }

      OB.showLoading('PDF ìƒì„± ì¤‘... (' + selected.length + 'ê±´)');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert(res ? res.error : "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          // ZIP ë‹¤ìš´ë¡œë“œ URL ì˜¤í”ˆ
          var url = "https://drive.google.com/uc?export=download&id=" + res.fileId;
          window.open(url, "_blank");

          alert('âœ… PDF ìƒì„± ì™„ë£Œ!\níŒŒì¼: ' + res.fileName);
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          console.error('âŒ PDF ìƒì„± ì‹¤íŒ¨:', err);
          alert("PDF ìƒì„± ì‹¤íŒ¨: " + (err.message || err));
        })
        .generateInvoiceZipApi(params);
    }

    // ========================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ========================================

    // ì¡°íšŒ ë²„íŠ¼
    var searchBtn = document.getElementById('inv-search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', searchOrders);
    }

    // Excel ì¶œë ¥ ë²„íŠ¼
    var excelBtn = document.getElementById('inv-export-xlsx');
    if (excelBtn) {
      excelBtn.addEventListener('click', downloadExcel);
    }

    // PDF ì¶œë ¥ ë²„íŠ¼
    var pdfBtn = document.getElementById('inv-export-pdf');
    if (pdfBtn) {
      pdfBtn.addEventListener('click', exportPDF);
    }

    // ì „ì²´ ì²´í¬ë°•ìŠ¤
    var checkAll = document.getElementById("inv-check-all");
    if (checkAll) {
      checkAll.addEventListener("change", function(e) {
        var checkboxes = document.querySelectorAll(".inv-row-check");
        checkboxes.forEach(function(c) {
          c.checked = e.target.checked;
        });
      });
    }

    // ì •ë ¬ í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    var sortableHeaders = document.querySelectorAll('.ob-table-wrap th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (state.currentSort.column === column) {
          state.currentSort.direction = state.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          state.currentSort.column = column;
          state.currentSort.direction = 'asc';
        }

        state.currentPage = 1;
        renderOrders();
      });
    });

    // ì¼ê´„ ì„ íƒ ë²„íŠ¼
    var selectAllBtn = document.getElementById('inv-select-all');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = true;
        });
      });
    }

    var deselectAllBtn = document.getElementById('inv-deselect-all');
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = false;
        });
        document.getElementById('inv-check-all').checked = false;
      });
    }

    // ========================================
    // íƒ­ ì „í™˜ ë¡œì§
    // ========================================
    var tabNavItems = document.querySelectorAll('.tab-nav-item');
    tabNavItems.forEach(function(tabNavItem) {
      tabNavItem.addEventListener('click', function() {
        var targetTab = this.getAttribute('data-tab');

        // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
        document.querySelectorAll('.tab-nav-item').forEach(function(item) {
          item.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(function(content) {
          content.classList.remove('active');
        });

        // ì„ íƒí•œ íƒ­ í™œì„±í™”
        this.classList.add('active');
        document.getElementById('tab-' + targetTab).classList.add('active');
      });
    });

    // ========================================
    // ì¼ê´„ ì²­êµ¬ì„œ íƒ­ ë¡œì§
    // ========================================

    var billingState = {
      currentData: null,
      company: '',
      startDate: '',
      endDate: ''
    };

    // DOM ìš”ì†Œ
    var billingCompanyInput = document.getElementById('billing-company');
    var billingStartDateInput = document.getElementById('billing-start-date');
    var billingEndDateInput = document.getElementById('billing-end-date');
    var billingSearchBtn = document.getElementById('billing-search-btn');
    var billingResetBtn = document.getElementById('billing-reset-btn');
    var billingTbody = document.getElementById('billing-result-tbody');
    var billingSummary = document.getElementById('billing-summary');
    var billingActions = document.getElementById('billing-actions');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    function setBillingDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      billingStartDateInput.value = firstDay;
      billingEndDateInput.value = lastDayStr;
    }

    setBillingDefaultDates();

    // ì¡°íšŒ ë²„íŠ¼
    if (billingSearchBtn) {
      billingSearchBtn.addEventListener('click', function() {
        var company = billingCompanyInput.value.trim();
        var startDate = billingStartDateInput.value;
        var endDate = billingEndDateInput.value;

        if (!company) {
          alert('ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!startDate || !endDate) {
          alert('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        billingState.company = company;
        billingState.startDate = startDate;
        billingState.endDate = endDate;

        OB.showLoading('ì²­êµ¬ ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderBillingEmpty();
              return;
            }

            billingState.currentData = result;
            renderBillingSummary(result);
            renderBillingTable(result.items || []);
            showBillingActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderBillingEmpty();
          })
          .aggregateBillingDataApi({
            company: company,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (billingResetBtn) {
      billingResetBtn.addEventListener('click', function() {
        billingCompanyInput.value = '';
        setBillingDefaultDates();
        billingState.currentData = null;
        renderBillingEmpty();
        hideBillingSummary();
        hideBillingActions();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderBillingSummary(data) {
      document.getElementById('billing-total-items').textContent = OB.formatNumber(data.totalItems || 0);
      document.getElementById('billing-total-order-qty').textContent = OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('billing-total-confirmed-qty').textContent = OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('billing-total-amount').textContent = 'â‚©' + OB.formatNumber(data.totalAmount || 0);

      billingSummary.classList.add('active');
    }

    function hideBillingSummary() {
      billingSummary.classList.remove('active');
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderBillingTable(items) {
      if (!items || items.length === 0) {
        renderBillingEmpty();
        return;
      }

      billingTbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.supplier || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyAmount || 0) + '</td>';

        billingTbody.appendChild(tr);
      });
    }

    function renderBillingEmpty() {
      billingTbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ê±°ë˜ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</td></tr>';
    }

    function showBillingActions() {
      billingActions.style.display = 'flex';
    }

    function hideBillingActions() {
      billingActions.style.display = 'none';
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    var billingExportXlsxBtn = document.getElementById('billing-export-xlsx');
    if (billingExportXlsxBtn) {
      billingExportXlsxBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        var csv = [];
        csv.push(['ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë§¤ì…ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ', 'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ê³µê¸‰ê°€', 'ê³µê¸‰ì•¡'].join(','));

        billingState.currentData.items.forEach(function(item) {
          var row = [
            item.orderCode || '',
            item.orderDate || '',
            item.supplier || '',
            item.brand || '',
            item.productName || '',
            item.productCode || '',
            item.orderQty || 0,
            item.confirmedQty || 0,
            item.supplyPrice || 0,
            item.supplyAmount || 0
          ];
          csv.push(row.join(','));
        });

        var csvContent = '\uFEFF' + csv.join('\n');
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);

        var fileName = 'ì²­êµ¬ì„œ_' + billingState.company + '_' +
          billingState.startDate.replace(/-/g, '') + '-' +
          billingState.endDate.replace(/-/g, '') + '.csv';

        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
      });
    }

    // PDF ì²­êµ¬ì„œ ìƒì„± (ê¸°ì¡´ ëª…ì„¸ì„œ í…œí”Œë¦¿ í™œìš©)
    var billingExportPdfBtn = document.getElementById('billing-export-pdf');
    if (billingExportPdfBtn) {
      billingExportPdfBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ìƒì„±í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        alert('PDF ì²­êµ¬ì„œ ìƒì„±ì€ ê¸°ì¡´ ëª…ì„¸ì„œ ì¶œë ¥ ê¸°ëŠ¥ì„ í™œìš©í•©ë‹ˆë‹¤.\në°œì£¼ë²ˆí˜¸ë³„ ì¶œë ¥ íƒ­ì—ì„œ í•´ë‹¹ ê±°ë˜ì²˜ì˜ ë°œì£¼ì„œë¥¼ ì„ íƒí•˜ì—¬ "ê±°ë˜ëª…ì„¸ì„œ" ìœ í˜•ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”.');
      });
    }

    // ì²­êµ¬ì„œ DB ì €ì¥ + ë°œí–‰
    var billingSaveDbBtn = document.getElementById('billing-save-db');
    if (billingSaveDbBtn) {
      billingSaveDbBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (!confirm('ì²­êµ¬ì„œë¥¼ DBì— ì €ì¥í•˜ê³  ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        var params = {
          settlementId: '',
          type: 'SALES',
          company: billingState.company,
          billingDate: new Date(),
          amount: billingState.currentData.totalAmount,
          notes: billingState.startDate + ' ~ ' + billingState.endDate + ' ì²­êµ¬'
        };

        OB.showLoading('ì²­êµ¬ì„œ ì €ì¥ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('ì²­êµ¬ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì²­êµ¬ID: ' + result.billingId);
            console.log('âœ… ì²­êµ¬ì„œ ì €ì¥ ì™„ë£Œ:', result.billingId);
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
          })
          .createBillingApi(params);
      });
    }

    console.log('âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… OrderList í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.initOrderListPage = function() {
    var wrap = document.querySelector('.orderlist-wrap');
    if (!wrap) {
      console.warn('OrderList wrapper not found');
      return;
    }

    if (wrap.dataset.bound === '1') {
      console.log('OrderList already initialized');
      return;
    }
    wrap.dataset.bound = '1';

    console.log('âœ… OrderList Page ì´ˆê¸°í™” ì™„ë£Œ');

    // DOM ìš”ì†Œ
    var btnSearch = document.getElementById('orderlist-btn-search');
    var btnReset = document.getElementById('orderlist-btn-reset');
    var btnExcel = document.getElementById('orderlist-btn-excel');
    var tbody = document.getElementById('orderlist-tbody');
    var resultCount = document.getElementById('orderlist-result-count');
    var pagination = document.getElementById('orderlist-pagination');
    var pageNumbers = document.getElementById('orderlist-page-numbers');
    var pageInfo = document.getElementById('orderlist-page-info');

    var modal = document.getElementById('orderlist-modal');
    var modalClose = document.getElementById('orderlist-modal-close');
    var modalTitle = document.getElementById('orderlist-modal-title');
    var modalBody = document.getElementById('orderlist-modal-body');
    var btnDelete = document.getElementById('orderlist-btn-delete');
    var btnSaveStatus = document.getElementById('orderlist-btn-save-status');

    // ìƒíƒœ ë³€ìˆ˜
    var currentOrders = [];
    var filteredOrders = [];
    var currentPage = 1;
    var itemsPerPage = 20;
    var currentSort = { column: null, direction: 'asc' };
    var currentOrderCode = null;

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
    setDefaultDates();

    function setDefaultDates() {
      var today = new Date();
      var thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);

      document.getElementById('orderlist-end-date').value = formatDateInput(today);
      document.getElementById('orderlist-start-date').value = formatDateInput(thirtyDaysAgo);
    }

    function formatDateInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ============================================================
    // ì¡°íšŒ ë²„íŠ¼
    // ============================================================
    if (btnSearch) {
      btnSearch.addEventListener('click', function() {
        var params = {
          startDate: document.getElementById('orderlist-start-date').value,
          endDate: document.getElementById('orderlist-end-date').value,
          orderCode: document.getElementById('orderlist-order-code').value,
          buyer: document.getElementById('orderlist-buyer').value,
          brand: document.getElementById('orderlist-brand').value,
          supplier: document.getElementById('orderlist-supplier').value
        };

        console.log('ğŸ” ë°œì£¼ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

        OB.showLoading('ë°œì£¼ ë‚´ì—­ ì¡°íšŒ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ë°œì£¼ ì¡°íšŒ ê²°ê³¼:', result);

            if (!result || !result.success) {
              alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            currentOrders = result.orders || [];
            filteredOrders = currentOrders.slice();
            currentPage = 1;
            renderOrders();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .getPrintableOrdersApi(params);
      });
    }

    // ============================================================
    // ì´ˆê¸°í™” ë²„íŠ¼
    // ============================================================
    if (btnReset) {
      btnReset.addEventListener('click', function() {
        document.getElementById('orderlist-start-date').value = '';
        document.getElementById('orderlist-end-date').value = '';
        document.getElementById('orderlist-order-code').value = '';
        document.getElementById('orderlist-buyer').value = '';
        document.getElementById('orderlist-brand').value = '';
        document.getElementById('orderlist-supplier').value = '';

        setDefaultDates();
        renderEmpty();
      });
    }

    // ============================================================
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    // ============================================================
    if (btnExcel) {
      btnExcel.addEventListener('click', function() {
        if (!filteredOrders || filteredOrders.length === 0) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        downloadCSV();
      });
    }

    function downloadCSV() {
      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      filteredOrders.forEach(function(order) {
        var row = [
          formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ë‚´ì—­_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filteredOrders.length + 'ê±´');
    }

    // ============================================================
    // ì •ë ¬ ê¸°ëŠ¥
    // ============================================================
    var sortableHeaders = document.querySelectorAll('.orderlist-table th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (currentSort.column === column) {
          // ê°™ì€ ì»¬ëŸ¼ í´ë¦­: ë°©í–¥ í† ê¸€
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          // ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­: ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        sortOrders(column, currentSort.direction);
        updateSortIndicators();
        currentPage = 1;
        renderOrders();
      });
    });

    function sortOrders(column, direction) {
      filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ë§ˆì§„ ê³„ì‚° (ì •ë ¬ìš©)
        if (column === 'marginAmount') {
          aVal = (Number(a.totalAmount) || 0) - (Number(a.totalPurchaseAmount) || 0);
          bVal = (Number(b.totalAmount) || 0) - (Number(b.totalPurchaseAmount) || 0);
        }

        if (column === 'marginRate') {
          var aSupply = Number(a.totalAmount) || 0;
          var aPurchase = Number(a.totalPurchaseAmount) || 0;
          var bSupply = Number(b.totalAmount) || 0;
          var bPurchase = Number(b.totalPurchaseAmount) || 0;

          aVal = aSupply > 0 ? ((aSupply - aPurchase) / aSupply * 100) : 0;
          bVal = bSupply > 0 ? ((bSupply - bPurchase) / bSupply * 100) : 0;
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      sortableHeaders.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === currentSort.column) {
          header.classList.add(currentSort.direction);
        }
      });
    }

    // ============================================================
    // ë°œì£¼ ëª©ë¡ ë Œë”ë§ (í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨)
    // ============================================================
    function renderOrders() {
      tbody.innerHTML = '';

      if (!filteredOrders || filteredOrders.length === 0) {
        renderEmpty();
        pagination.style.display = 'none';
        return;
      }

      resultCount.textContent = 'ì´ ' + filteredOrders.length + 'ê±´';

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
      var startIdx = (currentPage - 1) * itemsPerPage;
      var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);
      var pageOrders = filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      pageOrders.forEach(function(order) {
        var tr = document.createElement('tr');
        tr.dataset.orderCode = order.orderCode;

        // ë§ˆì§„ ê³„ì‚°
        var purchaseAmount = Number(order.totalPurchaseAmount) || 0;
        var supplyAmount = Number(order.totalAmount) || 0;
        var marginAmount = supplyAmount - purchaseAmount;
        var marginRate = supplyAmount > 0 ? (marginAmount / supplyAmount * 100) : 0;

        var marginAmountClass = marginAmount >= 0 ? 'orderlist-margin-positive' : 'orderlist-margin-negative';
        var marginRateClass = marginRate >= 0 ? 'orderlist-margin-positive' : 'orderlist-margin-negative';

        // ìƒíƒœ ì •ë³´ ìƒì„± (ê±°ë˜ì›ì¥ì˜ ê²°ì œ, ë°œì£¼, ì¶œê³  ì»¬ëŸ¼ í™•ì¸)
        var statusHtml = '<div class="orderlist-status-badges">';

        // ê²°ì œ ìƒíƒœ
        var paymentStatus = order.payment || '';
        if (paymentStatus === 'Y' || paymentStatus === 'ì™„ë£Œ') {
          statusHtml += '<span class="orderlist-status-badge payment completed">ğŸ’³</span>';
        } else if (paymentStatus) {
          statusHtml += '<span class="orderlist-status-badge payment">ğŸ’³</span>';
        }

        // ë°œì£¼ ìƒíƒœ
        var orderStatus = order.orderStatus || '';
        if (orderStatus === 'Y' || orderStatus === 'ì™„ë£Œ') {
          statusHtml += '<span class="orderlist-status-badge order completed">ğŸ“‹</span>';
        } else if (orderStatus) {
          statusHtml += '<span class="orderlist-status-badge order">ğŸ“‹</span>';
        }

        // ì¶œê³  ìƒíƒœ
        var deliveryStatus = order.delivery || '';
        if (deliveryStatus === 'Y' || deliveryStatus === 'ì™„ë£Œ') {
          statusHtml += '<span class="orderlist-status-badge delivery completed">ğŸšš</span>';
        } else if (deliveryStatus) {
          statusHtml += '<span class="orderlist-status-badge delivery">ğŸšš</span>';
        }

        statusHtml += '</div>';

        tr.innerHTML =
          '<td>' + formatDate(order.orderDate) + '</td>' +
          '<td><span class="orderlist-ordercode">' + (order.orderCode || '') + '</span></td>' +
          '<td>' + (order.buyer || '') + '</td>' +
          '<td>' + (order.brand || '') + '</td>' +
          '<td>' + (order.supplier || '') + '</td>' +
          '<td class="text-center">' + (order.itemCount || 0) + 'ê°œ</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalPurchaseAmount) + '</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalAmount) + '</td>' +
          '<td class="text-right ' + marginAmountClass + '">â‚©' + formatNumber(marginAmount) + '</td>' +
          '<td class="text-right orderlist-margin-rate ' + marginRateClass + '">' + marginRate.toFixed(1) + '%</td>' +
          '<td class="text-center">' + statusHtml + '</td>';

        tr.addEventListener('click', function() {
          loadOrderDetail(order.orderCode);
        });

        tbody.appendChild(tr);
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      if (totalPages > 1) {
        renderPagination(totalPages);
        pagination.style.display = 'flex';
      } else {
        pagination.style.display = 'none';
      }
    }

    // ============================================================
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    // ============================================================
    function renderPagination(totalPages) {
      var btnFirst = document.getElementById('orderlist-page-first');
      var btnPrev = document.getElementById('orderlist-page-prev');
      var btnNext = document.getElementById('orderlist-page-next');
      var btnLast = document.getElementById('orderlist-page-last');

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = currentPage === 1;
      btnPrev.disabled = currentPage === 1;
      btnNext.disabled = currentPage === totalPages;
      btnLast.disabled = currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'orderlist-page-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (currentPage - 1) * itemsPerPage + 1;
      var endIdx = Math.min(currentPage * itemsPerPage, filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (currentPage > 1) { currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (currentPage < totalPages) { currentPage++; renderOrders(); } };
      btnLast.onclick = function() { currentPage = totalPages; renderOrders(); };
    }

    // ============================================================
    // ë¹ˆ í…Œì´ë¸” ë Œë”ë§
    // ============================================================
    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="8" class="orderlist-empty">' +
        '<div class="orderlist-empty-icon">ğŸ“‹</div>' +
        '<div class="orderlist-empty-text">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' +
        '</td></tr>';

      resultCount.textContent = 'ì¡°íšŒ ê²°ê³¼ ì—†ìŒ';
      currentOrders = [];
      filteredOrders = [];
      pagination.style.display = 'none';
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ì¡°íšŒ
    // ============================================================
    function loadOrderDetail(orderCode) {
      console.log('ğŸ“¦ ë°œì£¼ ìƒì„¸ ì¡°íšŒ:', orderCode);
      currentOrderCode = orderCode;

      OB.showLoading('ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('âœ… ë°œì£¼ ìƒì„¸ ê²°ê³¼:', result);

          if (!result || !result.success) {
            alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderOrderDetail(orderCode, result.orderItems || []);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ë°œì£¼ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getOrderDetailApi(orderCode);
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ëª¨ë‹¬ ë Œë”ë§
    // ============================================================
    function renderOrderDetail(orderCode, items) {
      if (!items || items.length === 0) {
        alert('í•´ë‹¹ ë°œì£¼ì˜ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var firstItem = items[0];

      modalTitle.textContent = 'ë°œì£¼ ìƒì„¸ - ' + orderCode;

      var html = '';

      // ê¸°ë³¸ ì •ë³´
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ê¸°ë³¸ ì •ë³´</div>';
      html += '<div class="orderlist-detail-grid">';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ë²ˆí˜¸</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ë²ˆí˜¸'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì¼</div><div class="orderlist-detail-value">' + formatDate(firstItem['ë°œì£¼ì¼']) + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë¸Œëœë“œ</div><div class="orderlist-detail-value">' + (firstItem['ë¸Œëœë“œ'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë§¤ì…ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë§¤ì…ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ì¶œê³ ìƒíƒœ</div><div class="orderlist-detail-value">' + (firstItem['ì¶œê³ '] || 'ë¯¸ì¶œê³ ') + '</div></div>';
      html += '</div>';
      html += '</div>';

      // ìƒíƒœ ìˆ˜ì • (ë”ë¸”í´ë¦­ ë°©ì‹)
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ìƒíƒœ ê´€ë¦¬ (ë”ë¸”í´ë¦­í•˜ì—¬ ë³€ê²½)</div>';
      html += '<div class="orderlist-detail-grid">';
      html += '<div class="orderlist-detail-item">';
      html += '<div class="orderlist-detail-label">ì¶œê³  ìƒíƒœ</div>';
      html += '<div class="orderlist-detail-value"><span class="orderlist-status-clickable" data-status-type="ì¶œê³ " data-current="' + (firstItem['ì¶œê³ '] || 'ë¯¸ì¶œê³ ') + '">' + (firstItem['ì¶œê³ '] || 'ë¯¸ì¶œê³ ') + '</span></div>';
      html += '</div>';
      html += '<div class="orderlist-detail-item">';
      html += '<div class="orderlist-detail-label">ë§¤ì… ê²°ì œ</div>';
      html += '<div class="orderlist-detail-value"><span class="orderlist-status-clickable" data-status-type="ë§¤ì…ê²°ì œ" data-current="' + (firstItem['ë§¤ì…ê²°ì œ'] || 'ë¯¸ê²°ì œ') + '">' + (firstItem['ë§¤ì…ê²°ì œ'] || 'ë¯¸ê²°ì œ') + '</span></div>';
      html += '</div>';
      html += '<div class="orderlist-detail-item">';
      html += '<div class="orderlist-detail-label">ë§¤ì¶œ ê²°ì œ</div>';
      html += '<div class="orderlist-detail-value"><span class="orderlist-status-clickable" data-status-type="ë§¤ì¶œê²°ì œ" data-current="' + (firstItem['ë§¤ì¶œê²°ì œ'] || 'ë¯¸ê²°ì œ') + '">' + (firstItem['ë§¤ì¶œê²°ì œ'] || 'ë¯¸ê²°ì œ') + '</span></div>';
      html += '</div>';
      html += '<div class="orderlist-detail-item">';
      html += '<div class="orderlist-detail-label">ë§¤ì… ë°œì£¼</div>';
      html += '<div class="orderlist-detail-value"><span class="orderlist-status-clickable" data-status-type="ë§¤ì…ë°œì£¼" data-current="' + (firstItem['ë§¤ì…ë°œì£¼'] || 'ë¯¸ì²˜ë¦¬') + '">' + (firstItem['ë§¤ì…ë°œì£¼'] || 'ë¯¸ì²˜ë¦¬') + '</span></div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // í’ˆëª© ëª©ë¡
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">í’ˆëª© ëª©ë¡ (' + items.length + 'ê°œ)</div>';
      html += '<div class="orderlist-detail-table-wrap">';
      html += '<table class="orderlist-detail-table">';
      html += '<thead><tr>';
      html += '<th>ì œí’ˆëª…</th>';
      html += '<th>í’ˆëª©ì½”ë“œ</th>';
      html += '<th class="text-right">ë°œì£¼ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">í™•ì •ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">ë§¤ì…ê°€</th>';
      html += '<th class="text-right">ê³µê¸‰ê°€</th>';
      html += '<th class="text-right">ë§¤ì…ì•¡</th>';
      html += '<th class="text-right">ê³µê¸‰ì•¡</th>';
      html += '<th class="text-right">ë§ˆì§„ì•¡</th>';
      html += '<th class="text-right">ë§ˆì§„ìœ¨</th>';
      html += '</tr></thead>';
      html += '<tbody>';

      var totalPurchaseAmount = 0;
      var totalSupplyAmount = 0;
      var totalMarginAmount = 0;

      items.forEach(function(item, index) {
        var purchaseAmount = Number(item['ë§¤ì…ì•¡'] || 0);
        var supplyAmount = Number(item['ê³µê¸‰ì•¡'] || 0);
        var marginAmount = supplyAmount - purchaseAmount;
        var marginRate = supplyAmount > 0 ? (marginAmount / supplyAmount * 100) : 0;

        totalPurchaseAmount += purchaseAmount;
        totalSupplyAmount += supplyAmount;
        totalMarginAmount += marginAmount;

        var marginClass = marginAmount >= 0 ? 'orderlist-detail-margin-positive' : 'orderlist-detail-margin-negative';
        var marginRateClass = marginRate >= 0 ? 'orderlist-detail-margin-positive' : 'orderlist-detail-margin-negative';

        html += '<tr data-row-index="' + index + '">';
        html += '<td>' + (item['ì œí’ˆëª…'] || '') + '</td>';
        html += '<td>' + (item['í’ˆëª©ì½”ë“œ'] || '') + '</td>';
        html += '<td class="text-right">' + formatNumber(item['ë°œì£¼ìˆ˜ëŸ‰']) + '</td>';
        html += '<td class="text-right"><input type="number" class="orderlist-qty-edit-input" data-row-index="' + index + '" value="' + (item['í™•ì •ìˆ˜ëŸ‰'] || 0) + '" /></td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ë§¤ì…ê°€']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ê³µê¸‰ê°€']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(purchaseAmount) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(supplyAmount) + '</td>';
        html += '<td class="text-right ' + marginClass + '">â‚©' + formatNumber(marginAmount) + '</td>';
        html += '<td class="text-right ' + marginRateClass + '">' + marginRate.toFixed(1) + '%</td>';
        html += '</tr>';
      });

      html += '</tbody>';
      html += '<tfoot>';
      html += '<tr style="font-weight: 700; background: #f9fafb;">';
      html += '<td colspan="6" class="text-right">í•©ê³„</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalPurchaseAmount) + '</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalSupplyAmount) + '</td>';

      var totalMarginRate = totalSupplyAmount > 0 ? (totalMarginAmount / totalSupplyAmount * 100) : 0;
      var totalMarginClass = totalMarginAmount >= 0 ? 'orderlist-detail-margin-positive' : 'orderlist-detail-margin-negative';

      html += '<td class="text-right ' + totalMarginClass + '">â‚©' + formatNumber(totalMarginAmount) + '</td>';
      html += '<td class="text-right ' + totalMarginClass + '">' + totalMarginRate.toFixed(1) + '%</td>';
      html += '</tr>';
      html += '</tfoot>';
      html += '</table>';
      html += '</div>'; // Close orderlist-detail-table-wrap
      html += '</div>';

      modalBody.innerHTML = html;

      // í™•ì •ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìë™ ê¸ˆì•¡ ê³„ì‚°)
      var qtyInputs = modalBody.querySelectorAll('.orderlist-qty-edit-input');
      qtyInputs.forEach(function(input) {
        input.addEventListener('input', function() {
          var rowIndex = parseInt(this.getAttribute('data-row-index'));
          var newQty = Number(this.value) || 0;
          var item = items[rowIndex];

          // ë§¤ì…ê°€ì™€ ê³µê¸‰ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê¸ˆì•¡ ì¬ê³„ì‚°
          var purchasePrice = Number(item['ë§¤ì…ê°€'] || 0);
          var supplyPrice = Number(item['ê³µê¸‰ê°€'] || 0);
          var newPurchaseAmount = purchasePrice * newQty;
          var newSupplyAmount = supplyPrice * newQty;
          var newMarginAmount = newSupplyAmount - newPurchaseAmount;
          var newMarginRate = newSupplyAmount > 0 ? (newMarginAmount / newSupplyAmount * 100) : 0;

          // í•´ë‹¹ í–‰ì˜ ê¸ˆì•¡ ì…€ ì—…ë°ì´íŠ¸
          var row = this.closest('tr');
          var cells = row.querySelectorAll('td');
          cells[6].textContent = 'â‚©' + formatNumber(newPurchaseAmount); // ë§¤ì…ì•¡
          cells[7].textContent = 'â‚©' + formatNumber(newSupplyAmount);   // ê³µê¸‰ì•¡

          var marginClass = newMarginAmount >= 0 ? 'orderlist-detail-margin-positive' : 'orderlist-detail-margin-negative';
          cells[8].className = 'text-right ' + marginClass;
          cells[8].textContent = 'â‚©' + formatNumber(newMarginAmount);   // ë§ˆì§„ì•¡
          cells[9].className = 'text-right ' + marginClass;
          cells[9].textContent = newMarginRate.toFixed(1) + '%';        // ë§ˆì§„ìœ¨

          // í•©ê³„ í–‰ ì¬ê³„ì‚°
          var allRows = modalBody.querySelectorAll('.orderlist-detail-table tbody tr');
          var newTotalPurchase = 0;
          var newTotalSupply = 0;
          var newTotalMargin = 0;

          allRows.forEach(function(r, idx) {
            var qtyInput = r.querySelector('.orderlist-qty-edit-input');
            if (qtyInput) {
              var qty = Number(qtyInput.value) || 0;
              var purchasePrice = Number(items[idx]['ë§¤ì…ê°€'] || 0);
              var supplyPrice = Number(items[idx]['ê³µê¸‰ê°€'] || 0);
              newTotalPurchase += purchasePrice * qty;
              newTotalSupply += supplyPrice * qty;
            }
          });

          newTotalMargin = newTotalSupply - newTotalPurchase;
          var newTotalMarginRate = newTotalSupply > 0 ? (newTotalMargin / newTotalSupply * 100) : 0;
          var totalMarginClass = newTotalMargin >= 0 ? 'orderlist-detail-margin-positive' : 'orderlist-detail-margin-negative';

          var footerCells = modalBody.querySelectorAll('.orderlist-detail-table tfoot td');
          footerCells[1].textContent = 'â‚©' + formatNumber(newTotalPurchase);
          footerCells[2].textContent = 'â‚©' + formatNumber(newTotalSupply);
          footerCells[3].className = 'text-right ' + totalMarginClass;
          footerCells[3].textContent = 'â‚©' + formatNumber(newTotalMargin);
          footerCells[4].className = 'text-right ' + totalMarginClass;
          footerCells[4].textContent = newTotalMarginRate.toFixed(1) + '%';
        });
      });

      // ìƒíƒœ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      var statusElements = modalBody.querySelectorAll('.orderlist-status-clickable');
      statusElements.forEach(function(elem) {
        elem.addEventListener('dblclick', function() {
          var statusType = this.getAttribute('data-status-type');
          var currentValue = this.getAttribute('data-current');
          var options = [];
          var nextValue = '';

          // ìƒíƒœ íƒ€ì…ë³„ ì˜µì…˜ ì •ì˜
          if (statusType === 'ì¶œê³ ') {
            options = ['ë¯¸ì¶œê³ ', 'ì¶œê³ ì™„ë£Œ', 'ë¶€ë¶„ì¶œê³ '];
          } else if (statusType === 'ë§¤ì…ê²°ì œ' || statusType === 'ë§¤ì¶œê²°ì œ') {
            options = ['ë¯¸ê²°ì œ', 'ê²°ì œì™„ë£Œ', 'ë¶€ë¶„ê²°ì œ'];
          } else if (statusType === 'ë§¤ì…ë°œì£¼') {
            options = ['ë¯¸ì²˜ë¦¬', 'ë°œì£¼ì™„ë£Œ'];
          }

          // í˜„ì¬ ê°’ì˜ ë‹¤ìŒ ê°’ìœ¼ë¡œ ìˆœí™˜
          var currentIndex = options.indexOf(currentValue);
          nextValue = options[(currentIndex + 1) % options.length];

          // UI ì—…ë°ì´íŠ¸
          this.textContent = nextValue;
          this.setAttribute('data-current', nextValue);
        });
      });

      modal.classList.add('show');
    }

    // ============================================================
    // ìƒíƒœ ì €ì¥
    // ============================================================
    if (btnSaveStatus) {
      btnSaveStatus.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìƒíƒœ ê°’ ìˆ˜ì§‘ (clickable spanì—ì„œ)
        var statusElements = modalBody.querySelectorAll('.orderlist-status-clickable');
        var shipStatus = '';

        statusElements.forEach(function(elem) {
          if (elem.getAttribute('data-status-type') === 'ì¶œê³ ') {
            shipStatus = elem.getAttribute('data-current');
          }
        });

        if (!confirm('ì¶œê³  ìƒíƒœë¥¼ "' + shipStatus + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        OB.showLoading('ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.updated + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
          })
          .updateOrderStatus(currentOrderCode, shipStatus);
      });
    }

    // ============================================================
    // ë°œì£¼ ì‚­ì œ
    // ============================================================
    if (btnDelete) {
      btnDelete.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (!confirm('âš ï¸ ì •ë§ë¡œ ë°œì£¼ë²ˆí˜¸ "' + currentOrderCode + '"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
          return;
        }

        if (!confirm('âš ï¸âš ï¸ ìµœì¢… í™•ì¸: ë°œì£¼ì™€ ê´€ë ¨ëœ ëª¨ë“  í’ˆëª© ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        OB.showLoading('ë°œì£¼ ì‚­ì œ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ë°œì£¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.deleted + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
          })
          .deleteOrder(currentOrderCode);
      });
    }

    // ============================================================
    // ëª¨ë‹¬ ë‹«ê¸°
    // ============================================================
    if (modalClose) {
      modalClose.addEventListener('click', function() {
        modal.classList.remove('show');
      });
    }

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // ============================================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================================
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    function formatDate(date) {
      if (!date) return '';
      if (typeof date === 'string') {
        if (date.match(/^\d{4}-\d{2}-\d{2}$/)) return date;
      }

      var d = new Date(date);
      if (isNaN(d.getTime())) return '';

      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');

      return year + '-' + month + '-' + day;
    }

    console.log('âœ… OrderList ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.purchaseSettlementState = {
    currentData: null,
    supplier: '',
    startDate: '',
    endDate: ''
  };

  OB.initPurchaseSettlementPage = function() {
    console.log('ğŸ”§ PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.purchaseSettlementState;

    // DOM ìš”ì†Œ
    var supplierInput = document.getElementById('purchase-settlement-supplier');
    var startDateInput = document.getElementById('purchase-settlement-start-date');
    var endDateInput = document.getElementById('purchase-settlement-end-date');
    var searchBtn = document.getElementById('purchase-settlement-search-btn');
    var resetBtn = document.getElementById('purchase-settlement-reset-btn');
    var tbody = document.getElementById('purchase-settlement-tbody');
    var summaryDiv = document.getElementById('purchase-settlement-summary');
    var actionsDiv = document.getElementById('purchase-settlement-actions');

    var saveDraftBtn = document.getElementById('purchase-settlement-save-draft-btn');
    var confirmBtn = document.getElementById('purchase-settlement-confirm-btn');
    var exportBtn = document.getElementById('purchase-settlement-export-btn');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultDates();

    function setDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');

      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      startDateInput.value = firstDay;
      endDateInput.value = lastDayStr;
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        var supplier = supplierInput.value.trim();
        var startDate = startDateInput.value;
        var endDate = endDateInput.value;

        if (!supplier) {
          alert('ë§¤ì…ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!startDate || !endDate) {
          alert('ë§ˆê° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.supplier = supplier;
        state.startDate = startDate;
        state.endDate = endDate;

        console.log('ğŸ“‹ ë§¤ì… ë§ˆê° ì¡°íšŒ:', {supplier, startDate, endDate});

        OB.showLoading('ë§¤ì… ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ì§‘ê³„ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            state.currentData = result;
            renderSummary(result);
            renderTable(result.items || []);
            showActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ì§‘ê³„ ì‹¤íŒ¨:', error);
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .aggregatePurchaseOrdersApi({
            supplier: supplier,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        supplierInput.value = '';
        setDefaultDates();
        state.currentData = null;
        renderEmpty();
        hideActions();
        hideSummary();
      });
    }

    // ì„ì‹œì €ì¥ ë²„íŠ¼
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', function() {
        saveSettlement('DRAFT');
      });
    }

    // í™•ì • ë²„íŠ¼
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        if (!confirm('ë§ˆê°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }
        saveSettlement('CONFIRMED');
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    if (exportBtn) {
      exportBtn.addEventListener('click', function() {
        downloadExcel();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderSummary(data) {
      document.getElementById('purchase-settlement-total-items').textContent =
        OB.formatNumber(data.totalItems || 0);
      document.getElementById('purchase-settlement-total-order-qty').textContent =
        OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('purchase-settlement-total-confirmed-qty').textContent =
        OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('purchase-settlement-diff-qty').textContent =
        OB.formatNumber(data.diffQty || 0);
      document.getElementById('purchase-settlement-total-amount').textContent =
        'â‚©' + OB.formatNumber(data.totalPurchaseAmount || 0);

      summaryDiv.style.display = 'grid';
    }

    function hideSummary() {
      summaryDiv.style.display = 'none';
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(items) {
      if (!items || items.length === 0) {
        renderEmpty();
        return;
      }

      tbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');

        var diffQty = item.diffQty || 0;
        var diffClass = diffQty !== 0 ? 'diff' : '';

        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.buyer || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num ' + diffClass + '">' + OB.formatNumber(diffQty) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.buyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.purchaseAmount || 0) + '</td>';

        tbody.appendChild(tr);
      });
    }

    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="11" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë§¤ì…ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</div>' +
        '</td></tr>';
    }

    function showActions() {
      actionsDiv.style.display = 'flex';
    }

    function hideActions() {
      actionsDiv.style.display = 'none';
    }

    // ë§ˆê° ì €ì¥
    function saveSettlement(status) {
      if (!state.currentData || !state.currentData.items) {
        alert('ì§‘ê³„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var params = {
        supplier: state.supplier,
        startDate: state.startDate,
        endDate: state.endDate,
        status: status,
        items: state.currentData.items,
        notes: ''
      };

      OB.showLoading('ë§ˆê° ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert(result.message || 'ì €ì¥ ì™„ë£Œ');
          console.log('âœ… ë§ˆê° ì €ì¥ ì™„ë£Œ:', result.settlementId);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        })
        .savePurchaseSettlementApi(params);
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadExcel() {
      if (!state.currentData || !state.currentData.items) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push([
        'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ',
        'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ì°¨ì´', 'ë§¤ì…ê°€', 'ë§¤ì…ì•¡'
      ].join(','));

      // ë°ì´í„°
      state.currentData.items.forEach(function(item) {
        var row = [
          item.orderCode || '',
          item.orderDate || '',
          item.buyer || '',
          item.brand || '',
          item.productName || '',
          item.productCode || '',
          item.orderQty || 0,
          item.confirmedQty || 0,
          item.diffQty || 0,
          item.buyPrice || 0,
          item.purchaseAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      var fileName = 'ë§¤ì…ë§ˆê°_' + state.supplier + '_' +
        state.startDate.replace(/-/g, '') + '-' +
        state.endDate.replace(/-/g, '') + '.csv';

      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }

    console.log('âœ… PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ë§¤ì¶œ ë§ˆê° í˜ì´ì§€
  // ========================================

  OB.salesSettlementState = {
    currentData: null,
    buyer: '',
    startDate: '',
    endDate: ''
  };

  OB.initSalesSettlementPage = function() {
    console.log('ğŸ”§ SalesSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.salesSettlementState;

    // DOM ìš”ì†Œ
    var buyerInput = document.getElementById('sales-settlement-buyer');
    var startDateInput = document.getElementById('sales-settlement-start-date');
    var endDateInput = document.getElementById('sales-settlement-end-date');
    var searchBtn = document.getElementById('sales-settlement-search-btn');
    var resetBtn = document.getElementById('sales-settlement-reset-btn');
    var tbody = document.getElementById('sales-settlement-tbody');
    var summaryDiv = document.getElementById('sales-settlement-summary');
    var actionsDiv = document.getElementById('sales-settlement-actions');

    var saveDraftBtn = document.getElementById('sales-settlement-save-draft-btn');
    var confirmBtn = document.getElementById('sales-settlement-confirm-btn');
    var exportBtn = document.getElementById('sales-settlement-export-btn');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultDates();

    function setDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');

      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      startDateInput.value = firstDay;
      endDateInput.value = lastDayStr;
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        var buyer = buyerInput.value.trim();
        var startDate = startDateInput.value;
        var endDate = endDateInput.value;

        if (!buyer) {
          alert('ë°œì£¼ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!startDate || !endDate) {
          alert('ë§ˆê° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.buyer = buyer;
        state.startDate = startDate;
        state.endDate = endDate;

        console.log('ğŸ“‹ ë§¤ì¶œ ë§ˆê° ì¡°íšŒ:', {buyer, startDate, endDate});

        OB.showLoading('ë§¤ì¶œ ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ì§‘ê³„ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            state.currentData = result;
            renderSummary(result);
            renderTable(result.items || []);
            showActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ì§‘ê³„ ì‹¤íŒ¨:', error);
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .aggregateSalesOrdersApi({
            buyer: buyer,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        buyerInput.value = '';
        setDefaultDates();
        state.currentData = null;
        renderEmpty();
        hideActions();
        hideSummary();
      });
    }

    // ì„ì‹œì €ì¥ ë²„íŠ¼
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', function() {
        saveSettlement('DRAFT');
      });
    }

    // í™•ì • ë²„íŠ¼
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        if (!confirm('ë§ˆê°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }
        saveSettlement('CONFIRMED');
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    if (exportBtn) {
      exportBtn.addEventListener('click', function() {
        downloadExcel();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderSummary(data) {
      document.getElementById('sales-settlement-total-items').textContent =
        OB.formatNumber(data.totalItems || 0);
      document.getElementById('sales-settlement-total-order-qty').textContent =
        OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('sales-settlement-total-confirmed-qty').textContent =
        OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('sales-settlement-diff-qty').textContent =
        OB.formatNumber(data.diffQty || 0);
      document.getElementById('sales-settlement-total-amount').textContent =
        'â‚©' + OB.formatNumber(data.totalSupplyAmount || 0);

      summaryDiv.style.display = 'grid';
    }

    function hideSummary() {
      summaryDiv.style.display = 'none';
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(items) {
      if (!items || items.length === 0) {
        renderEmpty();
        return;
      }

      tbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');

        var diffQty = item.diffQty || 0;
        var diffClass = diffQty !== 0 ? 'diff' : '';

        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.supplier || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num ' + diffClass + '">' + OB.formatNumber(diffQty) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyAmount || 0) + '</td>';

        tbody.appendChild(tr);
      });
    }

    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="11" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë°œì£¼ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</div>' +
        '</td></tr>';
    }

    function showActions() {
      actionsDiv.style.display = 'flex';
    }

    function hideActions() {
      actionsDiv.style.display = 'none';
    }

    // ë§ˆê° ì €ì¥
    function saveSettlement(status) {
      if (!state.currentData || !state.currentData.items) {
        alert('ì§‘ê³„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var params = {
        buyer: state.buyer,
        startDate: state.startDate,
        endDate: state.endDate,
        status: status,
        items: state.currentData.items,
        notes: ''
      };

      OB.showLoading('ë§ˆê° ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert(result.message || 'ì €ì¥ ì™„ë£Œ');
          console.log('âœ… ë§ˆê° ì €ì¥ ì™„ë£Œ:', result.settlementId);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        })
        .saveSalesSettlementApi(params);
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadExcel() {
      if (!state.currentData || !state.currentData.items) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push([
        'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë§¤ì…ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ',
        'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ì°¨ì´', 'ë§¤ì¶œê°€', 'ë§¤ì¶œì•¡'
      ].join(','));

      // ë°ì´í„°
      state.currentData.items.forEach(function(item) {
        var row = [
          item.orderCode || '',
          item.orderDate || '',
          item.supplier || '',
          item.brand || '',
          item.productName || '',
          item.productCode || '',
          item.orderQty || 0,
          item.confirmedQty || 0,
          item.diffQty || 0,
          item.supplyPrice || 0,
          item.supplyAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      var fileName = 'ë§¤ì¶œë§ˆê°_' + state.buyer + '_' +
        state.startDate.replace(/-/g, '') + '-' +
        state.endDate.replace(/-/g, '') + '.csv';

      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }

    console.log('âœ… SalesSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ì›”ë³„ ë§ˆê° í˜ì´ì§€
  // ========================================

  OB.monthlyClosingState = {
    currentMonth: '',
    currentStatus: null,
    closingsList: []
  };

  OB.initMonthlyClosingPage = function() {
    console.log('ğŸ”§ MonthlyClosing í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.monthlyClosingState;

    // DOM ìš”ì†Œ
    var monthInput = document.getElementById('monthly-closing-month');
    var checkBtn = document.getElementById('monthly-closing-check-btn');
    var executeBtn = document.getElementById('monthly-closing-execute-btn');
    var unlockBtn = document.getElementById('monthly-closing-unlock-btn');
    var statusDiv = document.getElementById('monthly-closing-status');
    var tbody = document.getElementById('monthly-closing-tbody');

    // ê¸°ë³¸ ì›” ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultMonth();

    function setDefaultMonth() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      monthInput.value = year + '-' + month;
    }

    // ì „ì²´ ë§ˆê° ë‚´ì—­ ë¡œë“œ
    loadAllClosings();

    function loadAllClosings() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.success) {
            console.error('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', result);
            return;
          }

          state.closingsList = result.closings || [];
          renderClosingsTable(state.closingsList);
        })
        .withFailureHandler(function(error) {
          console.error('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
        })
        .getMonthlyClosingsApi();
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (checkBtn) {
      checkBtn.addEventListener('click', function() {
        var month = monthInput.value;
        if (!month) {
          alert('ë§ˆê° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.currentMonth = month.replace('-', '');
        checkMonthStatus(state.currentMonth);
      });
    }

    // ë§ˆê° ì‹¤í–‰ ë²„íŠ¼
    if (executeBtn) {
      executeBtn.addEventListener('click', function() {
        if (!confirm('ì›” ë§ˆê°ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në§ˆê° í›„ì—ëŠ” í•´ë‹¹ ì›”ì˜ CONFIRMED ìƒíƒœì¸ ëª¨ë“  ë§ˆê°ì´ LOCKED ë©ë‹ˆë‹¤.')) {
          return;
        }

        OB.showLoading('ì›” ë§ˆê° ì‹¤í–‰ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ë§ˆê° ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert(result.message || 'ì›” ë§ˆê° ì™„ë£Œ');
            console.log('âœ… ì›” ë§ˆê° ì™„ë£Œ:', result);

            // ìƒíƒœ ë‹¤ì‹œ ì¡°íšŒ
            checkMonthStatus(state.currentMonth);
            loadAllClosings();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë§ˆê° ì‹¤íŒ¨:', error);
            alert('ë§ˆê° ì‹¤íŒ¨: ' + error.message);
          })
          .executeMonthlyClosingApi({
            yearMonth: state.currentMonth
          });
      });
    }

    // ë§ˆê° í•´ì œ ë²„íŠ¼
    if (unlockBtn) {
      unlockBtn.addEventListener('click', function() {
        if (!confirm('ì›” ë§ˆê°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì›”ì˜ ëª¨ë“  LOCKED ë§ˆê°ì´ CONFIRMEDë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
          return;
        }

        OB.showLoading('ì›” ë§ˆê° í•´ì œ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('í•´ì œ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert(result.message || 'ì›” ë§ˆê° í•´ì œ ì™„ë£Œ');
            console.log('âœ… ì›” ë§ˆê° í•´ì œ ì™„ë£Œ:', result);

            // ìƒíƒœ ë‹¤ì‹œ ì¡°íšŒ
            checkMonthStatus(state.currentMonth);
            loadAllClosings();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ í•´ì œ ì‹¤íŒ¨:', error);
            alert('í•´ì œ ì‹¤íŒ¨: ' + error.message);
          })
          .unlockMonthlyClosingApi({
            yearMonth: state.currentMonth
          });
      });
    }

    // ì›” ìƒíƒœ í™•ì¸
    function checkMonthStatus(yearMonth) {
      // ë§ˆê° ë‚´ì—­ì—ì„œ í•´ë‹¹ ì›” ì°¾ê¸°
      var closing = null;
      for (var i = 0; i < state.closingsList.length; i++) {
        if (state.closingsList[i].yearMonth === yearMonth) {
          closing = state.closingsList[i];
          break;
        }
      }

      state.currentStatus = closing;
      renderStatus(closing, yearMonth);
      updateButtons(closing);
    }

    // ìƒíƒœ ë Œë”ë§
    function renderStatus(closing, yearMonth) {
      var year = yearMonth.substring(0, 4);
      var month = yearMonth.substring(4, 6);

      document.getElementById('monthly-status-title').textContent =
        year + 'ë…„ ' + parseInt(month) + 'ì›” ë§ˆê° ìƒíƒœ';

      if (closing) {
        // ë§ˆê° ì™„ë£Œ
        document.getElementById('monthly-status-value').textContent = closing.status;
        document.getElementById('monthly-status-value').className =
          'monthly-status-value status ' + closing.status.toLowerCase();

        document.getElementById('monthly-purchase-count').textContent =
          OB.formatNumber(closing.purchaseCount || 0);
        document.getElementById('monthly-purchase-amount').textContent =
          'â‚©' + OB.formatNumber(closing.purchaseAmount || 0);
        document.getElementById('monthly-sales-count').textContent =
          OB.formatNumber(closing.salesCount || 0);
        document.getElementById('monthly-sales-amount').textContent =
          'â‚©' + OB.formatNumber(closing.salesAmount || 0);

        statusDiv.className = 'monthly-status ' + closing.status.toLowerCase();

        // ë§ˆê° ì •ë³´ í‘œì‹œ
        var infoDiv = document.getElementById('monthly-status-info');
        var infoText = '';
        if (closing.status === 'CLOSED') {
          infoText = 'ğŸ“Œ ë§ˆê°ì¼ì‹œ: ' + closing.closedAt + ' (ë§ˆê°ì: ' + closing.closedBy + ')';
        } else if (closing.status === 'OPEN') {
          infoText = 'ğŸ”“ ë§ˆê° í•´ì œì¼ì‹œ: ' + closing.unlockedAt + ' (í•´ì œì: ' + closing.unlockedBy + ')';
        }
        document.getElementById('monthly-closed-info').textContent = infoText;
        infoDiv.style.display = infoText ? 'block' : 'none';

      } else {
        // ë§ˆê° ì „
        document.getElementById('monthly-status-value').textContent = 'OPEN';
        document.getElementById('monthly-status-value').className =
          'monthly-status-value status open';

        document.getElementById('monthly-purchase-count').textContent = '-';
        document.getElementById('monthly-purchase-amount').textContent = '-';
        document.getElementById('monthly-sales-count').textContent = '-';
        document.getElementById('monthly-sales-amount').textContent = '-';

        statusDiv.className = 'monthly-status open';

        document.getElementById('monthly-status-info').style.display = 'none';
      }

      statusDiv.style.display = 'block';
    }

    // ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateButtons(closing) {
      if (closing && closing.status === 'CLOSED') {
        executeBtn.style.display = 'none';
        unlockBtn.style.display = 'inline-block';
      } else {
        executeBtn.style.display = 'inline-block';
        unlockBtn.style.display = 'none';
      }
    }

    // ë§ˆê° ë‚´ì—­ í…Œì´ë¸” ë Œë”ë§
    function renderClosingsTable(closings) {
      if (!closings || closings.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="9" class="monthly-empty">' +
          '<div class="monthly-empty-icon">ğŸ“‹</div>' +
          '<div class="monthly-empty-text">ë§ˆê° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
          '</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      // ë…„ì›” ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      closings.sort(function(a, b) {
        return b.yearMonth.localeCompare(a.yearMonth);
      });

      closings.forEach(function(closing) {
        var tr = document.createElement('tr');

        var year = closing.yearMonth.substring(0, 4);
        var month = closing.yearMonth.substring(4, 6);
        var displayMonth = year + 'ë…„ ' + month + 'ì›”';

        var statusBadge = '<span class="status-badge ' +
          closing.status.toLowerCase() + '">' +
          closing.status + '</span>';

        tr.innerHTML =
          '<td>' + displayMonth + '</td>' +
          '<td class="status">' + statusBadge + '</td>' +
          '<td class="num">' + OB.formatNumber(closing.purchaseCount || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(closing.purchaseAmount || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(closing.salesCount || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(closing.salesAmount || 0) + '</td>' +
          '<td>' + (closing.closedAt || '-') + '</td>' +
          '<td>' + (closing.closedBy || '-') + '</td>' +
          '<td>' + (closing.unlockedAt || '-') + '</td>';

        tbody.appendChild(tr);
      });
    }

    console.log('âœ… MonthlyClosing í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ì²­êµ¬ì„œ ê´€ë¦¬ í˜ì´ì§€ (BillingManagement)
  // ========================================
  window.initBillingManagementPage = function() {
    console.log('ğŸ”„ BillingManagement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');

    // DOM ìš”ì†Œ
    var companyInput = document.getElementById('billing-mgmt-company');
    var statusSelect = document.getElementById('billing-mgmt-status');
    var startDateInput = document.getElementById('billing-mgmt-start-date');
    var endDateInput = document.getElementById('billing-mgmt-end-date');
    var searchBtn = document.getElementById('billing-mgmt-search-btn');
    var resetBtn = document.getElementById('billing-mgmt-reset-btn');

    var summaryDiv = document.getElementById('billing-mgmt-summary');
    var totalCountSpan = document.getElementById('billing-mgmt-total-count');
    var totalAmountSpan = document.getElementById('billing-mgmt-total-amount');
    var issuedAmountSpan = document.getElementById('billing-mgmt-issued-amount');
    var unpaidAmountSpan = document.getElementById('billing-mgmt-unpaid-amount');

    var tbody = document.getElementById('billing-mgmt-tbody');

    var detailModal = document.getElementById('billing-detail-modal');
    var modalCloseBtn = document.getElementById('billing-modal-close-btn');
    var detailReprintBtn = document.getElementById('billing-detail-reprint-btn');
    var detailChangeStatusBtn = document.getElementById('billing-detail-change-status-btn');

    // í˜„ì¬ ì„ íƒëœ ì²­êµ¬ì„œ
    var currentBilling = null;

    // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ë‹¹ì›” 1ì¼ ~ ë§ì¼)
    var today = new Date();
    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    var lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    startDateInput.value = formatDateInput(firstDay);
    endDateInput.value = formatDateInput(lastDay);

    function formatDateInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchBtn.addEventListener('click', function() {
      var company = companyInput.value.trim();
      var status = statusSelect.value;
      var startDate = startDateInput.value;
      var endDate = endDateInput.value;

      console.log('ğŸ“‹ ì²­êµ¬ì„œ ì¡°íšŒ:', { company: company, status: status, startDate: startDate, endDate: endDate });

      OB.showLoading('ì²­êµ¬ì„œ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('âœ… ì²­êµ¬ì„œ ì¡°íšŒ ì™„ë£Œ:', result);

          if (!result || !result.success) {
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderSummary(result.billings || []);
          renderTable(result.billings || []);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì²­êµ¬ì„œ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ì²­êµ¬ì„œ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getBillingsApi({
          type: '',
          company: company,
          status: status,
          startDate: startDate,
          endDate: endDate
        });
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­
    resetBtn.addEventListener('click', function() {
      companyInput.value = '';
      statusSelect.value = '';
      startDateInput.value = formatDateInput(firstDay);
      endDateInput.value = formatDateInput(lastDay);

      summaryDiv.style.display = 'none';
      tbody.innerHTML =
        '<tr><td colspan="8" class="billing-empty">' +
        '<div class="billing-empty-icon">ğŸ“‹</div>' +
        '<div class="billing-empty-text">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²­êµ¬ì„œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”</div>' +
        '</td></tr>';
    });

    // ìš”ì•½ ì¹´ë“œ ë Œë”ë§
    function renderSummary(billings) {
      if (!billings || billings.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }

      summaryDiv.style.display = 'grid';

      var totalCount = billings.length;
      var totalAmount = 0;
      var issuedAmount = 0;
      var paidAmount = 0;

      billings.forEach(function(billing) {
        var amount = Number(billing.amount) || 0;
        totalAmount += amount;

        if (billing.status === 'ISSUED' || billing.status === 'PAID') {
          issuedAmount += amount;
        }

        if (billing.status === 'PAID') {
          paidAmount += amount;
        }
      });

      var unpaidAmount = issuedAmount - paidAmount;

      totalCountSpan.textContent = OB.formatNumber(totalCount);
      totalAmountSpan.textContent = 'â‚©' + OB.formatNumber(totalAmount);
      issuedAmountSpan.textContent = 'â‚©' + OB.formatNumber(issuedAmount);
      unpaidAmountSpan.textContent = 'â‚©' + OB.formatNumber(unpaidAmount);
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(billings) {
      if (!billings || billings.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="8" class="billing-empty">' +
          '<div class="billing-empty-icon">ğŸ“‹</div>' +
          '<div class="billing-empty-text">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' +
          '</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      billings.forEach(function(billing) {
        var tr = document.createElement('tr');

        var statusBadge = '<span class="billing-status-badge ' +
          billing.status + '">' +
          getStatusText(billing.status) + '</span>';

        var typeText = billing.type === 'PURCHASE' ? 'ë§¤ì…' : 'ë§¤ì¶œ';

        tr.innerHTML =
          '<td>' + billing.billingId + '</td>' +
          '<td>' + typeText + '</td>' +
          '<td>' + billing.company + '</td>' +
          '<td>' + billing.billingDate + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(billing.amount) + '</td>' +
          '<td class="center">' + statusBadge + '</td>' +
          '<td>' + (billing.notes || '-') + '</td>' +
          '<td class="center">' +
          '<button class="billing-btn primary small" data-billing-id="' + billing.billingId + '">ìƒì„¸</button>' +
          '</td>';

        tbody.appendChild(tr);
      });

      // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      tbody.querySelectorAll('button[data-billing-id]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var billingId = this.getAttribute('data-billing-id');
          var billing = billings.find(function(b) { return b.billingId === billingId; });
          if (billing) {
            showDetailModal(billing);
          }
        });
      });
    }

    function getStatusText(status) {
      switch (status) {
        case 'DRAFT': return 'ì„ì‹œì €ì¥';
        case 'ISSUED': return 'ë°œí–‰ì™„ë£Œ';
        case 'PAID': return 'ì…ê¸ˆì™„ë£Œ';
        default: return status;
      }
    }

    // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
    function showDetailModal(billing) {
      currentBilling = billing;

      document.getElementById('detail-billing-id').textContent = billing.billingId || '-';
      document.getElementById('detail-type').textContent = billing.type === 'PURCHASE' ? 'ë§¤ì…' : 'ë§¤ì¶œ';
      document.getElementById('detail-company').textContent = billing.company || '-';
      document.getElementById('detail-settlement-id').textContent = billing.settlementId || '-';
      document.getElementById('detail-billing-date').textContent = billing.billingDate || '-';
      document.getElementById('detail-amount').textContent = 'â‚©' + OB.formatNumber(billing.amount);
      document.getElementById('detail-status').textContent = getStatusText(billing.status);
      document.getElementById('detail-notes').textContent = billing.notes || '-';

      document.getElementById('detail-created-at').textContent = billing.createdAt || '-';
      document.getElementById('detail-created-by').textContent = billing.createdBy || '-';
      document.getElementById('detail-issued-at').textContent = billing.issuedAt || '-';
      document.getElementById('detail-issued-by').textContent = billing.issuedBy || '-';
      document.getElementById('detail-paid-at').textContent = billing.paidAt || '-';

      detailModal.classList.add('active');
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    modalCloseBtn.addEventListener('click', function() {
      detailModal.classList.remove('active');
      currentBilling = null;
    });

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    detailModal.addEventListener('click', function(e) {
      if (e.target === detailModal) {
        detailModal.classList.remove('active');
        currentBilling = null;
      }
    });

    // ì¬ì¶œë ¥ ë²„íŠ¼
    detailReprintBtn.addEventListener('click', function() {
      if (!currentBilling) return;
      alert('ì²­êµ¬ì„œ ì¬ì¶œë ¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
      // TODO: ì²­êµ¬ì„œ PDF ì¬ì¶œë ¥ ê¸°ëŠ¥ êµ¬í˜„
    });

    // ìƒíƒœ ë³€ê²½ ë²„íŠ¼
    detailChangeStatusBtn.addEventListener('click', function() {
      if (!currentBilling) return;

      var nextStatus = '';
      var nextStatusText = '';

      if (currentBilling.status === 'DRAFT') {
        nextStatus = 'ISSUED';
        nextStatusText = 'ë°œí–‰ì™„ë£Œ';
      } else if (currentBilling.status === 'ISSUED') {
        nextStatus = 'PAID';
        nextStatusText = 'ì…ê¸ˆì™„ë£Œ';
      } else {
        alert('ë” ì´ìƒ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.');
        return;
      }

      var confirmMsg = 'ì²­êµ¬ì„œ ìƒíƒœë¥¼ "' + nextStatusText + '"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      if (!confirm(confirmMsg)) return;

      OB.showLoading('ìƒíƒœ ë³€ê²½ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
          detailModal.classList.remove('active');
          currentBilling = null;

          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          searchBtn.click();
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
        })
        .updateBillingStatusApi({
          billingId: currentBilling.billingId,
          status: nextStatus
        });
    });

    console.log('âœ… BillingManagement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

</script>

<!-- ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="ob-loading-overlay" class="ob-loading-overlay">
  <div class="ob-loading-box">
    <div class="ob-spinner"></div>
    <div id="ob-loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>