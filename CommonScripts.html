<script>
  // ===== ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ =====
  window.OB = window.OB || {};
  
  // ===== í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì´ˆê¸° ì„¤ì • =====
  (function() {
    var urlParams = new URLSearchParams(window.location.search);
    var pageFromUrl = urlParams.get('page') || 'orderFile';
    
    OB.state = {
      currentPage: pageFromUrl,
      isLoading: false,
      initializedPages: {}
    };
  })();

  // ===== ê³µí†µ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ =====
  OB.initCurrentPage = function(page) {
    console.log('ğŸ”§ initCurrentPage í˜¸ì¶œ:', page);
    
    if (OB.state.initializedPages[page]) {
      console.log('â­ï¸  ì´ë¯¸ ì´ˆê¸°í™”ë¨:', page);
      return;
    }

    var initFuncName = null;

    switch(page) {
      case 'orderFile':
        initFuncName = 'initOrderFilePage';
        break;
      case 'dashboard':
        initFuncName = 'initDashboardPage';
        break;
      case 'orderList':
        initFuncName = 'initOrderListPage';
        break;
      case 'invoiceOutput':
        initFuncName = 'initInvoiceOutputPage';
        break;
      case 'settings':
        initFuncName = 'initSettingsPage';
        break;
    }

    if (initFuncName && typeof OB[initFuncName] === 'function') {
      console.log('âœ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰:', initFuncName);
      
      try {
        OB[initFuncName]();
        OB.state.initializedPages[page] = true;
        console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ:', page);
      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', page, err);
      }
    } else {
      console.warn('âš ï¸  ì´ˆê¸°í™” í•¨ìˆ˜ ì—†ìŒ:', page, initFuncName);
    }
  };

  // ===== ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  OB.showLoading = function (message) {
    var overlay = document.getElementById('ob-loading-overlay');
    var textEl = document.getElementById('ob-loading-text');
    if (!overlay || !textEl) return;
    textEl.textContent = message || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.';
    overlay.classList.add('show');
    OB.state.isLoading = true;
  };

  OB.hideLoading = function () {
    var overlay = document.getElementById('ob-loading-overlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    OB.state.isLoading = false;
  };

  // ===== API ë˜í¼ =====
  OB.api = {
    ping: function () {
      OB.showLoading('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘.');
      google.script.run
        .withSuccessHandler(function (res) {
          OB.hideLoading();
          console.log('ping result:', res);
          alert('ì„œë²„ ì—°ê²° ì™„ë£Œ: ' + (res && res.status));
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error(err);
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        })
        .ping();
    },

    loadPage: function (page) {
      OB.showLoading('í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘:', page);

      google.script.run
        .withSuccessHandler(function (html) {
          OB.hideLoading();

          var container = document.getElementById('app-main');
          if (!container) {
            console.error('âŒ app-main ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }

          container.innerHTML = html;

          // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
          OB.state.currentPage = page;
          
          // ìƒˆë¡œ ë¡œë“œí•œ í˜ì´ì§€ëŠ” ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
          OB.state.initializedPages[page] = false;

          // ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
          OB.highlightActiveNav(page);

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
          setTimeout(function() {
            OB.initCurrentPage(page);
          }, 50);
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        })
        .getPageContent(page);
    }
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì•¡í‹°ë¸Œ í‘œì‹œ =====
  OB.highlightActiveNav = function(page) {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      var navPage = link.getAttribute('data-nav-page');
      if (navPage === page) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • =====
  function setupNavLinks() {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var page = link.getAttribute('data-nav-page');
        if (page) OB.api.loadPage(page);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded - ì´ˆê¸° í˜ì´ì§€:', OB.state.currentPage);

    setupNavLinks();
    OB.highlightActiveNav(OB.state.currentPage);
    OB.initCurrentPage(OB.state.currentPage);
  });

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  OB.formatNumber = function(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  };

  OB.formatDate = function(date) {
    if (!date) return '';
    if (typeof date === 'string') return date;
    
    var d = new Date(date);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    
    return year + '-' + month + '-' + day;
  };

  // ===========================================================
  // âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.invoiceOutputState = { modesByOrder: {} };

  OB.initInvoiceOutputPage = function() {
    console.log('ğŸ”§ initInvoiceOutputPage ì‹œì‘');
    
    var searchBtn = document.getElementById('inv-search-btn');
    
    // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
    if (!searchBtn) {
      console.error('âŒ ì¡°íšŒ ë²„íŠ¼(inv-search-btn)ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
      return;
    }
    
    // ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
    if (searchBtn.dataset.bound === '1') {
      console.log('â­• ì´ë¯¸ ì´ˆê¸°í™”ë¨');
      return;
    }
    searchBtn.dataset.bound = '1';

    // ë¹ˆ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
    function renderEmpty() {
      var tbody = document.getElementById("inv-result-tbody");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
    function formatDate(dateVal) {
      if (!dateVal) return '';
      var d = new Date(dateVal);
      if (isNaN(d.getTime())) return '';
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return Number(num).toLocaleString('ko-KR');
    }
    
    renderEmpty();

    // ì „ì²´ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    var checkAll = document.getElementById("inv-check-all");
    if (checkAll) {
      checkAll.addEventListener("change", function(e) {
        var checkboxes = document.querySelectorAll(".inv-row-check");
        checkboxes.forEach(function(c) {
          c.checked = e.target.checked;
        });
      });
    }

    // âœ… ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    searchBtn.addEventListener('click', function() {
      console.log('ğŸ” ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨');
      
      var params = {
        orderCode: document.getElementById("inv-order-code").value,
        supplier: document.getElementById("inv-supplier").value,
        startDate: document.getElementById("inv-start-date").value,
        endDate: document.getElementById("inv-end-date").value
      };
      
      console.log('ğŸ“‹ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);
      
      OB.showLoading('ë°œì£¼ ëª©ë¡ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          console.log('âœ… ì„œë²„ ì‘ë‹µ:', res);
          
          OB.hideLoading();
          
          // ì‘ë‹µ ê²€ì¦
          if (!res) {
            alert("ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
            renderEmpty();
            return;
          }
          
          if (!res.success) { 
            alert("ì˜¤ë¥˜ ë°œìƒ: " + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            renderEmpty();
            return;
          }

          var tbody = document.getElementById("inv-result-tbody");
          if (!tbody) {
            console.error('âŒ tbody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }
          
          // í…Œì´ë¸” ì´ˆê¸°í™”
          tbody.innerHTML = "";

          // ë°ì´í„° ì—†ìŒ
          if (!res.orders || res.orders.length === 0) {
            renderEmpty();
            return;
          }

          // ë°ì´í„° ë Œë”ë§
          res.orders.forEach(function(o) {
            var mode = OB.invoiceOutputState.modesByOrder[o.orderCode] || "auto";
            var dateStr = formatDate(o.orderDate);
            
            var tr = document.createElement('tr');
            tr.innerHTML = 
              '<td><input type="checkbox" class="inv-row-check" data-oc="' + o.orderCode + '"></td>' +
              '<td>' + dateStr + '</td>' +
              '<td>' + (o.orderCode || '') + '</td>' +
              '<td>' + (o.brand || '') + '</td>' +
              '<td>' + (o.supplier || '') + '</td>' +
              '<td>' + (o.buyer || '') + '</td>' +
              '<td class="num">' + (o.itemCount || 0) + '</td>' +
              '<td class="num">' + formatNumber(o.totalPurchaseAmount) + '</td>' +
              '<td class="num">' + formatNumber(o.totalAmount) + '</td>' +
              '<td>' +
                '<select class="inv-mode" data-oc="' + o.orderCode + '">' +
                  '<option value="auto"' + (mode === "auto" ? ' selected' : '') + '>ìë™</option>' +
                  '<option value="full"' + (mode === "full" ? ' selected' : '') + '>ì „ì²´</option>' +
                  '<option value="short"' + (mode === "short" ? ' selected' : '') + '>ë‹¨ì¶•</option>' +
                '</select>' +
              '</td>';
            
            tbody.appendChild(tr);
          });
          
          console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ: ' + res.orders.length + 'ê±´');
        })
        .withFailureHandler(function(err) {
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err);
          OB.hideLoading();
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + (err.message || err));
          renderEmpty();
        })
        .getPrintableOrdersApi(params);
    });
    
    console.log('âœ… ì¡°íšŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');

    // âœ… PDF ì¶œë ¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    var pdfBtn = document.getElementById("inv-export-pdf");
    if (pdfBtn) {
      pdfBtn.addEventListener('click', function() {
        console.log('ğŸ“„ PDF ì¶œë ¥ ë²„íŠ¼ í´ë¦­');
        
        // ì²´í¬ëœ ë°œì£¼ë²ˆí˜¸ ìˆ˜ì§‘
        var selected = [];
        document.querySelectorAll(".inv-row-check:checked").forEach(function(c) {
          selected.push(c.dataset.oc);
        });

        if (selected.length === 0) {
          alert("ì¶œë ¥í•  ë°œì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
        var docTypeName = document.getElementById("inv-doc-type").value;
        var docTypeMap = {
          "ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)": "INVOICE_VAT",
          "ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)": "INVOICE_NVAT",
          "ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)": "INVOICE_EN",
          "ë°œì£¼ì„œ(ë§¤ì…)": "ORDER_BASIC",
          "ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤": "ORDER_ROMAND",
          "ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹": "ORDER_JONGGEUN",
          "ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´": "ORDER_BBIA"
        };
        var docType = docTypeMap[docTypeName] || "INVOICE_VAT";

        // ì¶œë ¥ë°©ì‹ ìˆ˜ì§‘
        var modesByOrder = {};
        document.querySelectorAll(".inv-mode").forEach(function(sel) {
          modesByOrder[sel.dataset.oc] = sel.value || "auto";
        });

        var params = {
          orderCodes: selected,
          docType: docType,
          printMode: "auto",
          modesByOrder: modesByOrder
        };

        console.log('ğŸ“„ PDF ìƒì„± íŒŒë¼ë¯¸í„°:', params);

        OB.showLoading('PDF ìƒì„± ì¤‘...');

        google.script.run
          .withSuccessHandler(function(res) {
            OB.hideLoading();
            
            if (!res || !res.success) {
              alert(res ? res.error : "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              return;
            }

            // ZIP ë‹¤ìš´ë¡œë“œ URL ì˜¤í”ˆ
            var url = "https://drive.google.com/uc?export=download&id=" + res.fileId;
            window.open(url, "_blank");
          })
          .withFailureHandler(function(err) {
            OB.hideLoading();
            console.error('âŒ PDF ìƒì„± ì‹¤íŒ¨:', err);
            alert("PDF ìƒì„± ì‹¤íŒ¨: " + (err.message || err));
          })
          .generateInvoiceZipApi(params);
      });
      
      console.log('âœ… PDF ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
    }

    console.log('âœ… initInvoiceOutputPage ì™„ë£Œ');
  };

</script>

<!-- ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="ob-loading-overlay" class="ob-loading-overlay">
  <div class="ob-loading-box">
    <div class="ob-spinner"></div>
    <div id="ob-loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>