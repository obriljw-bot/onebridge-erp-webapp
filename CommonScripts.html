<script>
  // ===== ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ =====
  window.OB = window.OB || {};
  
  // ===== í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì´ˆê¸° ì„¤ì • =====
  (function() {
    var urlParams = new URLSearchParams(window.location.search);
    var pageFromUrl = urlParams.get('page') || 'orderFile';
    
    OB.state = {
      currentPage: pageFromUrl,
      isLoading: false,
      initializedPages: {}
    };
  })();

  // ===== ê³µí†µ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ =====
  OB.initCurrentPage = function(page) {
    console.log('ğŸ”§ initCurrentPage í˜¸ì¶œ:', page);
    
    if (OB.state.initializedPages[page]) {
      console.log('â­ï¸  ì´ë¯¸ ì´ˆê¸°í™”ë¨:', page);
      return;
    }

    var initFuncName = null;

    switch(page) {
      case 'orderFile':
        initFuncName = 'initOrderFilePage';
        break;
      case 'dashboard':
        initFuncName = 'initDashboardPage';
        break;
      case 'orderList':
        initFuncName = 'initOrderListPage';
        break;
      case 'invoiceOutput':
        initFuncName = 'initInvoiceOutputPage';
        break;
      case 'transactionLedger':
        initFuncName = 'initTransactionLedgerPage';
        break;
      case 'purchaseSettlement':
        initFuncName = 'initPurchaseSettlementPage';
        break;
      case 'salesSettlement':
        initFuncName = 'initSalesSettlementPage';
        break;
      case 'monthlyClosing':
        initFuncName = 'initMonthlyClosingPage';
        break;
      case 'billingManagement':
        initFuncName = 'initBillingManagementPage';
        break;
      case 'invoiceManagement':
        initFuncName = 'initInvoiceManagementPage';
        break;
      case 'settings':
        initFuncName = 'initSettingsPage';
        break;
    }

    if (initFuncName && typeof OB[initFuncName] === 'function') {
      console.log('âœ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰:', initFuncName);
      
      try {
        OB[initFuncName]();
        OB.state.initializedPages[page] = true;
        console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ:', page);
      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', page, err);
      }
    } else {
      console.warn('âš ï¸  ì´ˆê¸°í™” í•¨ìˆ˜ ì—†ìŒ:', page, initFuncName);
    }
  };

  // ===== ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  OB.showLoading = function (message) {
    var overlay = document.getElementById('ob-loading-overlay');
    var textEl = document.getElementById('ob-loading-text');
    if (!overlay || !textEl) return;
    textEl.textContent = message || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.';
    overlay.classList.add('show');
    OB.state.isLoading = true;
  };

  OB.hideLoading = function () {
    var overlay = document.getElementById('ob-loading-overlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    OB.state.isLoading = false;
  };

  // ===== API ë˜í¼ =====
  OB.api = {
    ping: function () {
      OB.showLoading('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘.');
      google.script.run
        .withSuccessHandler(function (res) {
          OB.hideLoading();
          console.log('ping result:', res);
          alert('ì„œë²„ ì—°ê²° ì™„ë£Œ: ' + (res && res.status));
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error(err);
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        })
        .ping();
    },

    loadPage: function (page) {
      OB.showLoading('í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘:', page);

      google.script.run
        .withSuccessHandler(function (html) {
          OB.hideLoading();

          var container = document.getElementById('app-main');
          if (!container) {
            console.error('âŒ app-main ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }

          container.innerHTML = html;

          // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
          OB.state.currentPage = page;
          
          // ìƒˆë¡œ ë¡œë“œí•œ í˜ì´ì§€ëŠ” ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
          OB.state.initializedPages[page] = false;

          // ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
          OB.highlightActiveNav(page);

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
          setTimeout(function() {
            OB.initCurrentPage(page);
          }, 50);
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        })
        .getPageContent(page);
    }
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì•¡í‹°ë¸Œ í‘œì‹œ =====
  OB.highlightActiveNav = function(page) {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      var navPage = link.getAttribute('data-nav-page');
      if (navPage === page) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • =====
  function setupNavLinks() {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var page = link.getAttribute('data-nav-page');
        if (page) OB.api.loadPage(page);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded - ì´ˆê¸° í˜ì´ì§€:', OB.state.currentPage);

    setupNavLinks();
    OB.highlightActiveNav(OB.state.currentPage);
    OB.initCurrentPage(OB.state.currentPage);
  });

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  OB.formatNumber = function(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  };

  OB.formatDate = function(date) {
    if (!date) return '';
    if (typeof date === 'string') return date;
    
    var d = new Date(date);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    
    return year + '-' + month + '-' + day;
  };

  // ===========================================================
  // âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.invoiceOutputState = {
    allOrders: [],
    filteredOrders: [],
    currentPage: 1,
    itemsPerPage: 20,
    currentSort: {
      column: 'orderDate',
      direction: 'desc'
    },
    modesByOrder: {}
  };

  OB.initInvoiceOutputPage = function() {
    console.log('ğŸ”§ InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.invoiceOutputState;

    // ========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ========================================
    function formatDateInput(d) {
      if (!d) return '';
      if (!(d instanceof Date)) d = new Date(d);
      if (isNaN(d.getTime())) return '';
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return year + month + day;
    }

    function renderEmpty() {
      var tbody = document.getElementById("inv-result-tbody");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
      document.getElementById('inv-pagination').style.display = 'none';
      document.getElementById('inv-bulk-select').style.display = 'none';
    }

    // ========================================
    // 1. Excel ë‹¤ìš´ë¡œë“œ
    // ========================================
    function downloadExcel() {
      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      state.filteredOrders.forEach(function(order) {
        var row = [
          OB.formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ì¶œë ¥ëª©ë¡_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // 2. ì •ë ¬ ê¸°ëŠ¥
    // ========================================
    function sortOrders(column, direction) {
      state.filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      var headers = document.querySelectorAll('.ob-table-wrap th.sortable');
      headers.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === state.currentSort.column) {
          header.classList.add(state.currentSort.direction);
        }
      });
    }

    // ========================================
    // 3. í˜ì´ì§€ë„¤ì´ì…˜
    // ========================================
    function renderPagination(totalPages) {
      var paginationContainer = document.getElementById('inv-pagination');
      var pageInfo = document.getElementById('inv-page-info');
      var pageNumbers = document.getElementById('inv-page-numbers');
      var btnFirst = document.getElementById('inv-page-first');
      var btnPrev = document.getElementById('inv-page-prev');
      var btnNext = document.getElementById('inv-page-next');
      var btnLast = document.getElementById('inv-page-last');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = state.currentPage === 1;
      btnPrev.disabled = state.currentPage === 1;
      btnNext.disabled = state.currentPage === totalPages;
      btnLast.disabled = state.currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, state.currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === state.currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          state.currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (state.currentPage - 1) * state.itemsPerPage + 1;
      var endIdx = Math.min(state.currentPage * state.itemsPerPage, state.filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + state.filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { state.currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (state.currentPage > 1) { state.currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (state.currentPage < totalPages) { state.currentPage++; renderOrders(); } };
      btnLast.onclick = function() { state.currentPage = totalPages; renderOrders(); };
    }

    // ========================================
    // 4. ë¸Œëœë“œ/ë§¤ì…ì²˜ë³„ ì¼ê´„ ì„ íƒ
    // ========================================
    function renderBulkSelectButtons() {
      var bulkSelectContainer = document.getElementById('inv-bulk-select');
      var brandBtnsContainer = document.getElementById('inv-brand-btns');
      var supplierBtnsContainer = document.getElementById('inv-supplier-btns');

      if (state.filteredOrders.length === 0) {
        bulkSelectContainer.style.display = 'none';
        return;
      }

      bulkSelectContainer.style.display = 'flex';

      // ë¸Œëœë“œ ëª©ë¡ ì¶”ì¶œ
      var brands = {};
      var suppliers = {};
      state.filteredOrders.forEach(function(order) {
        if (order.brand) brands[order.brand] = true;
        if (order.supplier) suppliers[order.supplier] = true;
      });

      var brandList = Object.keys(brands).sort();
      var supplierList = Object.keys(suppliers).sort();

      // ë¸Œëœë“œ ë²„íŠ¼ ìƒì„±
      brandBtnsContainer.innerHTML = '';
      brandList.forEach(function(brand) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = brand;
        btn.addEventListener('click', function() {
          selectByBrand(brand);
        });
        brandBtnsContainer.appendChild(btn);
      });

      // ë§¤ì…ì²˜ ë²„íŠ¼ ìƒì„±
      supplierBtnsContainer.innerHTML = '';
      supplierList.forEach(function(supplier) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = supplier;
        btn.addEventListener('click', function() {
          selectBySupplier(supplier);
        });
        supplierBtnsContainer.appendChild(btn);
      });
    }

    function selectByBrand(brand) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.brand === brand) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    function selectBySupplier(supplier) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.supplier === supplier) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    // ========================================
    // í…Œì´ë¸” ë Œë”ë§
    // ========================================
    function renderOrders() {
      var tbody = document.getElementById('inv-result-tbody');

      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        renderEmpty();
        return;
      }

      // ì •ë ¬
      sortOrders(state.currentSort.column, state.currentSort.direction);
      updateSortIndicators();

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(state.filteredOrders.length / state.itemsPerPage);
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);
      var pageOrders = state.filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = '';
      pageOrders.forEach(function(o) {
        var mode = state.modesByOrder[o.orderCode] || document.getElementById('inv-default-mode').value || 'auto';
        var dateStr = OB.formatDate(o.orderDate);

        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td><input type="checkbox" class="inv-row-check" data-oc="' + o.orderCode + '"></td>' +
          '<td>' + dateStr + '</td>' +
          '<td>' + (o.orderCode || '') + '</td>' +
          '<td>' + (o.brand || '') + '</td>' +
          '<td>' + (o.supplier || '') + '</td>' +
          '<td>' + (o.buyer || '') + '</td>' +
          '<td class="num">' + (o.itemCount || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalPurchaseAmount) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalAmount) + '</td>' +
          '<td>' +
            '<select class="inv-mode" data-oc="' + o.orderCode + '">' +
              '<option value="auto"' + (mode === 'auto' ? ' selected' : '') + '>ìë™</option>' +
              '<option value="full"' + (mode === 'full' ? ' selected' : '') + '>ì „ì²´</option>' +
              '<option value="short"' + (mode === 'short' ? ' selected' : '') + '>ë‹¨ì¶•</option>' +
            '</select>' +
          '</td>';

        tbody.appendChild(tr);
      });

      // ì¶œë ¥ë°©ì‹ ë³€ê²½ ì´ë²¤íŠ¸
      document.querySelectorAll('.inv-mode').forEach(function(sel) {
        sel.addEventListener('change', function() {
          state.modesByOrder[this.dataset.oc] = this.value;
        });
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPagination(totalPages);

      // ì¼ê´„ ì„ íƒ ë²„íŠ¼ ë Œë”ë§
      renderBulkSelectButtons();

      console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ: ' + pageOrders.length + '/' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // ì¡°íšŒ ê¸°ëŠ¥
    // ========================================
    function searchOrders() {
      console.log('ğŸ” ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨');

      var params = {
        orderCode: document.getElementById("inv-order-code").value,
        supplier: document.getElementById("inv-supplier").value,
        startDate: document.getElementById("inv-start-date").value,
        endDate: document.getElementById("inv-end-date").value
      };

      console.log('ğŸ“‹ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

      OB.showLoading('ë°œì£¼ ëª©ë¡ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          console.log('âœ… ì„œë²„ ì‘ë‹µ:', res);

          OB.hideLoading();

          if (!res) {
            alert("ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
            renderEmpty();
            return;
          }

          if (!res.success) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            renderEmpty();
            return;
          }

          if (!res.orders || res.orders.length === 0) {
            renderEmpty();
            return;
          }

          // ë°ì´í„° ì €ì¥
          state.allOrders = res.orders;
          state.filteredOrders = res.orders.slice();
          state.currentPage = 1;

          // ë Œë”ë§
          renderOrders();

          console.log('âœ… ì¡°íšŒ ì™„ë£Œ: ' + res.orders.length + 'ê±´');
        })
        .withFailureHandler(function(err) {
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err);
          OB.hideLoading();
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + (err.message || err));
          renderEmpty();
        })
        .getPrintableOrdersApi(params);
    }

    // ========================================
    // PDF ì¶œë ¥ ê¸°ëŠ¥
    // ========================================
    function exportPDF() {
      console.log('ğŸ“„ PDF ì¶œë ¥ ë²„íŠ¼ í´ë¦­');

      // ì²´í¬ëœ ë°œì£¼ë²ˆí˜¸ ìˆ˜ì§‘
      var selected = [];
      document.querySelectorAll(".inv-row-check:checked").forEach(function(c) {
        selected.push(c.dataset.oc);
      });

      if (selected.length === 0) {
        alert("ì¶œë ¥í•  ë°œì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
      var docTypeName = document.getElementById("inv-doc-type").value;
      var docTypeMap = {
        "ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)": "INVOICE_VAT",
        "ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)": "INVOICE_NVAT",
        "ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)": "INVOICE_EN",
        "ë°œì£¼ì„œ(ë§¤ì…)": "ORDER_BASIC",
        "ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤": "ORDER_ROMAND",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹": "ORDER_JONGGEUN",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´": "ORDER_BBIA"
      };
      var docType = docTypeMap[docTypeName] || "INVOICE_VAT";

      // ì¶œë ¥ë°©ì‹ ìˆ˜ì§‘
      var modes = {};
      document.querySelectorAll(".inv-mode").forEach(function(sel) {
        modes[sel.dataset.oc] = sel.value || "auto";
      });

      // ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ì²´í¬ ì—¬ë¶€
      var mergeBySupplier = document.getElementById("inv-merge-by-supplier").checked;

      var params = {
        orderCodes: selected,
        docType: docType,
        printMode: "auto",
        modesByOrder: modes,
        mergeBySupplier: mergeBySupplier
      };

      console.log('ğŸ“„ PDF ìƒì„± íŒŒë¼ë¯¸í„°:', params);
      if (mergeBySupplier) {
        console.log('ğŸ”— ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ëª¨ë“œ í™œì„±í™”');
      }

      OB.showLoading('PDF ìƒì„± ì¤‘... (' + selected.length + 'ê±´)');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert(res ? res.error : "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          // ZIP ë‹¤ìš´ë¡œë“œ URL ì˜¤í”ˆ
          var url = "https://drive.google.com/uc?export=download&id=" + res.fileId;
          window.open(url, "_blank");

          alert('âœ… PDF ìƒì„± ì™„ë£Œ!\níŒŒì¼: ' + res.fileName);
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          console.error('âŒ PDF ìƒì„± ì‹¤íŒ¨:', err);
          alert("PDF ìƒì„± ì‹¤íŒ¨: " + (err.message || err));
        })
        .generateInvoiceZipApi(params);
    }

    // ========================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ========================================

    // ì¡°íšŒ ë²„íŠ¼
    var searchBtn = document.getElementById('inv-search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', searchOrders);
    }

    // Excel ì¶œë ¥ ë²„íŠ¼
    var excelBtn = document.getElementById('inv-export-xlsx');
    if (excelBtn) {
      excelBtn.addEventListener('click', downloadExcel);
    }

    // PDF ì¶œë ¥ ë²„íŠ¼
    var pdfBtn = document.getElementById('inv-export-pdf');
    if (pdfBtn) {
      pdfBtn.addEventListener('click', exportPDF);
    }

    // ì „ì²´ ì²´í¬ë°•ìŠ¤
    var checkAll = document.getElementById("inv-check-all");
    if (checkAll) {
      checkAll.addEventListener("change", function(e) {
        var checkboxes = document.querySelectorAll(".inv-row-check");
        checkboxes.forEach(function(c) {
          c.checked = e.target.checked;
        });
      });
    }

    // ì •ë ¬ í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    var sortableHeaders = document.querySelectorAll('.ob-table-wrap th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (state.currentSort.column === column) {
          state.currentSort.direction = state.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          state.currentSort.column = column;
          state.currentSort.direction = 'asc';
        }

        state.currentPage = 1;
        renderOrders();
      });
    });

    // ì¼ê´„ ì„ íƒ ë²„íŠ¼
    var selectAllBtn = document.getElementById('inv-select-all');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = true;
        });
      });
    }

    var deselectAllBtn = document.getElementById('inv-deselect-all');
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = false;
        });
        document.getElementById('inv-check-all').checked = false;
      });
    }

    // ========================================
    // íƒ­ ì „í™˜ ë¡œì§
    // ========================================
    var tabNavItems = document.querySelectorAll('.tab-nav-item');
    tabNavItems.forEach(function(tabNavItem) {
      tabNavItem.addEventListener('click', function() {
        var targetTab = this.getAttribute('data-tab');

        // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
        document.querySelectorAll('.tab-nav-item').forEach(function(item) {
          item.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(function(content) {
          content.classList.remove('active');
        });

        // ì„ íƒí•œ íƒ­ í™œì„±í™”
        this.classList.add('active');
        document.getElementById('tab-' + targetTab).classList.add('active');
      });
    });

    // ========================================
    // ì¼ê´„ ì²­êµ¬ì„œ íƒ­ ë¡œì§
    // ========================================

    var billingState = {
      currentData: null,
      company: '',
      startDate: '',
      endDate: ''
    };

    // DOM ìš”ì†Œ
    var billingCompanyInput = document.getElementById('billing-company');
    var billingStartDateInput = document.getElementById('billing-start-date');
    var billingEndDateInput = document.getElementById('billing-end-date');
    var billingSearchBtn = document.getElementById('billing-search-btn');
    var billingResetBtn = document.getElementById('billing-reset-btn');
    var billingTbody = document.getElementById('billing-result-tbody');
    var billingSummary = document.getElementById('billing-summary');
    var billingActions = document.getElementById('billing-actions');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    function setBillingDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      billingStartDateInput.value = firstDay;
      billingEndDateInput.value = lastDayStr;
    }

    setBillingDefaultDates();

    // ì¡°íšŒ ë²„íŠ¼
    if (billingSearchBtn) {
      billingSearchBtn.addEventListener('click', function() {
        var company = billingCompanyInput.value.trim();
        var startDate = billingStartDateInput.value;
        var endDate = billingEndDateInput.value;

        if (!company) {
          alert('ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!startDate || !endDate) {
          alert('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        billingState.company = company;
        billingState.startDate = startDate;
        billingState.endDate = endDate;

        OB.showLoading('ì²­êµ¬ ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderBillingEmpty();
              return;
            }

            billingState.currentData = result;
            renderBillingSummary(result);
            renderBillingTable(result.items || []);
            showBillingActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderBillingEmpty();
          })
          .aggregateBillingDataApi({
            company: company,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (billingResetBtn) {
      billingResetBtn.addEventListener('click', function() {
        billingCompanyInput.value = '';
        setBillingDefaultDates();
        billingState.currentData = null;
        renderBillingEmpty();
        hideBillingSummary();
        hideBillingActions();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderBillingSummary(data) {
      document.getElementById('billing-total-items').textContent = OB.formatNumber(data.totalItems || 0);
      document.getElementById('billing-total-order-qty').textContent = OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('billing-total-confirmed-qty').textContent = OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('billing-total-amount').textContent = 'â‚©' + OB.formatNumber(data.totalAmount || 0);

      billingSummary.classList.add('active');
    }

    function hideBillingSummary() {
      billingSummary.classList.remove('active');
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderBillingTable(items) {
      if (!items || items.length === 0) {
        renderBillingEmpty();
        return;
      }

      billingTbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.supplier || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyAmount || 0) + '</td>';

        billingTbody.appendChild(tr);
      });
    }

    function renderBillingEmpty() {
      billingTbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ê±°ë˜ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</td></tr>';
    }

    function showBillingActions() {
      billingActions.style.display = 'flex';
    }

    function hideBillingActions() {
      billingActions.style.display = 'none';
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    var billingExportXlsxBtn = document.getElementById('billing-export-xlsx');
    if (billingExportXlsxBtn) {
      billingExportXlsxBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        var csv = [];
        csv.push(['ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë§¤ì…ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ', 'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ê³µê¸‰ê°€', 'ê³µê¸‰ì•¡'].join(','));

        billingState.currentData.items.forEach(function(item) {
          var row = [
            item.orderCode || '',
            item.orderDate || '',
            item.supplier || '',
            item.brand || '',
            item.productName || '',
            item.productCode || '',
            item.orderQty || 0,
            item.confirmedQty || 0,
            item.supplyPrice || 0,
            item.supplyAmount || 0
          ];
          csv.push(row.join(','));
        });

        var csvContent = '\uFEFF' + csv.join('\n');
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);

        var fileName = 'ì²­êµ¬ì„œ_' + billingState.company + '_' +
          billingState.startDate.replace(/-/g, '') + '-' +
          billingState.endDate.replace(/-/g, '') + '.csv';

        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
      });
    }

    // PDF ì²­êµ¬ì„œ ìƒì„± (ê¸°ì¡´ ëª…ì„¸ì„œ í…œí”Œë¦¿ í™œìš©)
    var billingExportPdfBtn = document.getElementById('billing-export-pdf');
    if (billingExportPdfBtn) {
      billingExportPdfBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ìƒì„±í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        alert('PDF ì²­êµ¬ì„œ ìƒì„±ì€ ê¸°ì¡´ ëª…ì„¸ì„œ ì¶œë ¥ ê¸°ëŠ¥ì„ í™œìš©í•©ë‹ˆë‹¤.\në°œì£¼ë²ˆí˜¸ë³„ ì¶œë ¥ íƒ­ì—ì„œ í•´ë‹¹ ê±°ë˜ì²˜ì˜ ë°œì£¼ì„œë¥¼ ì„ íƒí•˜ì—¬ "ê±°ë˜ëª…ì„¸ì„œ" ìœ í˜•ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”.');
      });
    }

    // ì²­êµ¬ì„œ DB ì €ì¥ + ë°œí–‰
    var billingSaveDbBtn = document.getElementById('billing-save-db');
    if (billingSaveDbBtn) {
      billingSaveDbBtn.addEventListener('click', function() {
        if (!billingState.currentData || !billingState.currentData.items) {
          alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (!confirm('ì²­êµ¬ì„œë¥¼ DBì— ì €ì¥í•˜ê³  ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        var params = {
          settlementId: '',
          type: 'SALES',
          company: billingState.company,
          billingDate: new Date(),
          amount: billingState.currentData.totalAmount,
          notes: billingState.startDate + ' ~ ' + billingState.endDate + ' ì²­êµ¬'
        };

        OB.showLoading('ì²­êµ¬ì„œ ì €ì¥ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('ì²­êµ¬ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì²­êµ¬ID: ' + result.billingId);
            console.log('âœ… ì²­êµ¬ì„œ ì €ì¥ ì™„ë£Œ:', result.billingId);
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
          })
          .createBillingApi(params);
      });
    }

    console.log('âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… OrderList í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.initOrderListPage = function() {
    var wrap = document.querySelector('.orderlist-wrap');
    if (!wrap) {
      console.warn('OrderList wrapper not found');
      return;
    }

    if (wrap.dataset.bound === '1') {
      console.log('OrderList already initialized');
      return;
    }
    wrap.dataset.bound = '1';

    console.log('âœ… OrderList Page ì´ˆê¸°í™” ì™„ë£Œ');

    // DOM ìš”ì†Œ
    var btnSearch = document.getElementById('orderlist-btn-search');
    var btnReset = document.getElementById('orderlist-btn-reset');
    var btnExcel = document.getElementById('orderlist-btn-excel');
    var tbody = document.getElementById('orderlist-tbody');
    var resultCount = document.getElementById('orderlist-result-count');
    var pagination = document.getElementById('orderlist-pagination');
    var pageNumbers = document.getElementById('orderlist-page-numbers');
    var pageInfo = document.getElementById('orderlist-page-info');

    var modal = document.getElementById('orderlist-modal');
    var modalClose = document.getElementById('orderlist-modal-close');
    var modalTitle = document.getElementById('orderlist-modal-title');
    var modalBody = document.getElementById('orderlist-modal-body');
    var btnDelete = document.getElementById('orderlist-btn-delete');
    var btnSaveStatus = document.getElementById('orderlist-btn-save-status');

    // ìƒíƒœ ë³€ìˆ˜
    var currentOrders = [];
    var filteredOrders = [];
    var currentPage = 1;
    var itemsPerPage = 20;
    var currentSort = { column: null, direction: 'asc' };
    var currentOrderCode = null;

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
    setDefaultDates();

    function setDefaultDates() {
      var today = new Date();
      var thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);

      document.getElementById('orderlist-end-date').value = formatDateInput(today);
      document.getElementById('orderlist-start-date').value = formatDateInput(thirtyDaysAgo);
    }

    function formatDateInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ============================================================
    // ì¡°íšŒ ë²„íŠ¼
    // ============================================================
    if (btnSearch) {
      btnSearch.addEventListener('click', function() {
        var params = {
          startDate: document.getElementById('orderlist-start-date').value,
          endDate: document.getElementById('orderlist-end-date').value,
          orderCode: document.getElementById('orderlist-order-code').value,
          buyer: document.getElementById('orderlist-buyer').value,
          brand: document.getElementById('orderlist-brand').value,
          supplier: document.getElementById('orderlist-supplier').value
        };

        console.log('ğŸ” ë°œì£¼ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

        OB.showLoading('ë°œì£¼ ë‚´ì—­ ì¡°íšŒ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ë°œì£¼ ì¡°íšŒ ê²°ê³¼:', result);

            if (!result || !result.success) {
              alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            currentOrders = result.orders || [];
            filteredOrders = currentOrders.slice();
            currentPage = 1;
            renderOrders();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .getPrintableOrdersApi(params);
      });
    }

    // ============================================================
    // ì´ˆê¸°í™” ë²„íŠ¼
    // ============================================================
    if (btnReset) {
      btnReset.addEventListener('click', function() {
        document.getElementById('orderlist-start-date').value = '';
        document.getElementById('orderlist-end-date').value = '';
        document.getElementById('orderlist-order-code').value = '';
        document.getElementById('orderlist-buyer').value = '';
        document.getElementById('orderlist-brand').value = '';
        document.getElementById('orderlist-supplier').value = '';

        setDefaultDates();
        renderEmpty();
      });
    }

    // ============================================================
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    // ============================================================
    if (btnExcel) {
      btnExcel.addEventListener('click', function() {
        if (!filteredOrders || filteredOrders.length === 0) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        downloadCSV();
      });
    }

    function downloadCSV() {
      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      filteredOrders.forEach(function(order) {
        var row = [
          formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ë‚´ì—­_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filteredOrders.length + 'ê±´');
    }

    // ============================================================
    // ì •ë ¬ ê¸°ëŠ¥
    // ============================================================
    var sortableHeaders = document.querySelectorAll('.orderlist-table th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (currentSort.column === column) {
          // ê°™ì€ ì»¬ëŸ¼ í´ë¦­: ë°©í–¥ í† ê¸€
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          // ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­: ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        sortOrders(column, currentSort.direction);
        updateSortIndicators();
        currentPage = 1;
        renderOrders();
      });
    });

    function sortOrders(column, direction) {
      filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      sortableHeaders.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === currentSort.column) {
          header.classList.add(currentSort.direction);
        }
      });
    }

    // ============================================================
    // ë°œì£¼ ëª©ë¡ ë Œë”ë§ (í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨)
    // ============================================================
    function renderOrders() {
      tbody.innerHTML = '';

      if (!filteredOrders || filteredOrders.length === 0) {
        renderEmpty();
        pagination.style.display = 'none';
        return;
      }

      resultCount.textContent = 'ì´ ' + filteredOrders.length + 'ê±´';

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
      var startIdx = (currentPage - 1) * itemsPerPage;
      var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);
      var pageOrders = filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      pageOrders.forEach(function(order) {
        var tr = document.createElement('tr');
        tr.dataset.orderCode = order.orderCode;

        // ì§„í–‰ìƒíƒœ ì´ëª¨ì§€ ìƒì„± (ë§¤ì…ë°œì£¼, ë§¤ì…ê²°ì œ, ë§¤ì¶œê²°ì œ, ì¶œê³  ìˆœ)
        function getProgressStatus(order) {
          // ë§¤ì…ë°œì£¼: â³ë¯¸ì²˜ë¦¬ / âœ…ë°œì£¼ì™„ë£Œ
          var buyOrderEmoji = order.buyOrder === 'ë°œì£¼ì™„ë£Œ' ? 'âœ…' : 'â³';
          var buyOrderTitle = 'ë§¤ì…ë°œì£¼: ' + (order.buyOrder || 'ë¯¸ì²˜ë¦¬');

          // ë§¤ì…ê²°ì œ: âŒë¯¸ê²°ì œ / ğŸ”¸ë¶€ë¶„ê²°ì œ / âœ…ê²°ì œì™„ë£Œ
          var payBuyEmoji = order.payBuy === 'ê²°ì œì™„ë£Œ' ? 'âœ…' : (order.payBuy === 'ë¶€ë¶„ê²°ì œ' ? 'ğŸ”¸' : 'âŒ');
          var payBuyTitle = 'ë§¤ì…ê²°ì œ: ' + (order.payBuy || 'ë¯¸ê²°ì œ');

          // ë§¤ì¶œê²°ì œ: âŒë¯¸ê²°ì œ / ğŸ”¸ë¶€ë¶„ê²°ì œ / âœ…ê²°ì œì™„ë£Œ
          var paySellEmoji = order.paySell === 'ê²°ì œì™„ë£Œ' ? 'âœ…' : (order.paySell === 'ë¶€ë¶„ê²°ì œ' ? 'ğŸ”¸' : 'âŒ');
          var paySellTitle = 'ë§¤ì¶œê²°ì œ: ' + (order.paySell || 'ë¯¸ê²°ì œ');

          // ì¶œê³ : â¬œë¯¸ì¶œê³  / ğŸ“¦ë¶€ë¶„ì¶œê³  / âœ…ì¶œê³ ì™„ë£Œ
          var shipEmoji = order.ship === 'ì¶œê³ ì™„ë£Œ' ? 'âœ…' : (order.ship === 'ë¶€ë¶„ì¶œê³ ' ? 'ğŸ“¦' : 'â¬œ');
          var shipTitle = 'ì¶œê³ : ' + (order.ship || 'ë¯¸ì¶œê³ ');

          return '<div class="orderlist-progress-status">' +
            '<span title="' + buyOrderTitle + '">' + buyOrderEmoji + '</span>' +
            '<span title="' + payBuyTitle + '">' + payBuyEmoji + '</span>' +
            '<span title="' + paySellTitle + '">' + paySellEmoji + '</span>' +
            '<span title="' + shipTitle + '">' + shipEmoji + '</span>' +
            '</div>';
        }

        tr.innerHTML =
          '<td>' + formatDate(order.orderDate) + '</td>' +
          '<td><span class="orderlist-ordercode">' + (order.orderCode || '') + '</span></td>' +
          '<td>' + (order.buyer || '') + '</td>' +
          '<td>' + (order.brand || '') + '</td>' +
          '<td>' + (order.supplier || '') + '</td>' +
          '<td class="text-center">' + (order.itemCount || 0) + 'ê°œ</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalPurchaseAmount) + '</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalAmount) + '</td>' +
          '<td class="text-center">' + getProgressStatus(order) + '</td>';

        tr.addEventListener('click', function() {
          loadOrderDetail(order.orderCode);
        });

        tbody.appendChild(tr);
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      if (totalPages > 1) {
        renderPagination(totalPages);
        pagination.style.display = 'flex';
      } else {
        pagination.style.display = 'none';
      }
    }

    // ============================================================
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    // ============================================================
    function renderPagination(totalPages) {
      var btnFirst = document.getElementById('orderlist-page-first');
      var btnPrev = document.getElementById('orderlist-page-prev');
      var btnNext = document.getElementById('orderlist-page-next');
      var btnLast = document.getElementById('orderlist-page-last');

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = currentPage === 1;
      btnPrev.disabled = currentPage === 1;
      btnNext.disabled = currentPage === totalPages;
      btnLast.disabled = currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'orderlist-page-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (currentPage - 1) * itemsPerPage + 1;
      var endIdx = Math.min(currentPage * itemsPerPage, filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (currentPage > 1) { currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (currentPage < totalPages) { currentPage++; renderOrders(); } };
      btnLast.onclick = function() { currentPage = totalPages; renderOrders(); };
    }

    // ============================================================
    // ë¹ˆ í…Œì´ë¸” ë Œë”ë§
    // ============================================================
    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="9" class="orderlist-empty">' +
        '<div class="orderlist-empty-icon">ğŸ“‹</div>' +
        '<div class="orderlist-empty-text">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' +
        '</td></tr>';

      resultCount.textContent = 'ì¡°íšŒ ê²°ê³¼ ì—†ìŒ';
      currentOrders = [];
      filteredOrders = [];
      pagination.style.display = 'none';
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ì¡°íšŒ
    // ============================================================
    function loadOrderDetail(orderCode) {
      console.log('ğŸ“¦ ë°œì£¼ ìƒì„¸ ì¡°íšŒ:', orderCode);
      currentOrderCode = orderCode;

      OB.showLoading('ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('âœ… ë°œì£¼ ìƒì„¸ ê²°ê³¼:', result);

          if (!result || !result.success) {
            alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderOrderDetail(orderCode, result.orderItems || []);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ë°œì£¼ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getOrderDetailApi(orderCode);
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ëª¨ë‹¬ ë Œë”ë§
    // ============================================================
    function renderOrderDetail(orderCode, items) {
      if (!items || items.length === 0) {
        alert('í•´ë‹¹ ë°œì£¼ì˜ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var firstItem = items[0];

      modalTitle.textContent = 'ë°œì£¼ ìƒì„¸ - ' + orderCode;

      var html = '';

      // ê¸°ë³¸ ì •ë³´
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ê¸°ë³¸ ì •ë³´</div>';
      html += '<div class="orderlist-detail-grid">';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ë²ˆí˜¸</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ë²ˆí˜¸'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì¼</div><div class="orderlist-detail-value">' + formatDate(firstItem['ë°œì£¼ì¼']) + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë¸Œëœë“œ</div><div class="orderlist-detail-value">' + (firstItem['ë¸Œëœë“œ'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë§¤ì…ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë§¤ì…ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ì¶œê³ ìƒíƒœ</div><div class="orderlist-detail-value">' + (firstItem['ì¶œê³ '] || 'ë¯¸ì¶œê³ ') + '</div></div>';
      html += '</div>';
      html += '</div>';

      // ìƒíƒœ ìˆ˜ì • í¼ (ìˆœì„œ: ë§¤ì…ë°œì£¼ â†’ ë§¤ì…ê²°ì œ â†’ ë§¤ì¶œê²°ì œ â†’ ì¶œê³ ìƒíƒœ)
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ìƒíƒœ ê´€ë¦¬</div>';
      html += '<div class="orderlist-status-form">';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì… ë°œì£¼</label>';
      html += '<select id="orderlist-status-buy-order" class="orderlist-status-select">';
      html += '<option value="ë¯¸ì²˜ë¦¬"' + (firstItem['ë§¤ì…ë°œì£¼'] === 'ë¯¸ì²˜ë¦¬' || !firstItem['ë§¤ì…ë°œì£¼'] ? ' selected' : '') + '>â³ ë¯¸ì²˜ë¦¬</option>';
      html += '<option value="ë°œì£¼ì™„ë£Œ"' + (firstItem['ë§¤ì…ë°œì£¼'] === 'ë°œì£¼ì™„ë£Œ' ? ' selected' : '') + '>âœ… ë°œì£¼ì™„ë£Œ</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì… ê²°ì œ</label>';
      html += '<select id="orderlist-status-pay-buy" class="orderlist-status-select">';
      html += '<option value="ë¯¸ê²°ì œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ë¯¸ê²°ì œ' || !firstItem['ë§¤ì…ê²°ì œ'] ? ' selected' : '') + '>âŒ ë¯¸ê²°ì œ</option>';
      html += '<option value="ë¶€ë¶„ê²°ì œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ë¶€ë¶„ê²°ì œ' ? ' selected' : '') + '>ğŸ”¸ ë¶€ë¶„ê²°ì œ</option>';
      html += '<option value="ê²°ì œì™„ë£Œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ê²°ì œì™„ë£Œ' ? ' selected' : '') + '>âœ… ê²°ì œì™„ë£Œ</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì¶œ ê²°ì œ</label>';
      html += '<select id="orderlist-status-pay-sell" class="orderlist-status-select">';
      html += '<option value="ë¯¸ê²°ì œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ë¯¸ê²°ì œ' || !firstItem['ë§¤ì¶œê²°ì œ'] ? ' selected' : '') + '>âŒ ë¯¸ê²°ì œ</option>';
      html += '<option value="ë¶€ë¶„ê²°ì œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ë¶€ë¶„ê²°ì œ' ? ' selected' : '') + '>ğŸ”¸ ë¶€ë¶„ê²°ì œ</option>';
      html += '<option value="ê²°ì œì™„ë£Œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ê²°ì œì™„ë£Œ' ? ' selected' : '') + '>âœ… ê²°ì œì™„ë£Œ</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ì¶œê³  ìƒíƒœ</label>';
      html += '<select id="orderlist-status-ship" class="orderlist-status-select">';
      html += '<option value="ë¯¸ì¶œê³ "' + (firstItem['ì¶œê³ '] === 'ë¯¸ì¶œê³ ' || !firstItem['ì¶œê³ '] ? ' selected' : '') + '>â¬œ ë¯¸ì¶œê³ </option>';
      html += '<option value="ë¶€ë¶„ì¶œê³ "' + (firstItem['ì¶œê³ '] === 'ë¶€ë¶„ì¶œê³ ' ? ' selected' : '') + '>ğŸ“¦ ë¶€ë¶„ì¶œê³ </option>';
      html += '<option value="ì¶œê³ ì™„ë£Œ"' + (firstItem['ì¶œê³ '] === 'ì¶œê³ ì™„ë£Œ' ? ' selected' : '') + '>âœ… ì¶œê³ ì™„ë£Œ</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // í’ˆëª© ëª©ë¡
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">';
      html += 'í’ˆëª© ëª©ë¡ (' + items.length + 'ê°œ)';
      html += '<button type="button" id="btn-save-confirmed-qty" class="orderlist-btn-save-qty" style="margin-left: 10px; padding: 4px 10px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">í™•ì •ìˆ˜ëŸ‰ ì €ì¥</button>';
      html += '</div>';
      html += '<table class="orderlist-detail-table">';
      html += '<thead><tr>';
      html += '<th>ì œí’ˆëª…</th>';
      html += '<th>í’ˆëª©ì½”ë“œ</th>';
      html += '<th class="text-right">ë°œì£¼ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">í™•ì •ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">ë§¤ì…ê°€</th>';
      html += '<th class="text-right">ê³µê¸‰ê°€</th>';
      html += '<th class="text-right">ë§¤ì…ì•¡</th>';
      html += '<th class="text-right">ê³µê¸‰ì•¡</th>';
      html += '<th class="text-right">ë§ˆì§„ì•¡</th>';
      html += '<th class="text-right">ë§ˆì§„ìœ¨</th>';
      html += '</tr></thead>';
      html += '<tbody>';

      var totalPurchaseAmount = 0;
      var totalSupplyAmount = 0;
      var totalMarginAmount = 0;

      items.forEach(function(item, idx) {
        var purchaseAmount = Number(item['ë§¤ì…ì•¡'] || 0);
        var supplyAmount = Number(item['ê³µê¸‰ì•¡'] || 0);
        var marginAmount = Number(item['ë§ˆì§„ì•¡'] || (supplyAmount - purchaseAmount));
        var marginRate = purchaseAmount > 0 ? ((marginAmount / purchaseAmount) * 100).toFixed(1) : 0;
        var confirmedQty = Number(item['í™•ì •ìˆ˜ëŸ‰'] || item['ë°œì£¼ìˆ˜ëŸ‰'] || 0);
        var rowIndex = item['_rowIndex'] || '';

        totalPurchaseAmount += purchaseAmount;
        totalSupplyAmount += supplyAmount;
        totalMarginAmount += marginAmount;

        html += '<tr data-row-index="' + rowIndex + '">';
        html += '<td>' + (item['ì œí’ˆëª…'] || '') + '</td>';
        html += '<td>' + (item['í’ˆëª©ì½”ë“œ'] || '') + '</td>';
        html += '<td class="text-right">' + formatNumber(item['ë°œì£¼ìˆ˜ëŸ‰']) + '</td>';
        html += '<td class="text-right"><input type="number" class="confirmed-qty-input" value="' + confirmedQty + '" data-row="' + rowIndex + '" data-buy-price="' + (item['ë§¤ì…ê°€'] || 0) + '" data-supply-price="' + (item['ê³µê¸‰ê°€'] || 0) + '" style="width: 60px; text-align: right; padding: 2px 4px; border: 1px solid #d1d5db; border-radius: 3px;" /></td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ë§¤ì…ê°€']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ê³µê¸‰ê°€']) + '</td>';
        html += '<td class="text-right purchase-amount">â‚©' + formatNumber(purchaseAmount) + '</td>';
        html += '<td class="text-right supply-amount">â‚©' + formatNumber(supplyAmount) + '</td>';
        html += '<td class="text-right margin-amount" style="color: ' + (marginAmount >= 0 ? '#059669' : '#dc2626') + ';">â‚©' + formatNumber(marginAmount) + '</td>';
        html += '<td class="text-right margin-rate" style="color: ' + (marginAmount >= 0 ? '#059669' : '#dc2626') + ';">' + marginRate + '%</td>';
        html += '</tr>';
      });

      var totalMarginRate = totalPurchaseAmount > 0 ? ((totalMarginAmount / totalPurchaseAmount) * 100).toFixed(1) : 0;

      html += '</tbody>';
      html += '<tfoot>';
      html += '<tr style="font-weight: 700; background: #f9fafb;">';
      html += '<td colspan="6" class="text-right">í•©ê³„</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalPurchaseAmount) + '</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalSupplyAmount) + '</td>';
      html += '<td class="text-right" style="color: ' + (totalMarginAmount >= 0 ? '#059669' : '#dc2626') + ';">â‚©' + formatNumber(totalMarginAmount) + '</td>';
      html += '<td class="text-right" style="color: ' + (totalMarginAmount >= 0 ? '#059669' : '#dc2626') + ';">' + totalMarginRate + '%</td>';
      html += '</tr>';
      html += '</tfoot>';
      html += '</table>';
      html += '</div>';

      modalBody.innerHTML = html;
      modal.classList.add('show');

      // í™•ì •ìˆ˜ëŸ‰ ì…ë ¥ ì‹œ ê¸ˆì•¡ ì‹¤ì‹œê°„ ê³„ì‚°
      var qtyInputs = modalBody.querySelectorAll('.confirmed-qty-input');
      qtyInputs.forEach(function(input) {
        input.addEventListener('input', function() {
          var tr = this.closest('tr');
          var qty = Number(this.value) || 0;
          var buyPrice = Number(this.dataset.buyPrice) || 0;
          var supplyPrice = Number(this.dataset.supplyPrice) || 0;

          var purchaseAmt = qty * buyPrice;
          var supplyAmt = qty * supplyPrice;
          var marginAmt = supplyAmt - purchaseAmt;
          var marginRt = purchaseAmt > 0 ? ((marginAmt / purchaseAmt) * 100).toFixed(1) : 0;

          tr.querySelector('.purchase-amount').textContent = 'â‚©' + formatNumber(purchaseAmt);
          tr.querySelector('.supply-amount').textContent = 'â‚©' + formatNumber(supplyAmt);
          tr.querySelector('.margin-amount').textContent = 'â‚©' + formatNumber(marginAmt);
          tr.querySelector('.margin-amount').style.color = marginAmt >= 0 ? '#059669' : '#dc2626';
          tr.querySelector('.margin-rate').textContent = marginRt + '%';
          tr.querySelector('.margin-rate').style.color = marginAmt >= 0 ? '#059669' : '#dc2626';
        });
      });

      // í™•ì •ìˆ˜ëŸ‰ ì €ì¥ ë²„íŠ¼
      var btnSaveQty = document.getElementById('btn-save-confirmed-qty');
      if (btnSaveQty) {
        btnSaveQty.addEventListener('click', function() {
          var updates = [];
          qtyInputs.forEach(function(input) {
            var rowIndex = Number(input.dataset.row);
            var qty = Number(input.value) || 0;
            if (rowIndex > 0) {
              updates.push({ rowIndex: rowIndex, confirmedQty: qty });
            }
          });

          if (updates.length === 0) {
            alert('ì €ì¥í•  í™•ì •ìˆ˜ëŸ‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          if (!confirm(updates.length + 'ê°œ í’ˆëª©ì˜ í™•ì •ìˆ˜ëŸ‰ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
          }

          OB.showLoading('í™•ì •ìˆ˜ëŸ‰ ì €ì¥ ì¤‘...');

          google.script.run
            .withSuccessHandler(function(result) {
              OB.hideLoading();
              if (!result || !result.success) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                return;
              }
              alert('âœ… í™•ì •ìˆ˜ëŸ‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.updatedCount + 'ê±´)');
              // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
              loadOrderDetail(currentOrderCode);
            })
            .withFailureHandler(function(error) {
              OB.hideLoading();
              alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            })
            .updateConfirmedQuantitiesApi({ updates: updates });
        });
      }
    }

    // ============================================================
    // ìƒíƒœ ì €ì¥ (4ê°œ ìƒíƒœ ëª¨ë‘ ì €ì¥)
    // ============================================================
    if (btnSaveStatus) {
      btnSaveStatus.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // 4ê°œ ìƒíƒœ ê°’ ìˆ˜ì§‘
        var statuses = {
          buyOrder: document.getElementById('orderlist-status-buy-order').value,
          payBuy: document.getElementById('orderlist-status-pay-buy').value,
          paySell: document.getElementById('orderlist-status-pay-sell').value,
          ship: document.getElementById('orderlist-status-ship').value
        };

        var statusSummary = 'ë§¤ì…ë°œì£¼: ' + statuses.buyOrder + '\n' +
                           'ë§¤ì…ê²°ì œ: ' + statuses.payBuy + '\n' +
                           'ë§¤ì¶œê²°ì œ: ' + statuses.paySell + '\n' +
                           'ì¶œê³ ìƒíƒœ: ' + statuses.ship;

        if (!confirm('ë‹¤ìŒê³¼ ê°™ì´ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' + statusSummary)) {
          return;
        }

        OB.showLoading('ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.updated + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
          })
          .updateOrderStatus(currentOrderCode, statuses);
      });
    }

    // ============================================================
    // ë°œì£¼ ì‚­ì œ
    // ============================================================
    if (btnDelete) {
      btnDelete.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (!confirm('âš ï¸ ì •ë§ë¡œ ë°œì£¼ë²ˆí˜¸ "' + currentOrderCode + '"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
          return;
        }

        if (!confirm('âš ï¸âš ï¸ ìµœì¢… í™•ì¸: ë°œì£¼ì™€ ê´€ë ¨ëœ ëª¨ë“  í’ˆëª© ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        OB.showLoading('ë°œì£¼ ì‚­ì œ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ë°œì£¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.deleted + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
          })
          .deleteOrder(currentOrderCode);
      });
    }

    // ============================================================
    // ëª¨ë‹¬ ë‹«ê¸°
    // ============================================================
    if (modalClose) {
      modalClose.addEventListener('click', function() {
        modal.classList.remove('show');
      });
    }

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // ============================================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================================
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    function formatDate(date) {
      if (!date) return '';
      if (typeof date === 'string') {
        if (date.match(/^\d{4}-\d{2}-\d{2}$/)) return date;
      }

      var d = new Date(date);
      if (isNaN(d.getTime())) return '';

      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');

      return year + '-' + month + '-' + day;
    }

    console.log('âœ… OrderList ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.purchaseSettlementState = {
    currentData: null,
    supplier: '',
    startDate: '',
    endDate: ''
  };

  OB.initPurchaseSettlementPage = function() {
    console.log('ğŸ”§ PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.purchaseSettlementState;

    // DOM ìš”ì†Œ
    var supplierInput = document.getElementById('purchase-settlement-supplier');
    var startDateInput = document.getElementById('purchase-settlement-start-date');
    var endDateInput = document.getElementById('purchase-settlement-end-date');
    var searchBtn = document.getElementById('purchase-settlement-search-btn');
    var resetBtn = document.getElementById('purchase-settlement-reset-btn');
    var tbody = document.getElementById('purchase-settlement-tbody');
    var summaryDiv = document.getElementById('purchase-settlement-summary');
    var actionsDiv = document.getElementById('purchase-settlement-actions');

    var saveDraftBtn = document.getElementById('purchase-settlement-save-draft-btn');
    var confirmBtn = document.getElementById('purchase-settlement-confirm-btn');
    var exportBtn = document.getElementById('purchase-settlement-export-btn');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultDates();

    function setDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');

      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      startDateInput.value = firstDay;
      endDateInput.value = lastDayStr;
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        var supplier = supplierInput.value.trim();
        var startDate = startDateInput.value;
        var endDate = endDateInput.value;

        if (!startDate || !endDate) {
          alert('ë§ˆê° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.supplier = supplier;
        state.startDate = startDate;
        state.endDate = endDate;

        console.log('ğŸ“‹ ë§¤ì… ë§ˆê° ì¡°íšŒ:', {supplier: supplier || 'ì „ì²´', startDate, endDate});

        OB.showLoading('ë§¤ì… ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ì§‘ê³„ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            state.currentData = result;
            renderSummary(result);
            renderTable(result.items || []);
            showActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ì§‘ê³„ ì‹¤íŒ¨:', error);
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .aggregatePurchaseOrdersApi({
            supplier: supplier,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        supplierInput.value = '';
        setDefaultDates();
        state.currentData = null;
        renderEmpty();
        hideActions();
        hideSummary();
      });
    }

    // ì„ì‹œì €ì¥ ë²„íŠ¼
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', function() {
        saveSettlement('DRAFT');
      });
    }

    // í™•ì • ë²„íŠ¼
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        if (!confirm('ë§ˆê°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }
        saveSettlement('CONFIRMED');
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    if (exportBtn) {
      exportBtn.addEventListener('click', function() {
        downloadExcel();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderSummary(data) {
      document.getElementById('purchase-settlement-total-items').textContent =
        OB.formatNumber(data.totalItems || 0);
      document.getElementById('purchase-settlement-total-order-qty').textContent =
        OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('purchase-settlement-total-confirmed-qty').textContent =
        OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('purchase-settlement-diff-qty').textContent =
        OB.formatNumber(data.diffQty || 0);
      document.getElementById('purchase-settlement-total-amount').textContent =
        'â‚©' + OB.formatNumber(data.totalPurchaseAmount || 0);

      summaryDiv.style.display = 'grid';
    }

    function hideSummary() {
      summaryDiv.style.display = 'none';
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(items) {
      if (!items || items.length === 0) {
        renderEmpty();
        return;
      }

      tbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');

        var diffQty = item.diffQty || 0;
        var diffClass = diffQty !== 0 ? 'diff' : '';

        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.buyer || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num ' + diffClass + '">' + OB.formatNumber(diffQty) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.buyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.purchaseAmount || 0) + '</td>';

        tbody.appendChild(tr);
      });
    }

    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="11" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë§¤ì…ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</div>' +
        '</td></tr>';
    }

    function showActions() {
      actionsDiv.style.display = 'flex';
    }

    function hideActions() {
      actionsDiv.style.display = 'none';
    }

    // ë§ˆê° ì €ì¥
    function saveSettlement(status) {
      if (!state.currentData || !state.currentData.items) {
        alert('ì§‘ê³„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var params = {
        supplier: state.supplier,
        startDate: state.startDate,
        endDate: state.endDate,
        status: status,
        items: state.currentData.items,
        notes: ''
      };

      OB.showLoading('ë§ˆê° ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert(result.message || 'ì €ì¥ ì™„ë£Œ');
          console.log('âœ… ë§ˆê° ì €ì¥ ì™„ë£Œ:', result.settlementId);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        })
        .savePurchaseSettlementApi(params);
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadExcel() {
      if (!state.currentData || !state.currentData.items) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push([
        'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ',
        'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ì°¨ì´', 'ë§¤ì…ê°€', 'ë§¤ì…ì•¡'
      ].join(','));

      // ë°ì´í„°
      state.currentData.items.forEach(function(item) {
        var row = [
          item.orderCode || '',
          item.orderDate || '',
          item.buyer || '',
          item.brand || '',
          item.productName || '',
          item.productCode || '',
          item.orderQty || 0,
          item.confirmedQty || 0,
          item.diffQty || 0,
          item.buyPrice || 0,
          item.purchaseAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      var fileName = 'ë§¤ì…ë§ˆê°_' + state.supplier + '_' +
        state.startDate.replace(/-/g, '') + '-' +
        state.endDate.replace(/-/g, '') + '.csv';

      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }

    // ============================================================
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    // ============================================================
    var tabs = document.querySelectorAll('.settlement-wrap .settlement-tab');
    var tabContents = {
      'new': document.getElementById('purchase-settlement-tab-new'),
      'history': document.getElementById('purchase-settlement-tab-history')
    };

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var targetTab = this.dataset.tab;

        // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        tabs.forEach(function(t) { t.classList.remove('active'); });
        this.classList.add('active');

        // íƒ­ ë‚´ìš© ì „í™˜
        Object.keys(tabContents).forEach(function(key) {
          if (tabContents[key]) {
            tabContents[key].style.display = key === targetTab ? 'block' : 'none';
            tabContents[key].classList.toggle('active', key === targetTab);
          }
        });
      });
    });

    // ============================================================
    // ë§ˆê° ë‚´ì—­ ì¡°íšŒ ê¸°ëŠ¥
    // ============================================================
    var loadHistoryBtn = document.getElementById('purchase-settlement-load-history-btn');
    var historyTbody = document.getElementById('purchase-settlement-history-tbody');

    if (loadHistoryBtn) {
      loadHistoryBtn.addEventListener('click', function() {
        OB.showLoading('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderHistoryEmpty();
              return;
            }

            renderHistoryTable(result.settlements || []);
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            renderHistoryEmpty();
          })
          .getPurchaseSettlementsApi({ type: 'PURCHASE' });
      });
    }

    function renderHistoryEmpty() {
      historyTbody.innerHTML =
        '<tr><td colspan="8" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë§ˆê° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
        '</td></tr>';
    }

    function renderHistoryTable(settlements) {
      if (!settlements || settlements.length === 0) {
        renderHistoryEmpty();
        return;
      }

      var html = '';
      settlements.forEach(function(s) {
        var statusClass = s.status === 'CONFIRMED' ? 'confirmed' : 'draft';
        var statusText = s.status === 'CONFIRMED' ? 'í™•ì •' : 'ì„ì‹œì €ì¥';

        html += '<tr>';
        html += '<td>' + (s.settlementId || '') + '</td>';
        html += '<td>' + OB.formatDate(s.createdAt) + '</td>';
        html += '<td>' + (s.supplier || s.partnerName || 'ì „ì²´') + '</td>';
        html += '<td>' + (s.startDate || '') + ' ~ ' + (s.endDate || '') + '</td>';
        html += '<td class="num">' + OB.formatNumber(s.totalItems || 0) + '</td>';
        html += '<td class="num">â‚©' + OB.formatNumber(s.totalAmount || 0) + '</td>';
        html += '<td><span class="settlement-status-badge ' + statusClass + '">' + statusText + '</span></td>';
        html += '<td><button class="settlement-btn secondary" style="padding:4px 8px;font-size:12px;" onclick="OB.viewSettlementDetail(\'' + s.settlementId + '\', \'PURCHASE\')">ìƒì„¸</button></td>';
        html += '</tr>';
      });

      historyTbody.innerHTML = html;
    }

    console.log('âœ… PurchaseSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ë§¤ì¶œ ë§ˆê° í˜ì´ì§€
  // ========================================

  OB.salesSettlementState = {
    currentData: null,
    buyer: '',
    startDate: '',
    endDate: ''
  };

  OB.initSalesSettlementPage = function() {
    console.log('ğŸ”§ SalesSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.salesSettlementState;

    // DOM ìš”ì†Œ
    var buyerInput = document.getElementById('sales-settlement-buyer');
    var startDateInput = document.getElementById('sales-settlement-start-date');
    var endDateInput = document.getElementById('sales-settlement-end-date');
    var searchBtn = document.getElementById('sales-settlement-search-btn');
    var resetBtn = document.getElementById('sales-settlement-reset-btn');
    var tbody = document.getElementById('sales-settlement-tbody');
    var summaryDiv = document.getElementById('sales-settlement-summary');
    var actionsDiv = document.getElementById('sales-settlement-actions');

    var saveDraftBtn = document.getElementById('sales-settlement-save-draft-btn');
    var confirmBtn = document.getElementById('sales-settlement-confirm-btn');
    var exportBtn = document.getElementById('sales-settlement-export-btn');

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultDates();

    function setDefaultDates() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');

      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');

      startDateInput.value = firstDay;
      endDateInput.value = lastDayStr;
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        var buyer = buyerInput.value.trim();
        var startDate = startDateInput.value;
        var endDate = endDateInput.value;

        if (!startDate || !endDate) {
          alert('ë§ˆê° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.buyer = buyer;
        state.startDate = startDate;
        state.endDate = endDate;

        console.log('ğŸ“‹ ë§¤ì¶œ ë§ˆê° ì¡°íšŒ:', {buyer: buyer || 'ì „ì²´', startDate, endDate});

        OB.showLoading('ë§¤ì¶œ ë°ì´í„° ì§‘ê³„ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ì§‘ê³„ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            state.currentData = result;
            renderSummary(result);
            renderTable(result.items || []);
            showActions();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ì§‘ê³„ ì‹¤íŒ¨:', error);
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .aggregateSalesOrdersApi({
            buyer: buyer,
            startDate: startDate,
            endDate: endDate
          });
      });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        buyerInput.value = '';
        setDefaultDates();
        state.currentData = null;
        renderEmpty();
        hideActions();
        hideSummary();
      });
    }

    // ì„ì‹œì €ì¥ ë²„íŠ¼
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', function() {
        saveSettlement('DRAFT');
      });
    }

    // í™•ì • ë²„íŠ¼
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        if (!confirm('ë§ˆê°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }
        saveSettlement('CONFIRMED');
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    if (exportBtn) {
      exportBtn.addEventListener('click', function() {
        downloadExcel();
      });
    }

    // ìš”ì•½ ë Œë”ë§
    function renderSummary(data) {
      document.getElementById('sales-settlement-total-items').textContent =
        OB.formatNumber(data.totalItems || 0);
      document.getElementById('sales-settlement-total-order-qty').textContent =
        OB.formatNumber(data.totalOrderQty || 0);
      document.getElementById('sales-settlement-total-confirmed-qty').textContent =
        OB.formatNumber(data.totalConfirmedQty || 0);
      document.getElementById('sales-settlement-diff-qty').textContent =
        OB.formatNumber(data.diffQty || 0);
      document.getElementById('sales-settlement-total-amount').textContent =
        'â‚©' + OB.formatNumber(data.totalSupplyAmount || 0);

      summaryDiv.style.display = 'grid';
    }

    function hideSummary() {
      summaryDiv.style.display = 'none';
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(items) {
      if (!items || items.length === 0) {
        renderEmpty();
        return;
      }

      tbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');

        var diffQty = item.diffQty || 0;
        var diffClass = diffQty !== 0 ? 'diff' : '';

        tr.innerHTML =
          '<td>' + (item.orderCode || '') + '</td>' +
          '<td>' + (item.orderDate || '') + '</td>' +
          '<td>' + (item.supplier || '') + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.productCode || '') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
          '<td class="num ' + diffClass + '">' + OB.formatNumber(diffQty) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyPrice || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(item.supplyAmount || 0) + '</td>';

        tbody.appendChild(tr);
      });
    }

    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="11" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë°œì£¼ì²˜ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</div>' +
        '</td></tr>';
    }

    function showActions() {
      actionsDiv.style.display = 'flex';
    }

    function hideActions() {
      actionsDiv.style.display = 'none';
    }

    // ë§ˆê° ì €ì¥
    function saveSettlement(status) {
      if (!state.currentData || !state.currentData.items) {
        alert('ì§‘ê³„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var params = {
        buyer: state.buyer,
        startDate: state.startDate,
        endDate: state.endDate,
        status: status,
        items: state.currentData.items,
        notes: ''
      };

      OB.showLoading('ë§ˆê° ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert(result.message || 'ì €ì¥ ì™„ë£Œ');
          console.log('âœ… ë§ˆê° ì €ì¥ ì™„ë£Œ:', result.settlementId);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        })
        .saveSalesSettlementApi(params);
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadExcel() {
      if (!state.currentData || !state.currentData.items) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push([
        'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì¼', 'ë§¤ì…ì²˜', 'ë¸Œëœë“œ', 'ì œí’ˆëª…', 'í’ˆëª©ì½”ë“œ',
        'ë°œì£¼ìˆ˜ëŸ‰', 'í™•ì •ìˆ˜ëŸ‰', 'ì°¨ì´', 'ë§¤ì¶œê°€', 'ë§¤ì¶œì•¡'
      ].join(','));

      // ë°ì´í„°
      state.currentData.items.forEach(function(item) {
        var row = [
          item.orderCode || '',
          item.orderDate || '',
          item.supplier || '',
          item.brand || '',
          item.productName || '',
          item.productCode || '',
          item.orderQty || 0,
          item.confirmedQty || 0,
          item.diffQty || 0,
          item.supplyPrice || 0,
          item.supplyAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      var fileName = 'ë§¤ì¶œë§ˆê°_' + state.buyer + '_' +
        state.startDate.replace(/-/g, '') + '-' +
        state.endDate.replace(/-/g, '') + '.csv';

      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }

    // ============================================================
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    // ============================================================
    var tabs = document.querySelectorAll('.settlement-wrap .settlement-tab');
    var tabContents = {
      'new': document.getElementById('sales-settlement-tab-new'),
      'history': document.getElementById('sales-settlement-tab-history')
    };

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var targetTab = this.dataset.tab;

        // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        tabs.forEach(function(t) { t.classList.remove('active'); });
        this.classList.add('active');

        // íƒ­ ë‚´ìš© ì „í™˜
        Object.keys(tabContents).forEach(function(key) {
          if (tabContents[key]) {
            tabContents[key].style.display = key === targetTab ? 'block' : 'none';
            tabContents[key].classList.toggle('active', key === targetTab);
          }
        });
      });
    });

    // ============================================================
    // ë§ˆê° ë‚´ì—­ ì¡°íšŒ ê¸°ëŠ¥
    // ============================================================
    var loadHistoryBtn = document.getElementById('sales-settlement-load-history-btn');
    var historyTbody = document.getElementById('sales-settlement-history-tbody');

    if (loadHistoryBtn) {
      loadHistoryBtn.addEventListener('click', function() {
        OB.showLoading('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì™„ë£Œ:', result);

            if (!result || !result.success) {
              alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderHistoryEmpty();
              return;
            }

            renderHistoryTable(result.settlements || []);
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            renderHistoryEmpty();
          })
          .getSalesSettlementsApi({ type: 'SALES' });
      });
    }

    function renderHistoryEmpty() {
      historyTbody.innerHTML =
        '<tr><td colspan="8" class="settlement-empty">' +
        '<div class="settlement-empty-icon">ğŸ“‹</div>' +
        '<div class="settlement-empty-text">ë§ˆê° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
        '</td></tr>';
    }

    function renderHistoryTable(settlements) {
      if (!settlements || settlements.length === 0) {
        renderHistoryEmpty();
        return;
      }

      var html = '';
      settlements.forEach(function(s) {
        var statusClass = s.status === 'CONFIRMED' ? 'confirmed' : 'draft';
        var statusText = s.status === 'CONFIRMED' ? 'í™•ì •' : 'ì„ì‹œì €ì¥';

        html += '<tr>';
        html += '<td>' + (s.settlementId || '') + '</td>';
        html += '<td>' + OB.formatDate(s.createdAt) + '</td>';
        html += '<td>' + (s.buyer || s.partnerName || 'ì „ì²´') + '</td>';
        html += '<td>' + (s.startDate || '') + ' ~ ' + (s.endDate || '') + '</td>';
        html += '<td class="num">' + OB.formatNumber(s.totalItems || 0) + '</td>';
        html += '<td class="num">â‚©' + OB.formatNumber(s.totalAmount || 0) + '</td>';
        html += '<td><span class="settlement-status-badge ' + statusClass + '">' + statusText + '</span></td>';
        html += '<td><button class="settlement-btn secondary" style="padding:4px 8px;font-size:12px;" onclick="OB.viewSettlementDetail(\'' + s.settlementId + '\', \'SALES\')">ìƒì„¸</button></td>';
        html += '</tr>';
      });

      historyTbody.innerHTML = html;
    }

    console.log('âœ… SalesSettlement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ì›”ë³„ ë§ˆê° í˜ì´ì§€
  // ========================================

  OB.monthlyClosingState = {
    currentMonth: '',
    currentStatus: null,
    closingsList: []
  };

  OB.initMonthlyClosingPage = function() {
    console.log('ğŸ”§ MonthlyClosing í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.monthlyClosingState;

    // DOM ìš”ì†Œ
    var monthInput = document.getElementById('monthly-closing-month');
    var checkBtn = document.getElementById('monthly-closing-check-btn');
    var executeBtn = document.getElementById('monthly-closing-execute-btn');
    var unlockBtn = document.getElementById('monthly-closing-unlock-btn');
    var statusDiv = document.getElementById('monthly-closing-status');
    var tbody = document.getElementById('monthly-closing-tbody');

    // ê¸°ë³¸ ì›” ì„¤ì • (ì´ë²ˆ ë‹¬)
    setDefaultMonth();

    function setDefaultMonth() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      monthInput.value = year + '-' + month;
    }

    // ì „ì²´ ë§ˆê° ë‚´ì—­ ë¡œë“œ
    loadAllClosings();

    function loadAllClosings() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.success) {
            console.error('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', result);
            return;
          }

          state.closingsList = result.closings || [];
          renderClosingsTable(state.closingsList);
        })
        .withFailureHandler(function(error) {
          console.error('ë§ˆê° ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
        })
        .getMonthlyClosingsApi();
    }

    // ì¡°íšŒ ë²„íŠ¼
    if (checkBtn) {
      checkBtn.addEventListener('click', function() {
        var month = monthInput.value;
        if (!month) {
          alert('ë§ˆê° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        state.currentMonth = month.replace('-', '');
        checkMonthStatus(state.currentMonth);
      });
    }

    // ë§ˆê° ì‹¤í–‰ ë²„íŠ¼
    if (executeBtn) {
      executeBtn.addEventListener('click', function() {
        if (!confirm('ì›” ë§ˆê°ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në§ˆê° í›„ì—ëŠ” í•´ë‹¹ ì›”ì˜ CONFIRMED ìƒíƒœì¸ ëª¨ë“  ë§ˆê°ì´ LOCKED ë©ë‹ˆë‹¤.')) {
          return;
        }

        OB.showLoading('ì›” ë§ˆê° ì‹¤í–‰ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ë§ˆê° ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert(result.message || 'ì›” ë§ˆê° ì™„ë£Œ');
            console.log('âœ… ì›” ë§ˆê° ì™„ë£Œ:', result);

            // ìƒíƒœ ë‹¤ì‹œ ì¡°íšŒ
            checkMonthStatus(state.currentMonth);
            loadAllClosings();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë§ˆê° ì‹¤íŒ¨:', error);
            alert('ë§ˆê° ì‹¤íŒ¨: ' + error.message);
          })
          .executeMonthlyClosingApi({
            yearMonth: state.currentMonth
          });
      });
    }

    // ë§ˆê° í•´ì œ ë²„íŠ¼
    if (unlockBtn) {
      unlockBtn.addEventListener('click', function() {
        if (!confirm('ì›” ë§ˆê°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì›”ì˜ ëª¨ë“  LOCKED ë§ˆê°ì´ CONFIRMEDë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
          return;
        }

        OB.showLoading('ì›” ë§ˆê° í•´ì œ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('í•´ì œ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert(result.message || 'ì›” ë§ˆê° í•´ì œ ì™„ë£Œ');
            console.log('âœ… ì›” ë§ˆê° í•´ì œ ì™„ë£Œ:', result);

            // ìƒíƒœ ë‹¤ì‹œ ì¡°íšŒ
            checkMonthStatus(state.currentMonth);
            loadAllClosings();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ í•´ì œ ì‹¤íŒ¨:', error);
            alert('í•´ì œ ì‹¤íŒ¨: ' + error.message);
          })
          .unlockMonthlyClosingApi({
            yearMonth: state.currentMonth
          });
      });
    }

    // ì›” ìƒíƒœ í™•ì¸
    function checkMonthStatus(yearMonth) {
      // ë§ˆê° ë‚´ì—­ì—ì„œ í•´ë‹¹ ì›” ì°¾ê¸°
      var closing = null;
      for (var i = 0; i < state.closingsList.length; i++) {
        if (state.closingsList[i].yearMonth === yearMonth) {
          closing = state.closingsList[i];
          break;
        }
      }

      state.currentStatus = closing;
      renderStatus(closing, yearMonth);
      updateButtons(closing);
    }

    // ìƒíƒœ ë Œë”ë§
    function renderStatus(closing, yearMonth) {
      var year = yearMonth.substring(0, 4);
      var month = yearMonth.substring(4, 6);

      document.getElementById('monthly-status-title').textContent =
        year + 'ë…„ ' + parseInt(month) + 'ì›” ë§ˆê° ìƒíƒœ';

      if (closing) {
        // ë§ˆê° ì™„ë£Œ
        document.getElementById('monthly-status-value').textContent = closing.status;
        document.getElementById('monthly-status-value').className =
          'monthly-status-value status ' + closing.status.toLowerCase();

        document.getElementById('monthly-purchase-count').textContent =
          OB.formatNumber(closing.purchaseCount || 0);
        document.getElementById('monthly-purchase-amount').textContent =
          'â‚©' + OB.formatNumber(closing.purchaseAmount || 0);
        document.getElementById('monthly-sales-count').textContent =
          OB.formatNumber(closing.salesCount || 0);
        document.getElementById('monthly-sales-amount').textContent =
          'â‚©' + OB.formatNumber(closing.salesAmount || 0);

        statusDiv.className = 'monthly-status ' + closing.status.toLowerCase();

        // ë§ˆê° ì •ë³´ í‘œì‹œ
        var infoDiv = document.getElementById('monthly-status-info');
        var infoText = '';
        if (closing.status === 'CLOSED') {
          infoText = 'ğŸ“Œ ë§ˆê°ì¼ì‹œ: ' + closing.closedAt + ' (ë§ˆê°ì: ' + closing.closedBy + ')';
        } else if (closing.status === 'OPEN') {
          infoText = 'ğŸ”“ ë§ˆê° í•´ì œì¼ì‹œ: ' + closing.unlockedAt + ' (í•´ì œì: ' + closing.unlockedBy + ')';
        }
        document.getElementById('monthly-closed-info').textContent = infoText;
        infoDiv.style.display = infoText ? 'block' : 'none';

      } else {
        // ë§ˆê° ì „
        document.getElementById('monthly-status-value').textContent = 'OPEN';
        document.getElementById('monthly-status-value').className =
          'monthly-status-value status open';

        document.getElementById('monthly-purchase-count').textContent = '-';
        document.getElementById('monthly-purchase-amount').textContent = '-';
        document.getElementById('monthly-sales-count').textContent = '-';
        document.getElementById('monthly-sales-amount').textContent = '-';

        statusDiv.className = 'monthly-status open';

        document.getElementById('monthly-status-info').style.display = 'none';
      }

      statusDiv.style.display = 'block';
    }

    // ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateButtons(closing) {
      if (closing && closing.status === 'CLOSED') {
        executeBtn.style.display = 'none';
        unlockBtn.style.display = 'inline-block';
      } else {
        executeBtn.style.display = 'inline-block';
        unlockBtn.style.display = 'none';
      }
    }

    // ë§ˆê° ë‚´ì—­ í…Œì´ë¸” ë Œë”ë§
    function renderClosingsTable(closings) {
      if (!closings || closings.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="9" class="monthly-empty">' +
          '<div class="monthly-empty-icon">ğŸ“‹</div>' +
          '<div class="monthly-empty-text">ë§ˆê° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
          '</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      // ë…„ì›” ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      closings.sort(function(a, b) {
        return b.yearMonth.localeCompare(a.yearMonth);
      });

      closings.forEach(function(closing) {
        var tr = document.createElement('tr');

        var year = closing.yearMonth.substring(0, 4);
        var month = closing.yearMonth.substring(4, 6);
        var displayMonth = year + 'ë…„ ' + month + 'ì›”';

        var statusBadge = '<span class="status-badge ' +
          closing.status.toLowerCase() + '">' +
          closing.status + '</span>';

        tr.innerHTML =
          '<td>' + displayMonth + '</td>' +
          '<td class="status">' + statusBadge + '</td>' +
          '<td class="num">' + OB.formatNumber(closing.purchaseCount || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(closing.purchaseAmount || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(closing.salesCount || 0) + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(closing.salesAmount || 0) + '</td>' +
          '<td>' + (closing.closedAt || '-') + '</td>' +
          '<td>' + (closing.closedBy || '-') + '</td>' +
          '<td>' + (closing.unlockedAt || '-') + '</td>';

        tbody.appendChild(tr);
      });
    }

    console.log('âœ… MonthlyClosing í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ì²­êµ¬ì„œ ê´€ë¦¬ í˜ì´ì§€ (BillingManagement)
  // ========================================
  window.initBillingManagementPage = function() {
    console.log('ğŸ”„ BillingManagement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');

    // DOM ìš”ì†Œ
    var companyInput = document.getElementById('billing-mgmt-company');
    var statusSelect = document.getElementById('billing-mgmt-status');
    var startDateInput = document.getElementById('billing-mgmt-start-date');
    var endDateInput = document.getElementById('billing-mgmt-end-date');
    var searchBtn = document.getElementById('billing-mgmt-search-btn');
    var resetBtn = document.getElementById('billing-mgmt-reset-btn');

    var summaryDiv = document.getElementById('billing-mgmt-summary');
    var totalCountSpan = document.getElementById('billing-mgmt-total-count');
    var totalAmountSpan = document.getElementById('billing-mgmt-total-amount');
    var issuedAmountSpan = document.getElementById('billing-mgmt-issued-amount');
    var unpaidAmountSpan = document.getElementById('billing-mgmt-unpaid-amount');

    var tbody = document.getElementById('billing-mgmt-tbody');

    var detailModal = document.getElementById('billing-detail-modal');
    var modalCloseBtn = document.getElementById('billing-modal-close-btn');
    var detailReprintBtn = document.getElementById('billing-detail-reprint-btn');
    var detailChangeStatusBtn = document.getElementById('billing-detail-change-status-btn');

    // í˜„ì¬ ì„ íƒëœ ì²­êµ¬ì„œ
    var currentBilling = null;

    // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ë‹¹ì›” 1ì¼ ~ ë§ì¼)
    var today = new Date();
    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    var lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    startDateInput.value = formatDateInput(firstDay);
    endDateInput.value = formatDateInput(lastDay);

    function formatDateInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchBtn.addEventListener('click', function() {
      var company = companyInput.value.trim();
      var status = statusSelect.value;
      var startDate = startDateInput.value;
      var endDate = endDateInput.value;

      console.log('ğŸ“‹ ì²­êµ¬ì„œ ì¡°íšŒ:', { company: company, status: status, startDate: startDate, endDate: endDate });

      OB.showLoading('ì²­êµ¬ì„œ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('âœ… ì²­êµ¬ì„œ ì¡°íšŒ ì™„ë£Œ:', result);

          if (!result || !result.success) {
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderSummary(result.billings || []);
          renderTable(result.billings || []);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ì²­êµ¬ì„œ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ì²­êµ¬ì„œ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getBillingsApi({
          type: '',
          company: company,
          status: status,
          startDate: startDate,
          endDate: endDate
        });
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­
    resetBtn.addEventListener('click', function() {
      companyInput.value = '';
      statusSelect.value = '';
      startDateInput.value = formatDateInput(firstDay);
      endDateInput.value = formatDateInput(lastDay);

      summaryDiv.style.display = 'none';
      tbody.innerHTML =
        '<tr><td colspan="8" class="billing-empty">' +
        '<div class="billing-empty-icon">ğŸ“‹</div>' +
        '<div class="billing-empty-text">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²­êµ¬ì„œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”</div>' +
        '</td></tr>';
    });

    // ìš”ì•½ ì¹´ë“œ ë Œë”ë§
    function renderSummary(billings) {
      if (!billings || billings.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }

      summaryDiv.style.display = 'grid';

      var totalCount = billings.length;
      var totalAmount = 0;
      var issuedAmount = 0;
      var paidAmount = 0;

      billings.forEach(function(billing) {
        var amount = Number(billing.amount) || 0;
        totalAmount += amount;

        if (billing.status === 'ISSUED' || billing.status === 'PAID') {
          issuedAmount += amount;
        }

        if (billing.status === 'PAID') {
          paidAmount += amount;
        }
      });

      var unpaidAmount = issuedAmount - paidAmount;

      totalCountSpan.textContent = OB.formatNumber(totalCount);
      totalAmountSpan.textContent = 'â‚©' + OB.formatNumber(totalAmount);
      issuedAmountSpan.textContent = 'â‚©' + OB.formatNumber(issuedAmount);
      unpaidAmountSpan.textContent = 'â‚©' + OB.formatNumber(unpaidAmount);
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(billings) {
      if (!billings || billings.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="8" class="billing-empty">' +
          '<div class="billing-empty-icon">ğŸ“‹</div>' +
          '<div class="billing-empty-text">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' +
          '</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      billings.forEach(function(billing) {
        var tr = document.createElement('tr');

        var statusBadge = '<span class="billing-status-badge ' +
          billing.status + '">' +
          getStatusText(billing.status) + '</span>';

        var typeText = billing.type === 'PURCHASE' ? 'ë§¤ì…' : 'ë§¤ì¶œ';

        tr.innerHTML =
          '<td>' + billing.billingId + '</td>' +
          '<td>' + typeText + '</td>' +
          '<td>' + billing.company + '</td>' +
          '<td>' + billing.billingDate + '</td>' +
          '<td class="num">â‚©' + OB.formatNumber(billing.amount) + '</td>' +
          '<td class="center">' + statusBadge + '</td>' +
          '<td>' + (billing.notes || '-') + '</td>' +
          '<td class="center">' +
          '<button class="billing-btn primary small" data-billing-id="' + billing.billingId + '">ìƒì„¸</button>' +
          '</td>';

        tbody.appendChild(tr);
      });

      // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      tbody.querySelectorAll('button[data-billing-id]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var billingId = this.getAttribute('data-billing-id');
          var billing = billings.find(function(b) { return b.billingId === billingId; });
          if (billing) {
            showDetailModal(billing);
          }
        });
      });
    }

    function getStatusText(status) {
      switch (status) {
        case 'DRAFT': return 'ì„ì‹œì €ì¥';
        case 'ISSUED': return 'ë°œí–‰ì™„ë£Œ';
        case 'PAID': return 'ì…ê¸ˆì™„ë£Œ';
        default: return status;
      }
    }

    // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
    function showDetailModal(billing) {
      currentBilling = billing;

      document.getElementById('detail-billing-id').textContent = billing.billingId || '-';
      document.getElementById('detail-type').textContent = billing.type === 'PURCHASE' ? 'ë§¤ì…' : 'ë§¤ì¶œ';
      document.getElementById('detail-company').textContent = billing.company || '-';
      document.getElementById('detail-settlement-id').textContent = billing.settlementId || '-';
      document.getElementById('detail-billing-date').textContent = billing.billingDate || '-';
      document.getElementById('detail-amount').textContent = 'â‚©' + OB.formatNumber(billing.amount);
      document.getElementById('detail-status').textContent = getStatusText(billing.status);
      document.getElementById('detail-notes').textContent = billing.notes || '-';

      document.getElementById('detail-created-at').textContent = billing.createdAt || '-';
      document.getElementById('detail-created-by').textContent = billing.createdBy || '-';
      document.getElementById('detail-issued-at').textContent = billing.issuedAt || '-';
      document.getElementById('detail-issued-by').textContent = billing.issuedBy || '-';
      document.getElementById('detail-paid-at').textContent = billing.paidAt || '-';

      detailModal.classList.add('active');
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    modalCloseBtn.addEventListener('click', function() {
      detailModal.classList.remove('active');
      currentBilling = null;
    });

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    detailModal.addEventListener('click', function(e) {
      if (e.target === detailModal) {
        detailModal.classList.remove('active');
        currentBilling = null;
      }
    });

    // ì¬ì¶œë ¥ ë²„íŠ¼
    detailReprintBtn.addEventListener('click', function() {
      if (!currentBilling) return;

      var invoiceId = currentBilling.invoiceId || currentBilling.billingId;
      if (!invoiceId) {
        alert('ì²­êµ¬IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      OB.showLoading('ì²­êµ¬ì„œ ì¬ì¶œë ¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ì¬ì¶œë ¥ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          var url = 'https://drive.google.com/uc?export=download&id=' + result.fileId;
          window.open(url, '_blank');
          alert('PDF ì¬ì¶œë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼: ' + result.fileName);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          alert('ì¬ì¶œë ¥ ì‹¤íŒ¨: ' + error.message);
        })
        .reprintInvoiceApi({
          invoiceId: invoiceId,
          billingId: invoiceId,
          settlementId: currentBilling.settlementId,
          type: currentBilling.type
        });
    });

    // ìƒíƒœ ë³€ê²½ ë²„íŠ¼
    detailChangeStatusBtn.addEventListener('click', function() {
      if (!currentBilling) return;

      var nextStatus = '';
      var nextStatusText = '';

      if (currentBilling.status === 'DRAFT') {
        nextStatus = 'ISSUED';
        nextStatusText = 'ë°œí–‰ì™„ë£Œ';
      } else if (currentBilling.status === 'ISSUED') {
        nextStatus = 'PAID';
        nextStatusText = 'ì…ê¸ˆì™„ë£Œ';
      } else {
        alert('ë” ì´ìƒ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.');
        return;
      }

      var confirmMsg = 'ì²­êµ¬ì„œ ìƒíƒœë¥¼ "' + nextStatusText + '"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      if (!confirm(confirmMsg)) return;

      OB.showLoading('ìƒíƒœ ë³€ê²½ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
          detailModal.classList.remove('active');
          currentBilling = null;

          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          searchBtn.click();
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
        })
        .updateBillingStatusApi({
          billingId: currentBilling.billingId,
          status: nextStatus
        });
    });

    console.log('âœ… BillingManagement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… OrderFile í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.initOrderFilePage = function() {
    var wrap = document.getElementById('ob-orderfile-wrap');
    if (!wrap) {
      console.warn('OrderFile wrapper not found');
      return;
    }

    if (wrap.dataset.bound === '1') {
      console.log('OrderFile already initialized');
      return;
    }
    wrap.dataset.bound = '1';

    console.log('âœ… OrderFile Page ì´ˆê¸°í™” ì™„ë£Œ');

    var parsedItems = [];
    var currentFilter = 'all'; // 'all' or 'unmatched'

    var customerSelect = document.getElementById('ob-customer-select');
    var fileInput = document.getElementById('ob-orderfile-input');
    var btnParse = document.getElementById('ob-btn-parse');
    var btnSave = document.getElementById('ob-btn-save');
    var tableBody = document.querySelector('#ob-orderfile-table tbody');

    var summaryCards = document.getElementById('ob-summary-cards');
    var summaryTotal = document.getElementById('summary-total');
    var summaryMatched = document.getElementById('summary-matched');
    var summaryUnmatched = document.getElementById('summary-unmatched');
    var summaryAmount = document.getElementById('summary-amount');
    var summaryMatchCard = document.getElementById('summary-match-card');

    var filterControls = document.getElementById('ob-filter-controls');
    var btnFilterUnmatched = document.getElementById('ob-btn-filter-unmatched');
    var btnFilterAll = document.getElementById('ob-btn-filter-all');

    var duplicateModal = document.getElementById('ob-duplicate-modal');
    var duplicateOrderList = document.getElementById('duplicate-order-list');
    var btnDuplicateCancel = document.getElementById('ob-btn-duplicate-cancel');
    var btnDuplicateContinue = document.getElementById('ob-btn-duplicate-continue');

    loadCustomers();

    function loadCustomers() {
      console.log('ğŸ“„ ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ë°œì£¼ì²˜ ì‘ë‹µ:', result);

          var customerList = [];
          if (result && result.success) {
            if (Array.isArray(result.data)) {
              customerList = result.data;
            } else if (Array.isArray(result.customers)) {
              customerList = result.customers;
            }
          }

          if (!customerList.length) {
            console.warn('âš ï¸ ë°œì£¼ì²˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            return;
          }

          customerList.forEach(function(customerName) {
            var option = document.createElement('option');
            option.value = customerName;
            option.textContent = customerName;
            customerSelect.appendChild(option);
          });

          console.log('âœ… ë°œì£¼ì²˜ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì™„ë£Œ');
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ë°œì£¼ì²˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getCustomers();
    }

    if (btnParse) {
      btnParse.addEventListener('click', function() {
        var file = fileInput.files[0];
        var selectedCustomer = customerSelect.value;

        if (!selectedCustomer) {
          alert('ë°œì£¼ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!file) {
          alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        console.log('íŒŒì‹± ì‹œì‘:', file.name, 'ë°œì£¼ì²˜:', selectedCustomer);
        OB.showLoading('íŒŒì¼ì„ ì½ëŠ” ì¤‘...');

        var reader = new FileReader();

        reader.onload = function(e) {
          try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });

            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];

            var rows = XLSX.utils.sheet_to_json(worksheet, {
              header: 1,
              defval: '',
              blankrows: false
            });

            console.log('ì—‘ì…€ ì½ê¸° ì™„ë£Œ. í–‰ ìˆ˜:', rows.length);

            if (rows.length === 0) {
              OB.hideLoading();
              alert('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            OB.showLoading('ì„œë²„ì—ì„œ ë§¤ì¹­ ì¤‘...');

            google.script.run
              .withSuccessHandler(function(result) {
                OB.hideLoading();
                console.log('íŒŒì‹± ê²°ê³¼:', result);

                if (result && result.items) {
                  parsedItems = result.items.map(function(item) {
                    item.customer = selectedCustomer;
                    return item;
                  });
                  displayParseResult(result);
                  btnSave.disabled = false;
                } else {
                  alert('íŒŒì‹± ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
              })
              .withFailureHandler(function(error) {
                OB.hideLoading();
                console.error('íŒŒì‹± ì‹¤íŒ¨:', error);
                alert('íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
              })
              .processParsedOrderRows(rows);

          } catch (err) {
            OB.hideLoading();
            console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', err);
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        };

        reader.onerror = function(err) {
          OB.hideLoading();
          console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        };

        reader.readAsArrayBuffer(file);
      });
    }

    if (btnSave) {
      btnSave.addEventListener('click', function() {
        if (!parsedItems || parsedItems.length === 0) {
          alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ íŒŒì‹±í•´ì£¼ì„¸ìš”.');
          return;
        }

        var unmatched = parsedItems.filter(function(item) { return item.matchStatus !== 'MATCHED'; });

        if (unmatched.length > 0) {
          var confirmMessage = 'ë§¤ì¹­ë˜ì§€ ì•Šì€ í’ˆëª©ì´ ' + unmatched.length + 'ê±´ ìˆìŠµë‹ˆë‹¤.\n' +
                               'ì´ëŒ€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
          if (!confirm(confirmMessage)) {
            return;
          }
        }

        checkDuplicateOrders(parsedItems, function(canProceed, duplicates) {
          if (!canProceed) {
            duplicateModal.style.display = 'flex';
            renderDuplicates(duplicates);
            return;
          }

          saveOrders(parsedItems);
        });
      });
    }

    function renderDuplicates(duplicates) {
      duplicateOrderList.innerHTML = '';

      // checkTodayDuplicateOrder ë°˜í™˜ í˜•ì‹:
      // { orderCode, brands, itemCount, totalAmount }
      duplicates.forEach(function(dup) {
        var li = document.createElement('div');
        li.className = 'ob-modal-list-item';
        li.innerHTML = '<div><div class="title">' + (dup.orderCode || 'ë°œì£¼ë²ˆí˜¸ ì—†ìŒ') + '</div>' +
                       '<div class="sub">ë¸Œëœë“œ: ' + (dup.brands || '-') + ', í’ˆëª©ìˆ˜: ' + (dup.itemCount || 0) + 'ê±´</div></div>' +
                       '<div class="status">â‚©' + OB.formatNumber(dup.totalAmount || 0) + '</div>';
        duplicateOrderList.appendChild(li);
      });
    }

    if (btnDuplicateCancel) {
      btnDuplicateCancel.addEventListener('click', function() {
        duplicateModal.style.display = 'none';
      });
    }

    if (btnDuplicateContinue) {
      btnDuplicateContinue.addEventListener('click', function() {
        duplicateModal.style.display = 'none';
        saveOrders(parsedItems);
      });
    }

    function checkDuplicateOrders(items, callback) {
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = ('0' + (today.getMonth() + 1)).slice(-2);
      var dd = ('0' + today.getDate()).slice(-2);
      var todayStr = yyyy + '-' + mm + '-' + dd;

      var customer = items[0] ? items[0].customer : '';
      if (!customer) {
        callback(true, []);
        return;
      }

      OB.showLoading('ì˜¤ëŠ˜ ë°œì£¼ ë‚´ì—­ í™•ì¸ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('ì¤‘ë³µ ì²´í¬ ê²°ê³¼:', result);

          if (!result || !result.success || !result.hasDuplicate) {
            callback(true, []);
            return;
          }

          // ì¤‘ë³µ ë°œì£¼ê°€ ìˆìœ¼ë©´ orders ë°°ì—´ ì „ë‹¬
          if (result.orders && result.orders.length > 0) {
            callback(false, result.orders);
          } else {
            callback(true, []);
          }
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨:', error);
          alert('ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          callback(true, []);
        })
        .checkTodayDuplicateOrder(customer, todayStr);
    }

    function saveOrders(items) {
      OB.showLoading('ë°œì£¼ ì €ì¥ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('ë°œì£¼ ì €ì¥ ê²°ê³¼:', result);

          if (result && result.success) {
            alert('ë°œì£¼ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (' + result.savedRows + 'ê±´)');
            btnSave.disabled = true;
            // í…Œì´ë¸” ì´ˆê¸°í™”
            parsedItems = [];
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">íŒŒì¼ì„ ì„ íƒí•˜ê³  íŒŒì‹± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</td></tr>';
            summaryCards.style.display = 'none';
            filterControls.style.display = 'none';
          } else {
            var errorMsg = 'ë°œì£¼ ì €ì¥ ì‹¤íŒ¨:\n';
            if (result && result.errors && result.errors.length > 0) {
              errorMsg += result.errors.slice(0, 5).join('\n');
              if (result.errors.length > 5) {
                errorMsg += '\n... ì™¸ ' + (result.errors.length - 5) + 'ê±´';
              }
            } else {
              errorMsg += (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
            alert(errorMsg);
          }
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('ë°œì£¼ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ë°œì£¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        })
        .saveParsedOrdersToDB(items);
    }

    function displayParseResult(result) {
      if (!result || !result.items) {
        alert('íŒŒì‹± ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      // ìš”ì•½ ì¹´ë“œ í‘œì‹œ
      summaryCards.style.display = 'grid';

      summaryTotal.textContent = result.items.length + 'ê°œ';
      summaryMatched.textContent = (result.matchedCount || 0) + 'ê°œ';
      summaryUnmatched.textContent = 'ë¯¸ë§¤ì¹­ ' + (result.unmatchedCount || 0) + 'ê°œ';
      summaryAmount.textContent = 'â‚©' + OB.formatNumber(result.totalAmount || 0);

      if (result.items.length > 0) {
        var matchRate = ((result.matchedCount || 0) / result.items.length) * 100;
        if (matchRate >= 80) {
          summaryMatchCard.classList.add('success');
          summaryMatchCard.classList.remove('highlight');
        } else {
          summaryMatchCard.classList.add('highlight');
          summaryMatchCard.classList.remove('success');
        }
      }

      var hasUnmatched = (result.unmatchedCount || 0) > 0;
      filterControls.style.display = hasUnmatched ? 'flex' : 'none';
      btnFilterAll.style.display = 'none';
      btnFilterUnmatched.style.display = hasUnmatched ? 'inline-block' : 'none';

      renderTable(result.items);
    }

    function renderTable(items) {
      tableBody.innerHTML = '';

      // HTML í…Œì´ë¸” í—¤ë”: #, ë¸Œëœë“œ, ì œí’ˆëª…, ë°”ì½”ë“œ, ìˆ˜ëŸ‰, ê³µê¸‰ë‹¨ê°€, ê¸ˆì•¡, ìƒíƒœ
      items.forEach(function(item, index) {
        var tr = document.createElement('tr');
        var isMatched = item.matchStatus === 'MATCHED';

        if (isMatched) {
          tr.classList.add('matched');
        } else {
          tr.classList.add('unmatched');
        }

        tr.innerHTML =
          '<td>' + (item.seq || index + 1) + '</td>' +
          '<td>' + (item.brand || '') + '</td>' +
          '<td>' + (item.productName || '') + '</td>' +
          '<td>' + (item.barcode || '-') + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.supplyPrice || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(item.orderAmount || 0) + '</td>' +
          '<td class="status-cell">' +
            (isMatched ? '<span class="status-text status-matched">ë§¤ì¹­</span>' : '<span class="status-text status-unmatched">ë¯¸ë§¤ì¹­</span>') +
          '</td>';

        tableBody.appendChild(tr);
      });
    }

    if (btnFilterUnmatched) {
      btnFilterUnmatched.addEventListener('click', function() {
        currentFilter = 'unmatched';
        applyFilter();
        btnFilterUnmatched.style.display = 'none';
        btnFilterAll.style.display = 'inline-block';
      });
    }

    if (btnFilterAll) {
      btnFilterAll.addEventListener('click', function() {
        currentFilter = 'all';
        applyFilter();
        btnFilterAll.style.display = 'none';
        btnFilterUnmatched.style.display = 'inline-block';
      });
    }

    function applyFilter() {
      var rows = tableBody.querySelectorAll('tr');
      rows.forEach(function(row) {
        if (currentFilter === 'unmatched') {
          if (row.classList.contains('matched')) {
            row.classList.add('hidden');
          } else {
            row.classList.remove('hidden');
          }
        } else {
          row.classList.remove('hidden');
        }
      });
    }
  };

  // ===========================================================
  // âœ… TransactionLedger í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.transactionLedgerState = {
    raw: [],
    filtered: []
  };

  OB.initTransactionLedgerPage = function() {
    console.log('ğŸ”„ TransactionLedger í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');

    var state = OB.transactionLedgerState;

    var startDateInput = document.getElementById('ledger-start-date');
    var endDateInput = document.getElementById('ledger-end-date');
    var companyInput = document.getElementById('ledger-company');
    var statusSelect = document.getElementById('ledger-status');
    var orderCodeInput = document.getElementById('ledger-order-code');
    var searchBtn = document.getElementById('ledger-search-btn');
    var resetBtn = document.getElementById('ledger-reset-btn');
    var tbody = document.getElementById('ledger-tbody');

    var summaryCount = document.getElementById('ledger-summary-count');
    var summaryOrderQty = document.getElementById('ledger-summary-order-qty');
    var summaryConfirmedQty = document.getElementById('ledger-summary-confirmed-qty');
    var summaryAmount = document.getElementById('ledger-summary-amount');

    var today = new Date();
    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    startDateInput.value = formatDateInput(firstDay);
    endDateInput.value = formatDateInput(today);

    function formatDateInput(date) {
      var y = date.getFullYear();
      var m = String(date.getMonth() + 1).padStart(2, '0');
      var d = String(date.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + d;
    }

    function parseDate(value) {
      if (!value) return null;
      var d = value instanceof Date ? value : new Date(value);
      return isNaN(d.getTime()) ? null : d;
    }

    function applyFilters() {
      var start = parseDate(startDateInput.value);
      var end = parseDate(endDateInput.value);
      var company = (companyInput.value || '').trim();
      var status = statusSelect.value;
      var orderCode = (orderCodeInput.value || '').trim();

      state.filtered = state.raw.filter(function(tx) {
        var keep = true;

        if (orderCode) {
          keep = keep && String(tx['ë°œì£¼ë²ˆí˜¸'] || '').indexOf(orderCode) !== -1;
        }

        if (company) {
          keep = keep && String(tx['ë°œì£¼ì²˜'] || '').indexOf(company) !== -1;
        }

        if (status) {
          keep = keep && String(tx['ìƒíƒœ'] || '').toUpperCase() === status.toUpperCase();
        }

        if (start || end) {
          var orderDate = parseDate(tx['ë°œì£¼ì¼']);
          if (start && (!orderDate || orderDate < start)) keep = false;
          if (end && (!orderDate || orderDate > end)) keep = false;
        }

        return keep;
      });

      renderSummary();
      renderTable();
    }

    function renderSummary() {
      var totalOrderQty = 0;
      var totalConfirmedQty = 0;
      var totalAmount = 0;

      state.filtered.forEach(function(tx) {
        totalOrderQty += Number(tx['ë°œì£¼ìˆ˜ëŸ‰']) || 0;
        totalConfirmedQty += Number(tx['í™•ì •ìˆ˜ëŸ‰']) || 0;
        totalAmount += Number(tx['ê³µê¸‰ì•¡']) || 0;
      });

      summaryCount.textContent = (state.filtered.length || 0) + 'ê±´';
      summaryOrderQty.textContent = OB.formatNumber(totalOrderQty);
      summaryConfirmedQty.textContent = OB.formatNumber(totalConfirmedQty);
      summaryAmount.textContent = 'â‚©' + OB.formatNumber(totalAmount);
    }

    function buildStatusSelect(current) {
      var select = document.createElement('select');
      select.className = 'ledger-status-select';
      var options = ['DRAFT', 'CONFIRMED', 'ISSUED', 'PAID', 'CANCELLED'];

      if (current && options.indexOf(current) === -1) {
        options.unshift(current);
      }

      options.forEach(function(opt) {
        var optionEl = document.createElement('option');
        optionEl.value = opt;
        optionEl.textContent = opt;
        if (current === opt) {
          optionEl.selected = true;
        }
        select.appendChild(optionEl);
      });

      return select;
    }

    function renderTable() {
      if (!tbody) return;

      if (!state.filtered.length) {
        tbody.innerHTML = '<tr><td colspan="12" class="ledger-empty">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      state.filtered.forEach(function(tx) {
        var tr = document.createElement('tr');

        function td(text, cls) {
          var cell = document.createElement('td');
          cell.textContent = text;
          if (cls) cell.className = cls;
          tr.appendChild(cell);
        }

        td(OB.formatDate(tx['ë°œì£¼ì¼']));
        td(tx['ë°œì£¼ë²ˆí˜¸'] || '-');
        td(tx['ë°œì£¼ì²˜'] || '-');
        td(tx['ë¸Œëœë“œ'] || '-');
        td(tx['í’ˆëª©ì½”ë“œ'] || '-');
        td(tx['ì œí’ˆëª…'] || '-');
        td(OB.formatNumber(tx['ë°œì£¼ìˆ˜ëŸ‰'] || 0), 'num');
        td(OB.formatNumber(tx['í™•ì •ìˆ˜ëŸ‰'] || 0), 'num');
        td(OB.formatNumber(tx['ê³µê¸‰ê°€'] || 0), 'num');
        td(OB.formatNumber(tx['ê³µê¸‰ì•¡'] || 0), 'num');

        var statusTd = document.createElement('td');
        var badge = document.createElement('span');
        badge.className = 'ledger-status-badge';
        badge.textContent = tx['ìƒíƒœ'] || 'N/A';
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);

        var actionTd = document.createElement('td');
        actionTd.className = 'ledger-action-group';

        var select = buildStatusSelect(tx['ìƒíƒœ']);
        var btn = document.createElement('button');
        btn.className = 'ledger-btn primary';
        btn.textContent = 'ìƒíƒœ ë³€ê²½';

        btn.addEventListener('click', function() {
          var next = select.value;
          if (!next) {
            alert('ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          OB.showLoading('ìƒíƒœ ë³€ê²½ ì¤‘...');

          google.script.run
            .withSuccessHandler(function(res) {
              OB.hideLoading();

              if (!res || !res.success) {
                alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (res ? res.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                return;
              }

              alert('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
              fetchTransactions();
            })
            .withFailureHandler(function(err) {
              OB.hideLoading();
              alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
            })
            .updateTransactionStateApi({ rowIndex: tx._rowIndex, state: next });
        });

        actionTd.appendChild(select);
        actionTd.appendChild(btn);
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });
    }

    function fetchTransactions() {
      var orderCode = (orderCodeInput.value || '').trim();

      OB.showLoading('ê±°ë˜ì›ì¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ê±°ë˜ì›ì¥ ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          state.raw = result.transactions || [];
          applyFilters();
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          alert('ê±°ë˜ì›ì¥ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getTransactionsApi({ orderCode: orderCode });
    }

    searchBtn.addEventListener('click', function() {
      fetchTransactions();
    });

    resetBtn.addEventListener('click', function() {
      companyInput.value = '';
      statusSelect.value = '';
      orderCodeInput.value = '';
      startDateInput.value = formatDateInput(firstDay);
      endDateInput.value = formatDateInput(today);
      state.filtered = state.raw.slice();
      applyFilters();
    });

    // ì´ˆê¸° ì¡°íšŒ
    fetchTransactions();

    console.log('âœ… TransactionLedger í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… InvoiceManagement í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.invoiceManagementState = {
    aggItems: [],
    aggAmount: 0,
    invoices: []
  };

  OB.initInvoiceManagementPage = function() {
    console.log('ğŸ”„ InvoiceManagement í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');

    var state = OB.invoiceManagementState;

    // ì§‘ê³„ UI
    var aggCompany = document.getElementById('invoice-agg-company');
    var aggStart = document.getElementById('invoice-agg-start');
    var aggEnd = document.getElementById('invoice-agg-end');
    var aggBtn = document.getElementById('invoice-agg-btn');
    var aggSummary = document.getElementById('invoice-agg-summary');
    var aggTableWrap = document.getElementById('invoice-agg-table-wrap');
    var aggTbody = document.getElementById('invoice-agg-tbody');
    var aggItemsEl = document.getElementById('invoice-agg-items');
    var aggOrderQtyEl = document.getElementById('invoice-agg-order-qty');
    var aggConfirmedQtyEl = document.getElementById('invoice-agg-confirmed-qty');
    var aggAmountEl = document.getElementById('invoice-agg-amount');

    // ìƒì„± UI
    var createSettlement = document.getElementById('invoice-create-settlement');
    var createType = document.getElementById('invoice-create-type');
    var createCompany = document.getElementById('invoice-create-company');
    var createDate = document.getElementById('invoice-create-date');
    var createAmount = document.getElementById('invoice-create-amount');
    var createNotes = document.getElementById('invoice-create-notes');
    var createBtn = document.getElementById('invoice-create-btn');

    // ëª©ë¡ UI
    var filterType = document.getElementById('invoice-filter-type');
    var filterCompany = document.getElementById('invoice-filter-company');
    var filterStatus = document.getElementById('invoice-filter-status');
    var filterStart = document.getElementById('invoice-filter-start');
    var filterEnd = document.getElementById('invoice-filter-end');
    var searchBtn = document.getElementById('invoice-search-btn');
    var resetBtn = document.getElementById('invoice-reset-btn');
    var listTbody = document.getElementById('invoice-list-tbody');
    var listCount = document.getElementById('invoice-list-count');
    var listAmount = document.getElementById('invoice-list-amount');

    var today = new Date();
    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    aggStart.value = formatDateInput(firstDay);
    aggEnd.value = formatDateInput(today);
    filterStart.value = formatDateInput(firstDay);
    filterEnd.value = formatDateInput(today);
    createDate.value = formatDateInput(today);

    function formatDateInput(date) {
      var y = date.getFullYear();
      var m = String(date.getMonth() + 1).padStart(2, '0');
      var d = String(date.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + d;
    }

    function renderAggTable(items) {
      if (!items || !items.length) {
        aggTbody.innerHTML = '<tr><td colspan="8" class="invoice-empty">ì§‘ê³„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      aggTbody.innerHTML = '';

      items.forEach(function(item) {
        var tr = document.createElement('tr');
        function td(text, cls) {
          var cell = document.createElement('td');
          cell.textContent = text;
          if (cls) cell.className = cls;
          tr.appendChild(cell);
        }

        td(item.orderDate || '-');
        td(item.orderCode || '-');
        td(item.supplier || '-');
        td(item.brand || '-');
        td(item.productName || '-');
        td(OB.formatNumber(item.confirmedQty || 0), 'num');
        td(OB.formatNumber(item.supplyPrice || 0), 'num');
        td(OB.formatNumber(item.supplyAmount || 0), 'num');

        aggTbody.appendChild(tr);
      });
    }

    function renderAggSummary(result) {
      aggItemsEl.textContent = OB.formatNumber(result.totalItems || 0);
      aggOrderQtyEl.textContent = OB.formatNumber(result.totalOrderQty || 0);
      aggConfirmedQtyEl.textContent = OB.formatNumber(result.totalConfirmedQty || 0);
      aggAmountEl.textContent = 'â‚©' + OB.formatNumber(result.totalAmount || 0);
    }

    function aggregate() {
      var company = (aggCompany.value || '').trim();
      var startDate = aggStart.value;
      var endDate = aggEnd.value;

      OB.showLoading('ì²­êµ¬ ë°ì´í„° ì§‘ê³„ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert('ì§‘ê³„ ì‹¤íŒ¨: ' + (res ? res.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          state.aggItems = res.items || [];
          state.aggAmount = res.totalAmount || 0;

          renderAggSummary(res);
          renderAggTable(state.aggItems);
          aggSummary.style.display = 'grid';
          aggTableWrap.style.display = 'block';

          if (company) {
            createCompany.value = company;
          }
          if (state.aggAmount) {
            createAmount.value = state.aggAmount;
          }
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          alert('ì§‘ê³„ ì‹¤íŒ¨: ' + err.message);
        })
        .aggregateInvoiceDataApi({ company: company, startDate: startDate, endDate: endDate });
    }

    aggBtn.addEventListener('click', aggregate);

    function createInvoice() {
      var settlementId = (createSettlement.value || '').trim();
      var type = createType.value;
      var company = (createCompany.value || '').trim();
      var invoiceDate = createDate.value;
      var amount = Number(createAmount.value) || 0;
      var notes = (createNotes.value || '').trim();

      if (!settlementId || !type || !company) {
        alert('ë§ˆê° ID, ìœ í˜•, ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!amount && state.aggAmount) {
        amount = state.aggAmount;
      }

      OB.showLoading('ì²­êµ¬ì„œ ìƒì„± ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert('ì²­êµ¬ì„œ ìƒì„± ì‹¤íŒ¨: ' + (res ? res.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          alert('ì²­êµ¬ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ID: ' + res.invoiceId);
          loadInvoices();
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          alert('ì²­êµ¬ì„œ ìƒì„± ì‹¤íŒ¨: ' + err.message);
        })
        .createInvoiceFromSettlementApi({
          settlementId: settlementId,
          type: type,
          company: company,
          invoiceDate: invoiceDate,
          amount: amount,
          notes: notes
        });
    }

    createBtn.addEventListener('click', createInvoice);

    function renderInvoiceTable(list) {
      if (!list || !list.length) {
        listTbody.innerHTML = '<tr><td colspan="9" class="invoice-empty">ì¡°íšŒëœ ì¸ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      listTbody.innerHTML = '';

      list.forEach(function(inv) {
        var tr = document.createElement('tr');

        function td(text, cls) {
          var cell = document.createElement('td');
          cell.textContent = text;
          if (cls) cell.className = cls;
          tr.appendChild(cell);
        }

        td(inv.invoiceId || '-');
        td(inv.type || '-');
        td(inv.company || '-');
        td(inv.settlementId || '-');
        td(inv.invoiceDate || '-');
        td(OB.formatNumber(inv.amount || 0), 'num');

        var statusTd = document.createElement('td');
        var badge = document.createElement('span');
        badge.className = 'invoice-badge';
        badge.textContent = inv.status || 'N/A';
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);

        td(inv.notes || '-');

        var actionTd = document.createElement('td');
        var btn = document.createElement('button');
        btn.className = 'invoice-btn primary';
        btn.textContent = 'ìƒíƒœ ë³€ê²½';

        btn.addEventListener('click', function() {
          var nextStatus = '';
          var status = inv.status || 'DRAFT';

          if (status === 'DRAFT') {
            nextStatus = 'ISSUED';
          } else if (status === 'ISSUED') {
            nextStatus = 'PAID';
          } else {
            alert('ë³€ê²½ ê°€ëŠ¥í•œ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          if (!confirm('ìƒíƒœë¥¼ ' + nextStatus + ' ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

          OB.showLoading('ì¸ë³´ì´ìŠ¤ ìƒíƒœ ë³€ê²½ ì¤‘...');

          google.script.run
            .withSuccessHandler(function(res) {
              OB.hideLoading();

              if (!res || !res.success) {
                alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (res ? res.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                return;
              }

              alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
              loadInvoices();
            })
            .withFailureHandler(function(err) {
              OB.hideLoading();
              alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
            })
            .updateInvoiceStatusApi({ invoiceId: inv.invoiceId, status: nextStatus });
        });

        actionTd.appendChild(btn);
        tr.appendChild(actionTd);

        listTbody.appendChild(tr);
      });
    }

    function renderInvoiceSummary(list) {
      var totalAmount = 0;
      list.forEach(function(inv) {
        totalAmount += Number(inv.amount) || 0;
      });

      listCount.textContent = (list.length || 0) + 'ê±´';
      listAmount.textContent = 'â‚©' + OB.formatNumber(totalAmount);
    }

    function loadInvoices() {
      var params = {
        type: filterType.value,
        company: (filterCompany.value || '').trim(),
        status: filterStatus.value,
        startDate: filterStart.value,
        endDate: filterEnd.value
      };

      OB.showLoading('ì¸ë³´ì´ìŠ¤ ëª©ë¡ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (res ? res.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          state.invoices = res.invoices || [];
          renderInvoiceTable(state.invoices);
          renderInvoiceSummary(state.invoices);
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          alert('ì¡°íšŒ ì‹¤íŒ¨: ' + err.message);
        })
        .getInvoicesApi(params);
    }

    searchBtn.addEventListener('click', loadInvoices);

    resetBtn.addEventListener('click', function() {
      filterType.value = '';
      filterCompany.value = '';
      filterStatus.value = '';
      filterStart.value = formatDateInput(firstDay);
      filterEnd.value = formatDateInput(today);
      loadInvoices();
    });

    // ì´ˆê¸° ë°ì´í„°
    aggregate();
    loadInvoices();

    console.log('âœ… InvoiceManagement í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ========================================
  // ë§ˆê° ìƒì„¸ ê³µìš© ëª¨ë‹¬
  // ========================================
  (function() {
    var modal = document.getElementById('settlement-detail-modal');
    var closeBtn = document.getElementById('settlement-detail-close');
    var tbody = document.getElementById('settlement-detail-tbody');
    var isBound = false;

    function bindModalEvents() {
      if (isBound || !modal) return;
      if (closeBtn) {
        closeBtn.addEventListener('click', hideModal);
      }
      modal.addEventListener('click', function(e) {
        if (e.target === modal) hideModal();
      });
      isBound = true;
    }

    function hideModal() {
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function renderDetail(data) {
      var settlement = data.settlement || {};
      var items = data.items || [];
      var isSales = settlement.type === 'SALES';

      document.getElementById('settlement-detail-id').textContent = settlement.settlementId || '-';
      document.getElementById('settlement-detail-type').textContent = isSales ? 'ë§¤ì¶œ ë§ˆê°' : 'ë§¤ì… ë§ˆê°';
      document.getElementById('settlement-detail-partner').textContent = settlement.partner || settlement.company || '-';
      document.getElementById('settlement-detail-period').textContent = (settlement.startDate || '-') + ' ~ ' + (settlement.endDate || '-');
      document.getElementById('settlement-detail-status').textContent = settlement.status || 'DRAFT';
      document.getElementById('settlement-detail-items').textContent = OB.formatNumber(settlement.totalItems || 0);
      document.getElementById('settlement-detail-order-qty').textContent = OB.formatNumber(settlement.totalOrderQty || 0);
      document.getElementById('settlement-detail-confirmed-qty').textContent = OB.formatNumber(settlement.totalConfirmedQty || 0);
      document.getElementById('settlement-detail-amount').textContent = 'â‚©' + OB.formatNumber(settlement.totalAmount || 0);

      document.getElementById('settlement-detail-title').textContent = (isSales ? 'ë§¤ì¶œ' : 'ë§¤ì…') + ' ë§ˆê° ìƒì„¸';
      document.getElementById('settlement-detail-price-label').textContent = isSales ? 'ë§¤ì¶œê°€' : 'ë§¤ì…ê°€';
      document.getElementById('settlement-detail-amount-label').textContent = isSales ? 'ë§¤ì¶œì•¡' : 'ë§¤ì…ì•¡';

      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="11" class="settlement-detail-empty">ë§ˆê° ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      } else {
        var rows = items.map(function(item) {
          var diffQty = (item.orderQty || 0) - (item.confirmedQty || 0);
          var unitPrice = isSales ? (item.supplyPrice || 0) : (item.buyPrice || 0);
          var amount = isSales ? (item.supplyAmount || 0) : (item.purchaseAmount || 0);
          var counterParty = isSales ? (item.supplier || '') : (item.buyer || '');

          return '<tr>' +
            '<td>' + (item.orderCode || '') + '</td>' +
            '<td>' + (item.orderDate || '') + '</td>' +
            '<td>' + counterParty + '</td>' +
            '<td>' + (item.brand || '') + '</td>' +
            '<td>' + (item.productName || '') + '</td>' +
            '<td>' + (item.productCode || '') + '</td>' +
            '<td class="num">' + OB.formatNumber(item.orderQty || 0) + '</td>' +
            '<td class="num">' + OB.formatNumber(item.confirmedQty || 0) + '</td>' +
            '<td class="num">' + OB.formatNumber(diffQty) + '</td>' +
            '<td class="num">â‚©' + OB.formatNumber(unitPrice) + '</td>' +
            '<td class="num">â‚©' + OB.formatNumber(amount) + '</td>' +
          '</tr>';
        }).join('');

        tbody.innerHTML = rows;
      }

      if (modal) {
        modal.classList.add('active');
      }
    }

    OB.viewSettlementDetail = function(settlementId, type) {
      if (!modal) {
        alert('ìƒì„¸ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!settlementId) {
        alert('ë§ˆê°IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      bindModalEvents();
      OB.showLoading('ë§ˆê° ìƒì„¸ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();

          if (!result || !result.success) {
            alert('ë§ˆê° ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderDetail(result);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          alert('ë§ˆê° ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getSettlementDetailApi({ settlementId: settlementId, type: type });
    };
  })();

</script>

<!-- ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="ob-loading-overlay" class="ob-loading-overlay">
  <div class="ob-loading-box">
    <div class="ob-spinner"></div>
    <div id="ob-loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>