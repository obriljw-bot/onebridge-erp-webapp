<script>
  // ===== ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ =====
  window.OB = window.OB || {};
  
  // ===== í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì´ˆê¸° ì„¤ì • =====
  (function() {
    var urlParams = new URLSearchParams(window.location.search);
    var pageFromUrl = urlParams.get('page') || 'orderFile';
    
    OB.state = {
      currentPage: pageFromUrl,
      isLoading: false,
      initializedPages: {}
    };
  })();

  // ===== ê³µí†µ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ =====
  OB.initCurrentPage = function(page) {
    console.log('ğŸ”§ initCurrentPage í˜¸ì¶œ:', page);
    
    if (OB.state.initializedPages[page]) {
      console.log('â­ï¸  ì´ë¯¸ ì´ˆê¸°í™”ë¨:', page);
      return;
    }

    var initFuncName = null;

    switch(page) {
      case 'orderFile':
        initFuncName = 'initOrderFilePage';
        break;
      case 'dashboard':
        initFuncName = 'initDashboardPage';
        break;
      case 'orderList':
        initFuncName = 'initOrderListPage';
        break;
      case 'invoiceOutput':
        initFuncName = 'initInvoiceOutputPage';
        break;
      case 'settings':
        initFuncName = 'initSettingsPage';
        break;
    }

    if (initFuncName && typeof OB[initFuncName] === 'function') {
      console.log('âœ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰:', initFuncName);
      
      try {
        OB[initFuncName]();
        OB.state.initializedPages[page] = true;
        console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ:', page);
      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', page, err);
      }
    } else {
      console.warn('âš ï¸  ì´ˆê¸°í™” í•¨ìˆ˜ ì—†ìŒ:', page, initFuncName);
    }
  };

  // ===== ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  OB.showLoading = function (message) {
    var overlay = document.getElementById('ob-loading-overlay');
    var textEl = document.getElementById('ob-loading-text');
    if (!overlay || !textEl) return;
    textEl.textContent = message || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.';
    overlay.classList.add('show');
    OB.state.isLoading = true;
  };

  OB.hideLoading = function () {
    var overlay = document.getElementById('ob-loading-overlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    OB.state.isLoading = false;
  };

  // ===== API ë˜í¼ =====
  OB.api = {
    ping: function () {
      OB.showLoading('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘.');
      google.script.run
        .withSuccessHandler(function (res) {
          OB.hideLoading();
          console.log('ping result:', res);
          alert('ì„œë²„ ì—°ê²° ì™„ë£Œ: ' + (res && res.status));
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error(err);
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        })
        .ping();
    },

    loadPage: function (page) {
      OB.showLoading('í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘:', page);

      google.script.run
        .withSuccessHandler(function (html) {
          OB.hideLoading();

          var container = document.getElementById('app-main');
          if (!container) {
            console.error('âŒ app-main ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }

          container.innerHTML = html;

          // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
          OB.state.currentPage = page;
          
          // ìƒˆë¡œ ë¡œë“œí•œ í˜ì´ì§€ëŠ” ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
          OB.state.initializedPages[page] = false;

          // ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
          OB.highlightActiveNav(page);

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
          setTimeout(function() {
            OB.initCurrentPage(page);
          }, 50);
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        })
        .getPageContent(page);
    }
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì•¡í‹°ë¸Œ í‘œì‹œ =====
  OB.highlightActiveNav = function(page) {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      var navPage = link.getAttribute('data-nav-page');
      if (navPage === page) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • =====
  function setupNavLinks() {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var page = link.getAttribute('data-nav-page');
        if (page) OB.api.loadPage(page);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded - ì´ˆê¸° í˜ì´ì§€:', OB.state.currentPage);

    setupNavLinks();
    OB.highlightActiveNav(OB.state.currentPage);
    OB.initCurrentPage(OB.state.currentPage);
  });

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  OB.formatNumber = function(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  };

  OB.formatDate = function(date) {
    if (!date) return '';
    if (typeof date === 'string') return date;
    
    var d = new Date(date);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    
    return year + '-' + month + '-' + day;
  };

  // ===========================================================
  // âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  // âš ï¸ ì£¼ì˜: Page_InvoiceOutput.htmlì— ë…ë¦½ì ì¸ êµ¬í˜„ì´ ìˆìŠµë‹ˆë‹¤.
  // ì´ í•¨ìˆ˜ëŠ” ì´ì „ ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
  OB.invoiceOutputState = { modesByOrder: {} };

  OB.initInvoiceOutputPage = function() {
    console.log('âœ… initInvoiceOutputPage (ë ˆê±°ì‹œ) - Page_InvoiceOutput.htmlì—ì„œ ë…ë¦½ ì‹¤í–‰ë¨');
  };

</script>

<!-- ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="ob-loading-overlay" class="ob-loading-overlay">
  <div class="ob-loading-box">
    <div class="ob-spinner"></div>
    <div id="ob-loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>