<script>
  // ===== ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ =====
  window.OB = window.OB || {};
  
  // ===== í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì´ˆê¸° ì„¤ì • =====
  (function() {
    var urlParams = new URLSearchParams(window.location.search);
    var pageFromUrl = urlParams.get('page') || 'orderFile';
    
    OB.state = {
      currentPage: pageFromUrl,
      isLoading: false,
      initializedPages: {}
    };
  })();

  // ===== ê³µí†µ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ =====
  OB.initCurrentPage = function(page) {
    console.log('ğŸ”§ initCurrentPage í˜¸ì¶œ:', page);
    
    if (OB.state.initializedPages[page]) {
      console.log('â­ï¸  ì´ë¯¸ ì´ˆê¸°í™”ë¨:', page);
      return;
    }

    var initFuncName = null;

    switch(page) {
      case 'orderFile':
        initFuncName = 'initOrderFilePage';
        break;
      case 'dashboard':
        initFuncName = 'initDashboardPage';
        break;
      case 'orderList':
        initFuncName = 'initOrderListPage';
        break;
      case 'invoiceOutput':
        initFuncName = 'initInvoiceOutputPage';
        break;
      case 'settings':
        initFuncName = 'initSettingsPage';
        break;
    }

    if (initFuncName && typeof OB[initFuncName] === 'function') {
      console.log('âœ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰:', initFuncName);
      
      try {
        OB[initFuncName]();
        OB.state.initializedPages[page] = true;
        console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ:', page);
      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', page, err);
      }
    } else {
      console.warn('âš ï¸  ì´ˆê¸°í™” í•¨ìˆ˜ ì—†ìŒ:', page, initFuncName);
    }
  };

  // ===== ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  OB.showLoading = function (message) {
    var overlay = document.getElementById('ob-loading-overlay');
    var textEl = document.getElementById('ob-loading-text');
    if (!overlay || !textEl) return;
    textEl.textContent = message || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.';
    overlay.classList.add('show');
    OB.state.isLoading = true;
  };

  OB.hideLoading = function () {
    var overlay = document.getElementById('ob-loading-overlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    OB.state.isLoading = false;
  };

  // ===== API ë˜í¼ =====
  OB.api = {
    ping: function () {
      OB.showLoading('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘.');
      google.script.run
        .withSuccessHandler(function (res) {
          OB.hideLoading();
          console.log('ping result:', res);
          alert('ì„œë²„ ì—°ê²° ì™„ë£Œ: ' + (res && res.status));
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error(err);
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        })
        .ping();
    },

    loadPage: function (page) {
      OB.showLoading('í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘:', page);

      google.script.run
        .withSuccessHandler(function (html) {
          OB.hideLoading();

          var container = document.getElementById('app-main');
          if (!container) {
            console.error('âŒ app-main ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
          }

          container.innerHTML = html;

          // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
          OB.state.currentPage = page;
          
          // ìƒˆë¡œ ë¡œë“œí•œ í˜ì´ì§€ëŠ” ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
          OB.state.initializedPages[page] = false;

          // ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
          OB.highlightActiveNav(page);

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
          setTimeout(function() {
            OB.initCurrentPage(page);
          }, 50);
        })
        .withFailureHandler(function (err) {
          OB.hideLoading();
          console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        })
        .getPageContent(page);
    }
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì•¡í‹°ë¸Œ í‘œì‹œ =====
  OB.highlightActiveNav = function(page) {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      var navPage = link.getAttribute('data-nav-page');
      if (navPage === page) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  };

  // ===== ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • =====
  function setupNavLinks() {
    var links = document.querySelectorAll('.ob-nav-link');
    links.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var page = link.getAttribute('data-nav-page');
        if (page) OB.api.loadPage(page);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded - ì´ˆê¸° í˜ì´ì§€:', OB.state.currentPage);

    setupNavLinks();
    OB.highlightActiveNav(OB.state.currentPage);
    OB.initCurrentPage(OB.state.currentPage);
  });

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  OB.formatNumber = function(num) {
    if (num === null || num === undefined || num === '') return '0';
    return Number(num).toLocaleString('ko-KR');
  };

  OB.formatDate = function(date) {
    if (!date) return '';
    if (typeof date === 'string') return date;
    
    var d = new Date(date);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    
    return year + '-' + month + '-' + day;
  };

  // ===========================================================
  // âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.invoiceOutputState = {
    allOrders: [],
    filteredOrders: [],
    currentPage: 1,
    itemsPerPage: 20,
    currentSort: {
      column: 'orderDate',
      direction: 'desc'
    },
    modesByOrder: {}
  };

  OB.initInvoiceOutputPage = function() {
    console.log('ğŸ”§ InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    var state = OB.invoiceOutputState;

    // ========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ========================================
    function formatDateInput(d) {
      if (!d) return '';
      if (!(d instanceof Date)) d = new Date(d);
      if (isNaN(d.getTime())) return '';
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return year + month + day;
    }

    function renderEmpty() {
      var tbody = document.getElementById("inv-result-tbody");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777;padding:40px;">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
      document.getElementById('inv-pagination').style.display = 'none';
      document.getElementById('inv-bulk-select').style.display = 'none';
    }

    // ========================================
    // 1. Excel ë‹¤ìš´ë¡œë“œ
    // ========================================
    function downloadExcel() {
      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      state.filteredOrders.forEach(function(order) {
        var row = [
          OB.formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ì¶œë ¥ëª©ë¡_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // 2. ì •ë ¬ ê¸°ëŠ¥
    // ========================================
    function sortOrders(column, direction) {
      state.filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      var headers = document.querySelectorAll('.ob-table-wrap th.sortable');
      headers.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === state.currentSort.column) {
          header.classList.add(state.currentSort.direction);
        }
      });
    }

    // ========================================
    // 3. í˜ì´ì§€ë„¤ì´ì…˜
    // ========================================
    function renderPagination(totalPages) {
      var paginationContainer = document.getElementById('inv-pagination');
      var pageInfo = document.getElementById('inv-page-info');
      var pageNumbers = document.getElementById('inv-page-numbers');
      var btnFirst = document.getElementById('inv-page-first');
      var btnPrev = document.getElementById('inv-page-prev');
      var btnNext = document.getElementById('inv-page-next');
      var btnLast = document.getElementById('inv-page-last');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = state.currentPage === 1;
      btnPrev.disabled = state.currentPage === 1;
      btnNext.disabled = state.currentPage === totalPages;
      btnLast.disabled = state.currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, state.currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === state.currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          state.currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (state.currentPage - 1) * state.itemsPerPage + 1;
      var endIdx = Math.min(state.currentPage * state.itemsPerPage, state.filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + state.filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { state.currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (state.currentPage > 1) { state.currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (state.currentPage < totalPages) { state.currentPage++; renderOrders(); } };
      btnLast.onclick = function() { state.currentPage = totalPages; renderOrders(); };
    }

    // ========================================
    // 4. ë¸Œëœë“œ/ë§¤ì…ì²˜ë³„ ì¼ê´„ ì„ íƒ
    // ========================================
    function renderBulkSelectButtons() {
      var bulkSelectContainer = document.getElementById('inv-bulk-select');
      var brandBtnsContainer = document.getElementById('inv-brand-btns');
      var supplierBtnsContainer = document.getElementById('inv-supplier-btns');

      if (state.filteredOrders.length === 0) {
        bulkSelectContainer.style.display = 'none';
        return;
      }

      bulkSelectContainer.style.display = 'flex';

      // ë¸Œëœë“œ ëª©ë¡ ì¶”ì¶œ
      var brands = {};
      var suppliers = {};
      state.filteredOrders.forEach(function(order) {
        if (order.brand) brands[order.brand] = true;
        if (order.supplier) suppliers[order.supplier] = true;
      });

      var brandList = Object.keys(brands).sort();
      var supplierList = Object.keys(suppliers).sort();

      // ë¸Œëœë“œ ë²„íŠ¼ ìƒì„±
      brandBtnsContainer.innerHTML = '';
      brandList.forEach(function(brand) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = brand;
        btn.addEventListener('click', function() {
          selectByBrand(brand);
        });
        brandBtnsContainer.appendChild(btn);
      });

      // ë§¤ì…ì²˜ ë²„íŠ¼ ìƒì„±
      supplierBtnsContainer.innerHTML = '';
      supplierList.forEach(function(supplier) {
        var btn = document.createElement('button');
        btn.className = 'bulk-select-btn';
        btn.textContent = supplier;
        btn.addEventListener('click', function() {
          selectBySupplier(supplier);
        });
        supplierBtnsContainer.appendChild(btn);
      });
    }

    function selectByBrand(brand) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.brand === brand) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    function selectBySupplier(supplier) {
      var checkboxes = document.querySelectorAll('.inv-row-check');
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);

      for (var i = startIdx; i < endIdx; i++) {
        var order = state.filteredOrders[i];
        if (order.supplier === supplier) {
          var checkbox = checkboxes[i - startIdx];
          if (checkbox) checkbox.checked = true;
        }
      }
    }

    // ========================================
    // í…Œì´ë¸” ë Œë”ë§
    // ========================================
    function renderOrders() {
      var tbody = document.getElementById('inv-result-tbody');

      if (!state.filteredOrders || state.filteredOrders.length === 0) {
        renderEmpty();
        return;
      }

      // ì •ë ¬
      sortOrders(state.currentSort.column, state.currentSort.direction);
      updateSortIndicators();

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(state.filteredOrders.length / state.itemsPerPage);
      var startIdx = (state.currentPage - 1) * state.itemsPerPage;
      var endIdx = Math.min(startIdx + state.itemsPerPage, state.filteredOrders.length);
      var pageOrders = state.filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = '';
      pageOrders.forEach(function(o) {
        var mode = state.modesByOrder[o.orderCode] || document.getElementById('inv-default-mode').value || 'auto';
        var dateStr = OB.formatDate(o.orderDate);

        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td><input type="checkbox" class="inv-row-check" data-oc="' + o.orderCode + '"></td>' +
          '<td>' + dateStr + '</td>' +
          '<td>' + (o.orderCode || '') + '</td>' +
          '<td>' + (o.brand || '') + '</td>' +
          '<td>' + (o.supplier || '') + '</td>' +
          '<td>' + (o.buyer || '') + '</td>' +
          '<td class="num">' + (o.itemCount || 0) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalPurchaseAmount) + '</td>' +
          '<td class="num">' + OB.formatNumber(o.totalAmount) + '</td>' +
          '<td>' +
            '<select class="inv-mode" data-oc="' + o.orderCode + '">' +
              '<option value="auto"' + (mode === 'auto' ? ' selected' : '') + '>ìë™</option>' +
              '<option value="full"' + (mode === 'full' ? ' selected' : '') + '>ì „ì²´</option>' +
              '<option value="short"' + (mode === 'short' ? ' selected' : '') + '>ë‹¨ì¶•</option>' +
            '</select>' +
          '</td>';

        tbody.appendChild(tr);
      });

      // ì¶œë ¥ë°©ì‹ ë³€ê²½ ì´ë²¤íŠ¸
      document.querySelectorAll('.inv-mode').forEach(function(sel) {
        sel.addEventListener('change', function() {
          state.modesByOrder[this.dataset.oc] = this.value;
        });
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPagination(totalPages);

      // ì¼ê´„ ì„ íƒ ë²„íŠ¼ ë Œë”ë§
      renderBulkSelectButtons();

      console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ: ' + pageOrders.length + '/' + state.filteredOrders.length + 'ê±´');
    }

    // ========================================
    // ì¡°íšŒ ê¸°ëŠ¥
    // ========================================
    function searchOrders() {
      console.log('ğŸ” ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨');

      var params = {
        orderCode: document.getElementById("inv-order-code").value,
        supplier: document.getElementById("inv-supplier").value,
        startDate: document.getElementById("inv-start-date").value,
        endDate: document.getElementById("inv-end-date").value
      };

      console.log('ğŸ“‹ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

      OB.showLoading('ë°œì£¼ ëª©ë¡ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(res) {
          console.log('âœ… ì„œë²„ ì‘ë‹µ:', res);

          OB.hideLoading();

          if (!res) {
            alert("ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
            renderEmpty();
            return;
          }

          if (!res.success) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            renderEmpty();
            return;
          }

          if (!res.orders || res.orders.length === 0) {
            renderEmpty();
            return;
          }

          // ë°ì´í„° ì €ì¥
          state.allOrders = res.orders;
          state.filteredOrders = res.orders.slice();
          state.currentPage = 1;

          // ë Œë”ë§
          renderOrders();

          console.log('âœ… ì¡°íšŒ ì™„ë£Œ: ' + res.orders.length + 'ê±´');
        })
        .withFailureHandler(function(err) {
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', err);
          OB.hideLoading();
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + (err.message || err));
          renderEmpty();
        })
        .getPrintableOrdersApi(params);
    }

    // ========================================
    // PDF ì¶œë ¥ ê¸°ëŠ¥
    // ========================================
    function exportPDF() {
      console.log('ğŸ“„ PDF ì¶œë ¥ ë²„íŠ¼ í´ë¦­');

      // ì²´í¬ëœ ë°œì£¼ë²ˆí˜¸ ìˆ˜ì§‘
      var selected = [];
      document.querySelectorAll(".inv-row-check:checked").forEach(function(c) {
        selected.push(c.dataset.oc);
      });

      if (selected.length === 0) {
        alert("ì¶œë ¥í•  ë°œì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
      var docTypeName = document.getElementById("inv-doc-type").value;
      var docTypeMap = {
        "ê±°ë˜ëª…ì„¸ì„œ(ë¶€í¬)": "INVOICE_VAT",
        "ê±°ë˜ëª…ì„¸ì„œ(ì˜ì„¸)": "INVOICE_NVAT",
        "ê±°ë˜ëª…ì„¸ì„œ(í•´ì™¸)": "INVOICE_EN",
        "ë°œì£¼ì„œ(ë§¤ì…)": "ORDER_BASIC",
        "ë°œì£¼ì„œ(ë§¤ì…)_ë¡¬ì•¤": "ORDER_ROMAND",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì¢…ê·¼ë‹¹": "ORDER_JONGGEUN",
        "ë°œì£¼ì„œ(ë§¤ì…)_ì‚ì•„ê³„ì—´": "ORDER_BBIA"
      };
      var docType = docTypeMap[docTypeName] || "INVOICE_VAT";

      // ì¶œë ¥ë°©ì‹ ìˆ˜ì§‘
      var modes = {};
      document.querySelectorAll(".inv-mode").forEach(function(sel) {
        modes[sel.dataset.oc] = sel.value || "auto";
      });

      // ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ì²´í¬ ì—¬ë¶€
      var mergeBySupplier = document.getElementById("inv-merge-by-supplier").checked;

      var params = {
        orderCodes: selected,
        docType: docType,
        printMode: "auto",
        modesByOrder: modes,
        mergeBySupplier: mergeBySupplier
      };

      console.log('ğŸ“„ PDF ìƒì„± íŒŒë¼ë¯¸í„°:', params);
      if (mergeBySupplier) {
        console.log('ğŸ”— ë§¤ì…ì²˜ë³„ í†µí•© ì¶œë ¥ ëª¨ë“œ í™œì„±í™”');
      }

      OB.showLoading('PDF ìƒì„± ì¤‘... (' + selected.length + 'ê±´)');

      google.script.run
        .withSuccessHandler(function(res) {
          OB.hideLoading();

          if (!res || !res.success) {
            alert(res ? res.error : "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          // ZIP ë‹¤ìš´ë¡œë“œ URL ì˜¤í”ˆ
          var url = "https://drive.google.com/uc?export=download&id=" + res.fileId;
          window.open(url, "_blank");

          alert('âœ… PDF ìƒì„± ì™„ë£Œ!\níŒŒì¼: ' + res.fileName);
        })
        .withFailureHandler(function(err) {
          OB.hideLoading();
          console.error('âŒ PDF ìƒì„± ì‹¤íŒ¨:', err);
          alert("PDF ìƒì„± ì‹¤íŒ¨: " + (err.message || err));
        })
        .generateInvoiceZipApi(params);
    }

    // ========================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ========================================

    // ì¡°íšŒ ë²„íŠ¼
    var searchBtn = document.getElementById('inv-search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', searchOrders);
    }

    // Excel ì¶œë ¥ ë²„íŠ¼
    var excelBtn = document.getElementById('inv-export-xlsx');
    if (excelBtn) {
      excelBtn.addEventListener('click', downloadExcel);
    }

    // PDF ì¶œë ¥ ë²„íŠ¼
    var pdfBtn = document.getElementById('inv-export-pdf');
    if (pdfBtn) {
      pdfBtn.addEventListener('click', exportPDF);
    }

    // ì „ì²´ ì²´í¬ë°•ìŠ¤
    var checkAll = document.getElementById("inv-check-all");
    if (checkAll) {
      checkAll.addEventListener("change", function(e) {
        var checkboxes = document.querySelectorAll(".inv-row-check");
        checkboxes.forEach(function(c) {
          c.checked = e.target.checked;
        });
      });
    }

    // ì •ë ¬ í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    var sortableHeaders = document.querySelectorAll('.ob-table-wrap th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (state.currentSort.column === column) {
          state.currentSort.direction = state.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          state.currentSort.column = column;
          state.currentSort.direction = 'asc';
        }

        state.currentPage = 1;
        renderOrders();
      });
    });

    // ì¼ê´„ ì„ íƒ ë²„íŠ¼
    var selectAllBtn = document.getElementById('inv-select-all');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = true;
        });
      });
    }

    var deselectAllBtn = document.getElementById('inv-deselect-all');
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.inv-row-check');
        checkboxes.forEach(function(c) {
          c.checked = false;
        });
        document.getElementById('inv-check-all').checked = false;
      });
    }

    console.log('âœ… InvoiceOutput í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  // ===========================================================
  // âœ… OrderList í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  // ===========================================================
  OB.initOrderListPage = function() {
    var wrap = document.querySelector('.orderlist-wrap');
    if (!wrap) {
      console.warn('OrderList wrapper not found');
      return;
    }

    if (wrap.dataset.bound === '1') {
      console.log('OrderList already initialized');
      return;
    }
    wrap.dataset.bound = '1';

    console.log('âœ… OrderList Page ì´ˆê¸°í™” ì™„ë£Œ');

    // DOM ìš”ì†Œ
    var btnSearch = document.getElementById('orderlist-btn-search');
    var btnReset = document.getElementById('orderlist-btn-reset');
    var btnExcel = document.getElementById('orderlist-btn-excel');
    var tbody = document.getElementById('orderlist-tbody');
    var resultCount = document.getElementById('orderlist-result-count');
    var pagination = document.getElementById('orderlist-pagination');
    var pageNumbers = document.getElementById('orderlist-page-numbers');
    var pageInfo = document.getElementById('orderlist-page-info');

    var modal = document.getElementById('orderlist-modal');
    var modalClose = document.getElementById('orderlist-modal-close');
    var modalTitle = document.getElementById('orderlist-modal-title');
    var modalBody = document.getElementById('orderlist-modal-body');
    var btnDelete = document.getElementById('orderlist-btn-delete');
    var btnSaveStatus = document.getElementById('orderlist-btn-save-status');

    // ìƒíƒœ ë³€ìˆ˜
    var currentOrders = [];
    var filteredOrders = [];
    var currentPage = 1;
    var itemsPerPage = 20;
    var currentSort = { column: null, direction: 'asc' };
    var currentOrderCode = null;

    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
    setDefaultDates();

    function setDefaultDates() {
      var today = new Date();
      var thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);

      document.getElementById('orderlist-end-date').value = formatDateInput(today);
      document.getElementById('orderlist-start-date').value = formatDateInput(thirtyDaysAgo);
    }

    function formatDateInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // ============================================================
    // ì¡°íšŒ ë²„íŠ¼
    // ============================================================
    if (btnSearch) {
      btnSearch.addEventListener('click', function() {
        var params = {
          startDate: document.getElementById('orderlist-start-date').value,
          endDate: document.getElementById('orderlist-end-date').value,
          orderCode: document.getElementById('orderlist-order-code').value,
          buyer: document.getElementById('orderlist-buyer').value,
          brand: document.getElementById('orderlist-brand').value,
          supplier: document.getElementById('orderlist-supplier').value
        };

        console.log('ğŸ” ë°œì£¼ ì¡°íšŒ íŒŒë¼ë¯¸í„°:', params);

        OB.showLoading('ë°œì£¼ ë‚´ì—­ ì¡°íšŒ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();
            console.log('âœ… ë°œì£¼ ì¡°íšŒ ê²°ê³¼:', result);

            if (!result || !result.success) {
              alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              renderEmpty();
              return;
            }

            currentOrders = result.orders || [];
            filteredOrders = currentOrders.slice();
            currentPage = 1;
            renderOrders();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            renderEmpty();
          })
          .getPrintableOrdersApi(params);
      });
    }

    // ============================================================
    // ì´ˆê¸°í™” ë²„íŠ¼
    // ============================================================
    if (btnReset) {
      btnReset.addEventListener('click', function() {
        document.getElementById('orderlist-start-date').value = '';
        document.getElementById('orderlist-end-date').value = '';
        document.getElementById('orderlist-order-code').value = '';
        document.getElementById('orderlist-buyer').value = '';
        document.getElementById('orderlist-brand').value = '';
        document.getElementById('orderlist-supplier').value = '';

        setDefaultDates();
        renderEmpty();
      });
    }

    // ============================================================
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    // ============================================================
    if (btnExcel) {
      btnExcel.addEventListener('click', function() {
        if (!filteredOrders || filteredOrders.length === 0) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        downloadCSV();
      });
    }

    function downloadCSV() {
      var csv = [];

      // í—¤ë”
      csv.push(['ë°œì£¼ì¼', 'ë°œì£¼ë²ˆí˜¸', 'ë°œì£¼ì²˜', 'ë¸Œëœë“œ', 'ë§¤ì…ì²˜', 'í’ˆëª©ìˆ˜', 'ë§¤ì…ì•¡', 'ê³µê¸‰ì•¡'].join(','));

      // ë°ì´í„°
      filteredOrders.forEach(function(order) {
        var row = [
          formatDate(order.orderDate),
          order.orderCode || '',
          order.buyer || '',
          order.brand || '',
          order.supplier || '',
          order.itemCount || 0,
          order.totalPurchaseAmount || 0,
          order.totalAmount || 0
        ];
        csv.push(row.join(','));
      });

      // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      var csvContent = '\uFEFF' + csv.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'ë°œì£¼ë‚´ì—­_' + formatDateInput(new Date()) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filteredOrders.length + 'ê±´');
    }

    // ============================================================
    // ì •ë ¬ ê¸°ëŠ¥
    // ============================================================
    var sortableHeaders = document.querySelectorAll('.orderlist-table th.sortable');
    sortableHeaders.forEach(function(header) {
      header.addEventListener('click', function() {
        var column = header.dataset.sort;

        if (currentSort.column === column) {
          // ê°™ì€ ì»¬ëŸ¼ í´ë¦­: ë°©í–¥ í† ê¸€
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          // ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­: ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        sortOrders(column, currentSort.direction);
        updateSortIndicators();
        currentPage = 1;
        renderOrders();
      });
    });

    function sortOrders(column, direction) {
      filteredOrders.sort(function(a, b) {
        var aVal = a[column];
        var bVal = b[column];

        // ë‚ ì§œ ì²˜ë¦¬
        if (column === 'orderDate') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        }

        // ìˆ«ì ì²˜ë¦¬
        if (column === 'itemCount' || column === 'totalPurchaseAmount' || column === 'totalAmount') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        // ë¬¸ìì—´ ì²˜ë¦¬
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators() {
      sortableHeaders.forEach(function(header) {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sort === currentSort.column) {
          header.classList.add(currentSort.direction);
        }
      });
    }

    // ============================================================
    // ë°œì£¼ ëª©ë¡ ë Œë”ë§ (í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨)
    // ============================================================
    function renderOrders() {
      tbody.innerHTML = '';

      if (!filteredOrders || filteredOrders.length === 0) {
        renderEmpty();
        pagination.style.display = 'none';
        return;
      }

      resultCount.textContent = 'ì´ ' + filteredOrders.length + 'ê±´';

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
      var startIdx = (currentPage - 1) * itemsPerPage;
      var endIdx = Math.min(startIdx + itemsPerPage, filteredOrders.length);
      var pageOrders = filteredOrders.slice(startIdx, endIdx);

      // í…Œì´ë¸” ë Œë”ë§
      pageOrders.forEach(function(order) {
        var tr = document.createElement('tr');
        tr.dataset.orderCode = order.orderCode;

        tr.innerHTML =
          '<td>' + formatDate(order.orderDate) + '</td>' +
          '<td><span class="orderlist-ordercode">' + (order.orderCode || '') + '</span></td>' +
          '<td>' + (order.buyer || '') + '</td>' +
          '<td>' + (order.brand || '') + '</td>' +
          '<td>' + (order.supplier || '') + '</td>' +
          '<td class="text-center">' + (order.itemCount || 0) + 'ê°œ</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalPurchaseAmount) + '</td>' +
          '<td class="text-right">â‚©' + formatNumber(order.totalAmount) + '</td>';

        tr.addEventListener('click', function() {
          loadOrderDetail(order.orderCode);
        });

        tbody.appendChild(tr);
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      if (totalPages > 1) {
        renderPagination(totalPages);
        pagination.style.display = 'flex';
      } else {
        pagination.style.display = 'none';
      }
    }

    // ============================================================
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    // ============================================================
    function renderPagination(totalPages) {
      var btnFirst = document.getElementById('orderlist-page-first');
      var btnPrev = document.getElementById('orderlist-page-prev');
      var btnNext = document.getElementById('orderlist-page-next');
      var btnLast = document.getElementById('orderlist-page-last');

      // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      btnFirst.disabled = currentPage === 1;
      btnPrev.disabled = currentPage === 1;
      btnNext.disabled = currentPage === totalPages;
      btnLast.disabled = currentPage === totalPages;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      pageNumbers.innerHTML = '';

      var maxButtons = 5;
      var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (var i = startPage; i <= endPage; i++) {
        var btn = document.createElement('button');
        btn.className = 'orderlist-page-btn';
        btn.textContent = i;
        btn.dataset.page = i;

        if (i === currentPage) {
          btn.classList.add('active');
        }

        btn.addEventListener('click', function() {
          currentPage = parseInt(this.dataset.page);
          renderOrders();
        });

        pageNumbers.appendChild(btn);
      }

      // í˜ì´ì§€ ì •ë³´
      var startIdx = (currentPage - 1) * itemsPerPage + 1;
      var endIdx = Math.min(currentPage * itemsPerPage, filteredOrders.length);
      pageInfo.textContent = startIdx + '-' + endIdx + ' / ' + filteredOrders.length;

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      btnFirst.onclick = function() { currentPage = 1; renderOrders(); };
      btnPrev.onclick = function() { if (currentPage > 1) { currentPage--; renderOrders(); } };
      btnNext.onclick = function() { if (currentPage < totalPages) { currentPage++; renderOrders(); } };
      btnLast.onclick = function() { currentPage = totalPages; renderOrders(); };
    }

    // ============================================================
    // ë¹ˆ í…Œì´ë¸” ë Œë”ë§
    // ============================================================
    function renderEmpty() {
      tbody.innerHTML =
        '<tr><td colspan="8" class="orderlist-empty">' +
        '<div class="orderlist-empty-icon">ğŸ“‹</div>' +
        '<div class="orderlist-empty-text">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' +
        '</td></tr>';

      resultCount.textContent = 'ì¡°íšŒ ê²°ê³¼ ì—†ìŒ';
      currentOrders = [];
      filteredOrders = [];
      pagination.style.display = 'none';
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ì¡°íšŒ
    // ============================================================
    function loadOrderDetail(orderCode) {
      console.log('ğŸ“¦ ë°œì£¼ ìƒì„¸ ì¡°íšŒ:', orderCode);
      currentOrderCode = orderCode;

      OB.showLoading('ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          OB.hideLoading();
          console.log('âœ… ë°œì£¼ ìƒì„¸ ê²°ê³¼:', result);

          if (!result || !result.success) {
            alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          renderOrderDetail(orderCode, result.orderItems || []);
        })
        .withFailureHandler(function(error) {
          OB.hideLoading();
          console.error('âŒ ë°œì£¼ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
        })
        .getOrderDetail(orderCode);
    }

    // ============================================================
    // ë°œì£¼ ìƒì„¸ ëª¨ë‹¬ ë Œë”ë§
    // ============================================================
    function renderOrderDetail(orderCode, items) {
      if (!items || items.length === 0) {
        alert('í•´ë‹¹ ë°œì£¼ì˜ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var firstItem = items[0];

      modalTitle.textContent = 'ë°œì£¼ ìƒì„¸ - ' + orderCode;

      var html = '';

      // ê¸°ë³¸ ì •ë³´
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ê¸°ë³¸ ì •ë³´</div>';
      html += '<div class="orderlist-detail-grid">';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ë²ˆí˜¸</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ë²ˆí˜¸'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì¼</div><div class="orderlist-detail-value">' + formatDate(firstItem['ë°œì£¼ì¼']) + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë°œì£¼ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë°œì£¼ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë¸Œëœë“œ</div><div class="orderlist-detail-value">' + (firstItem['ë¸Œëœë“œ'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ë§¤ì…ì²˜</div><div class="orderlist-detail-value">' + (firstItem['ë§¤ì…ì²˜'] || '') + '</div></div>';
      html += '<div class="orderlist-detail-item"><div class="orderlist-detail-label">ì¶œê³ ìƒíƒœ</div><div class="orderlist-detail-value">' + (firstItem['ì¶œê³ '] || 'ë¯¸ì¶œê³ ') + '</div></div>';
      html += '</div>';
      html += '</div>';

      // ìƒíƒœ ìˆ˜ì • í¼
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">ìƒíƒœ ê´€ë¦¬</div>';
      html += '<div class="orderlist-status-form">';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ì¶œê³  ìƒíƒœ</label>';
      html += '<select id="orderlist-status-ship" class="orderlist-status-select">';
      html += '<option value="ë¯¸ì¶œê³ "' + (firstItem['ì¶œê³ '] === 'ë¯¸ì¶œê³ ' ? ' selected' : '') + '>ë¯¸ì¶œê³ </option>';
      html += '<option value="ì¶œê³ ì™„ë£Œ"' + (firstItem['ì¶œê³ '] === 'ì¶œê³ ì™„ë£Œ' ? ' selected' : '') + '>ì¶œê³ ì™„ë£Œ</option>';
      html += '<option value="ë¶€ë¶„ì¶œê³ "' + (firstItem['ì¶œê³ '] === 'ë¶€ë¶„ì¶œê³ ' ? ' selected' : '') + '>ë¶€ë¶„ì¶œê³ </option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì… ê²°ì œ</label>';
      html += '<select id="orderlist-status-pay-buy" class="orderlist-status-select">';
      html += '<option value="ë¯¸ê²°ì œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ë¯¸ê²°ì œ' ? ' selected' : '') + '>ë¯¸ê²°ì œ</option>';
      html += '<option value="ê²°ì œì™„ë£Œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ê²°ì œì™„ë£Œ' ? ' selected' : '') + '>ê²°ì œì™„ë£Œ</option>';
      html += '<option value="ë¶€ë¶„ê²°ì œ"' + (firstItem['ë§¤ì…ê²°ì œ'] === 'ë¶€ë¶„ê²°ì œ' ? ' selected' : '') + '>ë¶€ë¶„ê²°ì œ</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì¶œ ê²°ì œ</label>';
      html += '<select id="orderlist-status-pay-sell" class="orderlist-status-select">';
      html += '<option value="ë¯¸ê²°ì œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ë¯¸ê²°ì œ' ? ' selected' : '') + '>ë¯¸ê²°ì œ</option>';
      html += '<option value="ê²°ì œì™„ë£Œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ê²°ì œì™„ë£Œ' ? ' selected' : '') + '>ê²°ì œì™„ë£Œ</option>';
      html += '<option value="ë¶€ë¶„ê²°ì œ"' + (firstItem['ë§¤ì¶œê²°ì œ'] === 'ë¶€ë¶„ê²°ì œ' ? ' selected' : '') + '>ë¶€ë¶„ê²°ì œ</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="orderlist-status-item">';
      html += '<label class="orderlist-detail-label">ë§¤ì… ë°œì£¼</label>';
      html += '<select id="orderlist-status-buy-order" class="orderlist-status-select">';
      html += '<option value="ë¯¸ì²˜ë¦¬"' + (firstItem['ë§¤ì…ë°œì£¼'] === 'ë¯¸ì²˜ë¦¬' ? ' selected' : '') + '>ë¯¸ì²˜ë¦¬</option>';
      html += '<option value="ë°œì£¼ì™„ë£Œ"' + (firstItem['ë§¤ì…ë°œì£¼'] === 'ë°œì£¼ì™„ë£Œ' ? ' selected' : '') + '>ë°œì£¼ì™„ë£Œ</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // í’ˆëª© ëª©ë¡
      html += '<div class="orderlist-detail-section">';
      html += '<div class="orderlist-detail-section-title">í’ˆëª© ëª©ë¡ (' + items.length + 'ê°œ)</div>';
      html += '<table class="orderlist-detail-table">';
      html += '<thead><tr>';
      html += '<th>ì œí’ˆëª…</th>';
      html += '<th>í’ˆëª©ì½”ë“œ</th>';
      html += '<th class="text-right">ë°œì£¼ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">í™•ì •ìˆ˜ëŸ‰</th>';
      html += '<th class="text-right">ë§¤ì…ê°€</th>';
      html += '<th class="text-right">ê³µê¸‰ê°€</th>';
      html += '<th class="text-right">ë§¤ì…ì•¡</th>';
      html += '<th class="text-right">ê³µê¸‰ì•¡</th>';
      html += '</tr></thead>';
      html += '<tbody>';

      var totalPurchaseAmount = 0;
      var totalSupplyAmount = 0;

      items.forEach(function(item) {
        var purchaseAmount = Number(item['ë§¤ì…ì•¡'] || 0);
        var supplyAmount = Number(item['ê³µê¸‰ì•¡'] || 0);

        totalPurchaseAmount += purchaseAmount;
        totalSupplyAmount += supplyAmount;

        html += '<tr>';
        html += '<td>' + (item['ì œí’ˆëª…'] || '') + '</td>';
        html += '<td>' + (item['í’ˆëª©ì½”ë“œ'] || '') + '</td>';
        html += '<td class="text-right">' + formatNumber(item['ë°œì£¼ìˆ˜ëŸ‰']) + '</td>';
        html += '<td class="text-right">' + formatNumber(item['í™•ì •ìˆ˜ëŸ‰']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ë§¤ì…ê°€']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(item['ê³µê¸‰ê°€']) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(purchaseAmount) + '</td>';
        html += '<td class="text-right">â‚©' + formatNumber(supplyAmount) + '</td>';
        html += '</tr>';
      });

      html += '</tbody>';
      html += '<tfoot>';
      html += '<tr style="font-weight: 700; background: #f9fafb;">';
      html += '<td colspan="6" class="text-right">í•©ê³„</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalPurchaseAmount) + '</td>';
      html += '<td class="text-right">â‚©' + formatNumber(totalSupplyAmount) + '</td>';
      html += '</tr>';
      html += '</tfoot>';
      html += '</table>';
      html += '</div>';

      modalBody.innerHTML = html;
      modal.classList.add('show');
    }

    // ============================================================
    // ìƒíƒœ ì €ì¥
    // ============================================================
    if (btnSaveStatus) {
      btnSaveStatus.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìƒíƒœ ê°’ ìˆ˜ì§‘ (í•˜ì§€ë§Œ í˜„ì¬ ë°±ì—”ë“œ APIëŠ” ë‹¨ì¼ ìƒíƒœë§Œ ì§€ì›)
        var shipStatus = document.getElementById('orderlist-status-ship').value;

        if (!confirm('ì¶œê³  ìƒíƒœë¥¼ "' + shipStatus + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        OB.showLoading('ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.updated + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
          })
          .updateOrderStatus(currentOrderCode, shipStatus);
      });
    }

    // ============================================================
    // ë°œì£¼ ì‚­ì œ
    // ============================================================
    if (btnDelete) {
      btnDelete.addEventListener('click', function() {
        if (!currentOrderCode) {
          alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        if (!confirm('âš ï¸ ì •ë§ë¡œ ë°œì£¼ë²ˆí˜¸ "' + currentOrderCode + '"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
          return;
        }

        if (!confirm('âš ï¸âš ï¸ ìµœì¢… í™•ì¸: ë°œì£¼ì™€ ê´€ë ¨ëœ ëª¨ë“  í’ˆëª© ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        OB.showLoading('ë°œì£¼ ì‚­ì œ ì¤‘...');

        google.script.run
          .withSuccessHandler(function(result) {
            OB.hideLoading();

            if (!result || !result.success) {
              alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + (result ? result.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              return;
            }

            alert('âœ… ë°œì£¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! (' + result.deleted + 'ê°œ í–‰)');

            // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            modal.classList.remove('show');
            btnSearch.click();
          })
          .withFailureHandler(function(error) {
            OB.hideLoading();
            console.error('âŒ ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
          })
          .deleteOrder(currentOrderCode);
      });
    }

    // ============================================================
    // ëª¨ë‹¬ ë‹«ê¸°
    // ============================================================
    if (modalClose) {
      modalClose.addEventListener('click', function() {
        modal.classList.remove('show');
      });
    }

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // ============================================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================================
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    function formatDate(date) {
      if (!date) return '';
      if (typeof date === 'string') {
        if (date.match(/^\d{4}-\d{2}-\d{2}$/)) return date;
      }

      var d = new Date(date);
      if (isNaN(d.getTime())) return '';

      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');

      return year + '-' + month + '-' + day;
    }

    console.log('âœ… OrderList ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
  };

</script>

<!-- ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="ob-loading-overlay" class="ob-loading-overlay">
  <div class="ob-loading-box">
    <div class="ob-spinner"></div>
    <div id="ob-loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>